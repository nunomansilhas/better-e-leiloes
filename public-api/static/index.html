<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Leil√µes Dashboard</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="/static/utilities.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* ============ THEME VARIABLES ============ */
        :root {
            /* Light Theme (default) */
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --bg-hover: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --text-light: #94a3b8;
            --border-color: #e2e8f0;
            --border-light: #f1f5f9;
            --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            --card-shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.1);
            --sidebar-bg: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            --modal-backdrop: rgba(15, 23, 42, 0.6);
        }

        [data-theme="dark"] {
            /* Dark Theme */
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-hover: #475569;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --text-light: #64748b;
            --border-color: #334155;
            --border-light: #1e293b;
            --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            --card-shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.4);
            --sidebar-bg: linear-gradient(180deg, #0f172a 0%, #020617 100%);
            --modal-backdrop: rgba(0, 0, 0, 0.8);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            min-height: 100vh;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* ============ DARK MODE OVERRIDES ============ */
        [data-theme="dark"] .main-content {
            background: var(--bg-primary);
        }

        /* Cards with white background */
        [data-theme="dark"] [style*="background: white"],
        [data-theme="dark"] [style*="background:#ffffff"],
        [data-theme="dark"] [style*="background: #ffffff"],
        [data-theme="dark"] [style*="background:#fff"],
        [data-theme="dark"] [style*="background: #fff"] {
            background: var(--bg-secondary) !important;
        }

        /* Text colors */
        [data-theme="dark"] [style*="color: #1e293b"],
        [data-theme="dark"] [style*="color:#1e293b"],
        [data-theme="dark"] [style*="color: #0f172a"],
        [data-theme="dark"] [style*="color:#0f172a"] {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] [style*="color: #64748b"],
        [data-theme="dark"] [style*="color:#64748b"],
        [data-theme="dark"] [style*="color: #475569"],
        [data-theme="dark"] [style*="color:#475569"] {
            color: var(--text-muted) !important;
        }

        /* Background colors */
        [data-theme="dark"] [style*="background: #f8fafc"],
        [data-theme="dark"] [style*="background:#f8fafc"],
        [data-theme="dark"] [style*="background: #f1f5f9"],
        [data-theme="dark"] [style*="background:#f1f5f9"] {
            background: var(--bg-tertiary) !important;
        }

        /* Border colors */
        [data-theme="dark"] [style*="border: 1px solid #e2e8f0"],
        [data-theme="dark"] [style*="border:1px solid #e2e8f0"],
        [data-theme="dark"] [style*="border-color: #e2e8f0"],
        [data-theme="dark"] [style*="border: 1px solid #e5e7eb"] {
            border-color: var(--border-color) !important;
        }

        /* Stats cards */
        [data-theme="dark"] .stats-card,
        [data-theme="dark"] .stats-total-card {
            background: var(--bg-secondary) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .stats-card-value,
        [data-theme="dark"] .stats-total-value {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .stats-card-label,
        [data-theme="dark"] .stats-total-label {
            color: var(--text-muted) !important;
        }

        /* Page headers */
        [data-theme="dark"] .page-header h2 {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .page-header p {
            color: var(--text-muted) !important;
        }

        /* Inputs and selects */
        [data-theme="dark"] input,
        [data-theme="dark"] select,
        [data-theme="dark"] textarea {
            background: var(--bg-tertiary) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] input::placeholder {
            color: var(--text-light) !important;
        }

        /* Table headers */
        [data-theme="dark"] .table-header,
        [data-theme="dark"] [style*="background: #f8fafc"][style*="border-radius: 4px"] {
            background: var(--bg-tertiary) !important;
            color: var(--text-muted) !important;
        }

        /* Modal backdrops */
        [data-theme="dark"] [style*="background: rgba(15, 23, 42"] {
            background: var(--modal-backdrop) !important;
        }

        /* Modal content */
        [data-theme="dark"] [style*="background: white"][style*="border-radius: 20px"],
        [data-theme="dark"] [style*="background: white"][style*="border-radius: 16px"],
        [data-theme="dark"] [style*="background: white"][style*="border-radius: 12px"] {
            background: var(--bg-secondary) !important;
        }

        /* Buttons secondary */
        [data-theme="dark"] button[style*="background: #f1f5f9"],
        [data-theme="dark"] button[style*="background:#f1f5f9"],
        [data-theme="dark"] button[style*="background: #f8fafc"] {
            background: var(--bg-tertiary) !important;
            color: var(--text-secondary) !important;
        }

        /* Event cards / rows */
        [data-theme="dark"] .event-row,
        [data-theme="dark"] .table-row {
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .table-row:hover {
            background: var(--bg-tertiary) !important;
        }

        /* Pagination */
        [data-theme="dark"] .pagination button {
            background: var(--bg-tertiary) !important;
            color: var(--text-secondary) !important;
            border-color: var(--border-color) !important;
        }

        /* Sidebar */
        [data-theme="dark"] .sidebar {
            background: var(--sidebar-bg) !important;
        }

        /* Sidebar */
        .sidebar {
            width: 70px;
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            color: white;
            padding: 24px 0;
            position: fixed;
            height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
            box-shadow: 4px 0 12px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: width 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .sidebar:hover:not(.locked),
        .sidebar.locked {
            width: 260px;
        }

        .sidebar-lock {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 30px;
            height: 30px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-lock:hover {
            background: rgba(255,255,255,0.2);
        }

        .sidebar-lock svg {
            width: 16px;
            height: 16px;
        }

        .sidebar-header {
            padding: 0 0 16px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin: 0 16px;
        }

        .sidebar-header h1 {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 10px;
            white-space: nowrap;
            padding: 0 8px;
        }

        .sidebar:hover .sidebar-header h1,
        .sidebar.locked .sidebar-header h1 {
            justify-content: flex-start;
            padding: 0 8px;
        }

        .sidebar-header h1 svg {
            width: 22px !important;
            height: 22px !important;
            flex-shrink: 0;
        }

        .sidebar-header h1 span {
            opacity: 0;
            width: 0;
            overflow: hidden;
            transition: opacity 0.3s ease, width 0.3s ease;
        }

        .sidebar:hover .sidebar-header h1 span,
        .sidebar.locked .sidebar-header h1 span {
            opacity: 1;
            width: auto;
        }

        .sidebar-header p {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar:hover .sidebar-header p,
        .sidebar.locked .sidebar-header p {
            opacity: 1;
        }

        .sidebar-nav {
            margin-top: 24px;
            flex: 1;
        }

        .nav-section-label {
            padding: 4px 24px 4px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #64748b;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar:hover .nav-section-label,
        .sidebar.locked .nav-section-label {
            opacity: 1;
        }

        .nav-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 12px 16px;
        }

        .sidebar-bottom {
            margin-top: auto;
            padding-bottom: 16px;
        }

        /* ===== USER CARD - GLASSMORPHISM DESIGN ===== */
        .user-card {
            position: relative;
            padding: 10px;
            margin: 8px 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .sidebar:hover .user-card,
        .sidebar.locked .user-card {
            margin: 8px 12px;
            padding: 10px;
        }

        .user-card:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.25);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        }

        .sidebar:hover .user-card:hover,
        .sidebar.locked .user-card:hover {
            transform: translateY(-2px);
        }

        .user-card-header {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        .sidebar:hover .user-card-header,
        .sidebar.locked .user-card-header {
            justify-content: flex-start;
            gap: 10px;
        }

        .user-card-avatar {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.8) 0%, rgba(168, 85, 247, 0.8) 100%);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .user-card-info {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            opacity: 0;
            width: 0;
            transition: all 0.2s;
        }

        .sidebar:hover .user-card-info,
        .sidebar.locked .user-card-info {
            opacity: 1;
            width: auto;
        }

        .user-card-name {
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            color: #f1f5f9;
        }

        .user-card-email {
            font-size: 11px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #94a3b8;
        }

        .user-card-toggle {
            margin-left: auto;
            color: #64748b;
            transition: transform 0.2s, opacity 0.2s;
            opacity: 0;
            width: 0;
            overflow: hidden;
        }

        .sidebar:hover .user-card-toggle,
        .sidebar.locked .user-card-toggle {
            opacity: 1;
            width: auto;
        }

        .user-card.open .user-card-toggle {
            transform: rotate(180deg);
        }

        .user-card-dropdown {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease;
        }

        .user-card.open .user-card-dropdown {
            max-height: 100px;
        }

        .user-dropdown-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            margin-top: 4px;
            font-size: 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            color: #94a3b8;
        }

        .user-dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #f1f5f9;
        }

        .user-dropdown-item svg {
            width: 14px;
            height: 14px;
        }

        .user-dropdown-item.logout:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .nav-item {
            padding: 12px 24px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #cbd5e1;
            font-size: 14px;
            font-weight: 500;
            border-left: 3px solid transparent;
            white-space: nowrap;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.05);
            color: white;
        }

        .nav-item.active {
            background: rgba(99, 102, 241, 0.15);
            border-left-color: #6366f1;
            color: white;
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .nav-item span {
            opacity: 0;
            width: 0;
            overflow: hidden;
            transition: opacity 0.3s ease, width 0.3s ease;
        }

        .sidebar:hover .nav-item span,
        .sidebar.locked .nav-item span {
            opacity: 1;
            width: auto;
        }

        .nav-badge {
            background: #ef4444;
            color: white;
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: auto;
            min-width: 18px;
            text-align: center;
        }

        /* Notification Toggle Button */
        .notification-toggle-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
            font-weight: 500;
            color: #64748b;
        }

        .notification-toggle-btn:hover {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-color: #93c5fd;
            color: #3b82f6;
        }

        .notification-toggle-btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-color: #2563eb;
            color: white;
        }

        .notification-toggle-btn.active:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }

        /* Toast Notification - bottom-right, stacking upwards */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 10000;
            display: flex;
            flex-direction: column-reverse;
            gap: 8px;
        }

        .toast {
            background: white;
            border-radius: 8px;
            padding: 10px 14px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 240px;
            max-width: 320px;
            animation: slideInUp 0.3s ease;
            border-left: 3px solid #3b82f6;
        }

        .toast.success { border-left-color: #10b981; }
        .toast.error { border-left-color: #ef4444; }
        .toast.warning { border-left-color: #f59e0b; }

        .toast-icon { font-size: 16px; }
        .toast-content { flex: 1; min-width: 0; }
        .toast-title { font-weight: 600; font-size: 12px; color: #1e293b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .toast-message { font-size: 11px; color: #64748b; margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .toast-close {
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            padding: 2px;
            font-size: 14px;
            line-height: 1;
        }

        @keyframes slideInUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes starPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        /* Animation utility classes */
        .animate-fadeInUp {
            animation: fadeInUp 0.3s ease forwards;
        }

        .animate-fadeIn {
            animation: fadeIn 0.2s ease forwards;
        }

        .animate-scaleIn {
            animation: scaleIn 0.2s ease forwards;
        }

        /* Card hover effects */
        .card-hover {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Star favorite animation */
        .star-pop {
            animation: starPop 0.3s ease;
        }

        /* Loading skeleton shimmer */
        .skeleton {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }

        /* Row hover highlight */
        .ending-soon-row {
            transition: transform 0.15s ease, background 0.15s ease !important;
        }

        .ending-soon-row:hover {
            transform: translateX(2px);
        }

        .nav-dropdown {
            margin-top: 4px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .nav-item.dropdown-open + .nav-dropdown {
            max-height: 200px;
        }

        .nav-dropdown-item {
            padding: 10px 24px 10px 56px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #94a3b8;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
        }

        .nav-dropdown-item:hover {
            background: rgba(255,255,255,0.05);
            color: white;
        }

        .nav-dropdown-item.active {
            background: rgba(99, 102, 241, 0.1);
            color: #818cf8;
        }

        .nav-dropdown-item svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .nav-dropdown-item span {
            opacity: 0;
            width: 0;
            overflow: hidden;
            transition: opacity 0.3s ease, width 0.3s ease;
        }

        .sidebar:hover .nav-dropdown-item span,
        .sidebar.locked .nav-dropdown-item span {
            opacity: 1;
            width: auto;
        }

        /* Main Content */
        .main-content {
            margin-left: 70px;
            flex: 1;
            padding: 32px;
            width: calc(100% - 70px);
            transition: margin-left 0.3s ease, width 0.3s ease;
        }

        .sidebar:hover:not(.locked) ~ .main-content,
        .sidebar.locked ~ .main-content {
            margin-left: 260px;
            width: calc(100% - 260px);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .page-header {
            margin-bottom: 32px;
        }

        .page-header h2 {
            font-size: 28px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 8px;
        }

        .page-header p {
            color: #64748b;
            font-size: 14px;
        }

        /* Stats Container - Total on left, 2x3 grid on right */
        .stats-container {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }

        .stats-total-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 12px 16px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.5);
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 110px;
            transition: all 0.2s ease;
        }

        .stats-total-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }

        .stats-total-icon {
            font-size: 22px;
            margin-bottom: 4px;
        }

        .stats-total-value {
            font-size: 26px;
            font-weight: 700;
            color: #0f172a;
            line-height: 1.1;
        }

        .stats-total-label {
            font-size: 10px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            margin-top: 2px;
        }

        .stats-total-breakdown {
            display: flex;
            gap: 10px;
            font-size: 11px;
            color: #64748b;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #f1f5f9;
        }

        .stats-total-breakdown .lo {
            color: #f59e0b;
            font-weight: 600;
        }

        .stats-total-breakdown .np {
            color: #3b82f6;
            font-weight: 600;
        }

        /* Inactive indicator - subtle secondary row */
        .stats-inactive-row {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 6px;
            padding: 4px 8px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 6px;
            font-size: 10px;
            color: #64748b;
        }

        .stats-inactive-row .inactive-dot {
            width: 6px;
            height: 6px;
            background: #cbd5e1;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .stats-inactive-row .inactive-value {
            font-weight: 600;
            color: #475569;
        }

        .stats-inactive-row .inactive-label {
            color: #94a3b8;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        /* Stats Grid - 2x3 for types */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 8px;
            flex: 1;
            min-width: 300px;
        }

        .stats-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 10px 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.5);
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 3px;
            transition: all 0.2s ease;
            position: relative;
        }

        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }

        .stats-card-view-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 18px;
            height: 18px;
            border-radius: 4px;
            background: rgba(100, 116, 139, 0.1);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.5;
            transition: all 0.2s ease;
        }

        .stats-card-view-btn:hover {
            opacity: 1;
            background: rgba(59, 130, 246, 0.15);
        }

        .stats-card-view-btn svg {
            width: 10px;
            height: 10px;
            stroke: #64748b;
        }

        .stats-card-view-btn:hover svg {
            stroke: #3b82f6;
        }

        .stats-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stats-card-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
        }

        .stats-card-icon.green { background: #f0fdf4; }
        .stats-card-icon.purple { background: #f5f3ff; }
        .stats-card-icon.orange { background: #fff7ed; }
        .stats-card-icon.cyan { background: #ecfeff; }
        .stats-card-icon.yellow { background: #fefce8; }
        .stats-card-icon.red { background: #fef2f2; }

        .stats-card-info {
            display: flex;
            flex-direction: column;
        }

        .stats-card-value {
            font-size: 18px;
            font-weight: 700;
            color: #0f172a;
            line-height: 1.1;
        }

        .stats-card-label {
            font-size: 10px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .stats-card-breakdown {
            display: flex;
            gap: 8px;
            font-size: 10px;
            color: #64748b;
            padding-top: 4px;
            margin-top: 2px;
            border-top: 1px solid #f1f5f9;
        }

        .stats-card-breakdown .lo {
            color: #f59e0b;
            font-weight: 600;
        }

        .stats-card-breakdown .np {
            color: #3b82f6;
            font-weight: 600;
        }

        @media (max-width: 900px) {
            .stats-container {
                flex-direction: column;
            }
            .stats-total-card {
                flex-direction: row;
                align-items: center;
                gap: 16px;
                flex-wrap: wrap;
            }
            .stats-total-breakdown {
                margin-top: 0;
                padding-top: 0;
                border-top: none;
                border-left: 1px solid #f1f5f9;
                padding-left: 16px;
            }
            .stats-inactive-row {
                margin-top: 0;
                margin-left: auto;
            }
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 600px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .stats-bar-divider {
            width: 1px;
            height: 40px;
            background: linear-gradient(to bottom, transparent, #e2e8f0, transparent);
        }

        /* Stats Divider - vertical line */
        .stats-divider {
            width: 1px;
            align-self: stretch;
            background: linear-gradient(to bottom, transparent 10%, #e2e8f0 30%, #e2e8f0 70%, transparent 90%);
            margin: 0 6px;
        }

        /* Quick Access Section */
        .quick-access-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 240px;
            max-width: 300px;
        }

        .quick-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 10px 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.2s ease;
            width: 100%;
            flex: 1;
        }

        .quick-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }

        .alerts-card {
            cursor: pointer;
        }

        .mute-btn {
            margin-left: auto;
            background: rgba(100, 116, 139, 0.1);
            border: none;
            border-radius: 4px;
            padding: 3px 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            opacity: 0.7;
        }

        .mute-btn:hover {
            background: rgba(100, 116, 139, 0.2);
            opacity: 1;
        }

        .mute-btn.muted {
            background: rgba(239, 68, 68, 0.15);
        }

        .quick-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .quick-card-icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .quick-card-icon.blue { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .quick-card-icon.orange { background: linear-gradient(135deg, #f59e0b, #d97706); }

        .quick-card-title {
            font-weight: 600;
            color: #1e293b;
            font-size: 11px;
        }

        .quick-card-content {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .urgency-badges {
            display: flex;
            gap: 6px;
            font-size: 9px;
        }

        .urgency-badge {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .pipeline-timers {
            display: flex;
            gap: 4px;
            width: 100%;
        }

        .pipeline-timer {
            padding: 4px 4px;
            background: #f8fafc;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }

        .timer-label {
            font-size: 8px;
            color: #94a3b8;
            font-weight: 500;
        }

        .timer-value {
            font-size: 9px;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
            width: 100%;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .timer-value.red { color: #dc2626; }
        .timer-value.blue { color: #2563eb; }
        .timer-value.green { color: #059669; }

        .quick-card-stats {
            display: flex;
            gap: 0;
        }

        .alert-stat {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px 8px;
            background: #f8fafc;
            border-radius: 6px;
        }

        .alert-stat:first-child {
            border-radius: 6px 0 0 6px;
            border-right: 1px solid #e2e8f0;
        }

        .alert-stat:last-child {
            border-radius: 0 6px 6px 0;
        }

        .alert-stat .alert-value {
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
        }

        .alert-stat .alert-value.muted {
            color: #64748b;
        }

        .alert-stat .alert-label {
            font-size: 9px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .alert-value {
            font-size: 16px;
            font-weight: 700;
            color: #f59e0b;
            line-height: 1.1;
        }

        .alert-value.muted {
            color: #64748b;
            font-size: 13px;
        }

        .alert-label {
            font-size: 9px;
            color: #94a3b8;
            text-transform: uppercase;
        }

        /* Side-by-side Dashboard Layout */
        .dashboard-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .dashboard-row .scraper-control-card {
            margin-top: 0;
        }

        @media (max-width: 1024px) {
            .dashboard-row {
                grid-template-columns: 1fr;
            }
        }

        .stat-card {
            position: relative;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg,
                rgba(99, 102, 241, 0.03) 0%,
                transparent 100%);
            pointer-events: none;
            z-index: 0;
        }

        .stat-card > * {
            position: relative;
            z-index: 1;
        }

        .stat-card:hover {
            box-shadow:
                0 20px 40px rgba(0, 0, 0, 0.12),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            transform: translateY(-4px) scale(1.01);
            border-color: rgba(99, 102, 241, 0.2);
        }

        .stat-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .stat-card-title {
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-icon.blue {
            background: #eff6ff;
            color: #2563eb;
        }

        .stat-icon.purple {
            background: #f5f3ff;
            color: #7c3aed;
        }

        .stat-icon.green {
            background: #f0fdf4;
            color: #16a34a;
        }

        .stat-icon svg {
            width: 22px;
            height: 22px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #0f172a;
        }

        .stat-breakdown {
            display: flex;
            gap: 12px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e2e8f0;
        }

        .stat-breakdown-item {
            flex: 1;
            text-align: center;
        }

        .stat-breakdown-label {
            font-size: 10px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .stat-breakdown-value {
            font-size: 20px;
            font-weight: 700;
            color: #0f172a;
        }

        .stat-breakdown-value.lo {
            color: #2563eb;
        }

        .stat-breakdown-value.np {
            color: #e11d48;
        }

        /* Scraper Control Card */
        .scraper-control-card {
            position: relative;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.4);
            margin-top: 24px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .scraper-control-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg,
                rgba(139, 92, 246, 0.03) 0%,
                transparent 100%);
            pointer-events: none;
            z-index: 0;
        }

        .scraper-control-card > * {
            position: relative;
            z-index: 1;
        }

        .scraper-control-card:hover {
            box-shadow:
                0 12px 36px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            border-color: rgba(139, 92, 246, 0.2);
        }

        .scraper-control-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .scraper-control-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            color: #0f172a;
        }

        .scraper-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .scraper-status.running {
            background: #dcfce7;
            color: #16a34a;
        }

        .scraper-status.stopped {
            background: #f1f5f9;
            color: #64748b;
        }

        .scraper-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        .scraper-status.running .scraper-status-dot {
            background: #16a34a;
        }

        .scraper-status.stopped .scraper-status-dot {
            background: #94a3b8;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .scraper-controls {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: end;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        .control-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 6px;
        }

        .control-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            color: #0f172a;
            background: white;
            cursor: pointer;
        }

        .scraper-buttons {
            display: flex;
            gap: 8px;
        }

        .scraper-btn {
            position: relative;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            overflow: hidden;
        }

        .scraper-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Outlined Start Button */
        .scraper-btn.start {
            background: transparent;
            color: #10b981;
            border: 2px solid #10b981;
            box-shadow: none;
        }

        .scraper-btn.start:hover:not(:disabled) {
            background: #10b981;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
        }

        .scraper-btn.start:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: none;
        }

        /* Outlined Stop Button */
        .scraper-btn.stop {
            background: transparent;
            color: #ef4444;
            border: 2px solid #ef4444;
            box-shadow: none;
        }

        .scraper-btn.stop:hover:not(:disabled) {
            background: #ef4444;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.25);
        }

        .scraper-btn.stop:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: none;
        }

        /* Primary Outlined (Blue) */
        .scraper-btn.primary {
            background: transparent;
            color: #3b82f6;
            border: 2px solid #3b82f6;
        }

        .scraper-btn.primary:hover:not(:disabled) {
            background: #3b82f6;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
        }

        /* Icon hover animation */
        .scraper-btn:hover:not(:disabled) > span:first-child {
            transform: scale(1.1);
        }

        .scraper-progress {
            margin-top: 16px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 6px;
            display: none;
        }

        .scraper-progress.active {
            display: block;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: #64748b;
            margin-bottom: 8px;
        }

        .progress-bar {
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            transition: width 0.3s ease;
            width: 0%;
        }

        /* Auto Pipeline Items */
        .auto-pipeline-item {
            padding: 16px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .auto-pipeline-item:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #e0e7ff 100%);
            border-color: #c7d2fe;
            transform: translateX(2px);
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 26px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch input:checked + .toggle-slider {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.4);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        .toggle-slider:hover {
            box-shadow:
                inset 0 2px 4px rgba(0, 0, 0, 0.1),
                0 0 8px rgba(99, 102, 241, 0.3);
        }

        /* Status Indicator */
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            margin-right: 6px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.1);
            }
        }

        /* Filters */
        .filters-bar {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .filters-bar-compact {
            padding: 12px 16px;
        }

        .filters-main-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filters-inputs {
            display: flex;
            flex: 1;
            gap: 10px;
        }

        .filters-inputs > * {
            flex: 1;
            min-width: 0;
        }

        .filters-buttons {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .filter-search-wrapper {
            position: relative;
            flex: 1;
            min-width: 0;
        }

        .filter-search-wrapper .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            color: #94a3b8;
            pointer-events: none;
        }

        .filter-search {
            padding-left: 38px !important;
            width: 100%;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
            min-width: 140px;
        }

        .filter-label {
            font-size: 11px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-input, .filter-select {
            padding: 8px 12px;
            border: 1.5px solid #e2e8f0;
            border-radius: 8px;
            font-size: 13px;
            font-family: inherit;
            transition: all 0.2s;
            background: white;
        }

        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .btn-icon {
            width: 38px;
            height: 38px;
            padding: 0;
            border: 1.5px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: #64748b;
            flex-shrink: 0;
        }

        .btn-icon:hover {
            border-color: #6366f1;
            color: #6366f1;
            background: #f5f3ff;
        }

        .btn-icon:active {
            transform: scale(0.95);
        }

        .btn-icon svg {
            width: 18px;
            height: 18px;
        }

        .btn-icon.active {
            border-color: #6366f1;
            color: #6366f1;
            background: #f5f3ff;
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
            margin-top: auto;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-secondary {
            background: white;
            color: #64748b;
            border: 1.5px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }

        .btn svg {
            width: 16px;
            height: 16px;
        }

        /* Advanced Filters */
        .advanced-filters-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #475569;
            transition: all 0.2s;
            margin-top: 8px;
            width: fit-content;
        }

        .advanced-filters-toggle:hover {
            background: #e2e8f0;
            color: #1e293b;
        }

        .advanced-filters-toggle svg {
            width: 16px;
            height: 16px;
            transition: transform 0.3s;
        }

        .advanced-filters-toggle.open svg {
            transform: rotate(180deg);
        }

        .advanced-filters-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
            opacity: 0;
            padding: 0 20px;
            margin: 0 -20px;
        }

        .advanced-filters-content.open {
            max-height: 300px;
            opacity: 1;
            padding: 16px 20px;
            border-top: 1px solid #e2e8f0;
            margin-top: 16px;
        }

        .advanced-filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }

        /* Location badge for cards */
        .event-location-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            font-size: 12px;
            color: #64748b;
        }
        .event-location-badge svg {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
            color: #94a3b8;
        }
        .event-location-badge span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Responsive Filters */
        @media (max-width: 768px) {
            .filters-bar-compact {
                padding: 10px 12px;
            }
            .filters-main-row {
                flex-wrap: wrap;
                gap: 8px;
            }
            .filters-inputs {
                width: 100%;
                order: 1;
            }
            .filters-buttons {
                order: 0;
                margin-left: auto;
            }
            .filter-select {
                font-size: 12px;
                padding: 8px 10px;
            }
            .btn-icon {
                width: 36px;
                height: 36px;
            }
            .btn-icon svg {
                width: 16px;
                height: 16px;
            }
            .advanced-filters-grid {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            .filter-group {
                min-width: 0;
            }
        }

        @media (max-width: 480px) {
            .filters-inputs {
                flex-direction: column;
                gap: 6px;
            }
            .filter-select {
                font-size: 11px;
                padding: 6px 8px;
            }
            .btn-icon {
                width: 34px;
                height: 34px;
            }
            .advanced-filters-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Inspection Modal */
        .inspection-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .inspection-modal.active {
            display: flex;
        }

        /* Modal Loading Overlay */
        .modal-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            border-radius: 16px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .modal-loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(59, 130, 246, 0.2);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .modal-loading-text {
            margin-top: 20px;
            color: #e2e8f0;
            font-size: 16px;
            font-weight: 500;
        }

        .modal-loading-subtext {
            margin-top: 8px;
            color: #94a3b8;
            font-size: 13px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .inspection-content {
            position: relative;
            display: flex;
            background: white;
            border-radius: 16px;
            max-width: 1200px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        .inspection-carousel {
            flex: 1.2;
            background: #0f172a;
            position: relative;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .inspection-carousel-images {
            display: flex;
            width: 100%;
            height: 100%;
            transition: transform 0.4s ease;
            position: absolute;
            top: 0;
            left: 0;
        }

        .inspection-carousel-image {
            min-width: 100%;
            height: 100%;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
        }

        .inspection-carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10;
        }

        .inspection-carousel-nav:hover {
            background: white;
            transform: translateY(-50%) scale(1.1);
        }

        .inspection-carousel-nav.prev { left: 16px; }
        .inspection-carousel-nav.next { right: 16px; }

        .inspection-carousel-nav svg {
            width: 24px;
            height: 24px;
            color: #1e293b;
        }

        .inspection-carousel-indicators {
            position: absolute;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
        }

        .inspection-carousel-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            cursor: pointer;
            transition: all 0.2s;
        }

        .inspection-carousel-indicator.active {
            background: white;
            transform: scale(1.2);
        }

        .inspection-carousel-counter {
            position: absolute;
            top: 16px;
            left: 16px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .inspection-details {
            flex: 0.8;
            padding: 24px;
            overflow-y: auto;
            max-height: 90vh;
        }

        .inspection-close {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: all 0.2s;
        }

        .inspection-close:hover {
            background: white;
            transform: scale(1.1);
        }

        .inspection-close svg {
            width: 20px;
            height: 20px;
            color: #1e293b;
        }

        .inspection-header {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e2e8f0;
        }

        .inspection-ref {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .inspection-ref-prefix {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
        }

        .inspection-ref-prefix.lo {
            background: #dbeafe;
            color: #1e40af;
        }

        .inspection-ref-prefix.np {
            background: #fce7f3;
            color: #9f1239;
        }

        .inspection-ref-text {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
        }

        .inspection-type {
            font-size: 13px;
            color: #64748b;
        }

        .inspection-section {
            margin-bottom: 16px;
        }

        .inspection-section-title {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748b;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .inspection-section-title svg {
            width: 14px;
            height: 14px;
        }

        .inspection-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .inspection-row:last-child {
            border-bottom: none;
        }

        .inspection-label {
            font-size: 13px;
            color: #64748b;
        }

        .inspection-value {
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
        }

        .inspection-value.price {
            color: #059669;
        }

        .inspection-value.empty {
            color: #94a3b8;
            font-weight: 400;
        }

        .inspection-actions {
            display: flex;
            gap: 8px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #e2e8f0;
        }

        .inspection-action-btn {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .inspection-action-btn.primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }

        .inspection-action-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .inspection-action-btn.secondary {
            background: #f1f5f9;
            color: #475569;
        }

        .inspection-action-btn.secondary:hover {
            background: #e2e8f0;
        }

        .inspection-action-btn svg {
            width: 16px;
            height: 16px;
        }

        @media (max-width: 900px) {
            .inspection-content {
                flex-direction: column;
                max-height: 95vh;
            }

            .inspection-carousel {
                min-height: 250px;
                max-height: 40vh;
            }

            .inspection-details {
                max-height: 55vh;
            }
        }

        /* Type Badges */
        .type-badges {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .type-badge {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .type-badge.lo {
            background: #dbeafe;
            color: #1e40af;
        }

        .type-badge.lo.active {
            background: #2563eb;
            color: white;
            border-color: #1e40af;
        }

        .type-badge.np {
            background: #fce7f3;
            color: #9f1239;
        }

        .type-badge.np.active {
            background: #e11d48;
            color: white;
            border-color: #9f1239;
        }

        .type-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Events Grid */
        .events-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 18px;
            margin-bottom: 32px;
        }

        /* Skeleton Loading */
        @keyframes skeleton-shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .skeleton-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            overflow: hidden;
            height: 580px;
        }

        .skeleton-element {
            background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s infinite;
            border-radius: 4px;
        }

        .skeleton-image {
            width: 100%;
            height: 180px;
            border-radius: 0;
        }

        .skeleton-header {
            display: flex;
            justify-content: space-between;
            padding: 12px;
        }

        .skeleton-badge {
            width: 80px;
            height: 24px;
        }

        .skeleton-type {
            width: 70px;
            height: 24px;
        }

        .skeleton-body {
            padding: 12px;
        }

        .skeleton-section {
            margin-bottom: 16px;
        }

        .skeleton-title {
            width: 140px;
            height: 16px;
            margin-bottom: 12px;
        }

        .skeleton-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .skeleton-label {
            width: 60px;
            height: 14px;
        }

        .skeleton-value {
            width: 100px;
            height: 14px;
        }

        .skeleton-actions {
            display: flex;
            justify-content: space-around;
            padding: 12px;
            margin-top: auto;
        }

        .skeleton-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
        }

        /* Event Card */
        .event-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            height: 580px;
            /* Performance: CSS containment */
            contain: layout style paint;
            content-visibility: auto;
            contain-intrinsic-size: 280px 580px;
        }

        .event-card:hover {
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            transform: translateY(-4px);
        }

        .event-carousel {
            position: relative;
            width: 100%;
            height: 180px;
            min-height: 180px;
            background: #f1f5f9;
            overflow: hidden;
        }

        .event-carousel-images {
            display: flex;
            height: 100%;
            transition: transform 0.3s ease;
        }

        .event-carousel-image {
            min-width: 100%;
            height: 100%;
            object-fit: cover;
            background-color: #e2e8f0;
            background-position: center;
            background-size: cover;
            background-repeat: no-repeat;
            transition: background-image 0.2s ease;
        }

        .event-carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10;
        }

        .event-carousel-nav:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        .event-carousel-nav.prev {
            left: 8px;
        }

        .event-carousel-nav.next {
            right: 8px;
        }

        .event-carousel-nav svg {
            width: 16px;
            height: 16px;
        }

        .event-carousel-indicators {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 6px;
            z-index: 10;
        }

        .event-carousel-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.2s;
        }

        .event-carousel-indicator.active {
            background: white;
            width: 24px;
            border-radius: 4px;
        }

        .event-carousel-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #94a3b8;
            font-size: 14px;
        }

        .event-card-header {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            padding: 10px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .event-ref-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
        }

        .event-type-prefix {
            font-size: 13px;
            font-weight: 800;
            padding: 6px 10px;
            border-radius: 6px;
            letter-spacing: 0.8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .event-type-prefix.lo {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
        }

        .event-type-prefix.np {
            background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
            color: white;
        }

        .event-ref-text {
            font-size: 14px;
            font-weight: 700;
            color: #e2e8f0;
        }

        .event-type-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .event-type-badge.imovel {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }

        .event-type-badge.veiculo {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        .event-type-badge.equipamento {
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
        }

        .event-type-badge.mobiliario {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }

        .event-type-badge.maquina {
            background: rgba(107, 114, 128, 0.15);
            color: #6b7280;
        }

        .event-type-badge.direito {
            background: rgba(236, 72, 153, 0.15);
            color: #ec4899;
        }

        .event-type-badge svg {
            width: 14px;
            height: 14px;
        }

        .event-card-body {
            padding: 10px;
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .event-card-body::-webkit-scrollbar {
            width: 4px;
        }

        .event-card-body::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 2px;
        }

        .event-card-body::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }

        .event-card-body::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .event-section {
            margin-bottom: 6px;
            padding-bottom: 6px;
            border-bottom: 1px solid #f1f5f9;
        }

        .event-section:last-child {
            margin-bottom: 0;
            border-bottom: none;
            padding-bottom: 0;
        }

        .card-actions {
            display: flex;
            gap: 6px;
            padding: 8px 10px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            margin-top: auto;
        }

        .card-action-btn {
            flex: 1;
            padding: 8px;
            border: 1.5px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 600;
            color: #64748b;
        }

        .card-action-btn:hover {
            background: #6366f1;
            border-color: #6366f1;
            color: white;
            transform: translateY(-1px);
        }

        .card-action-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: #f1f5f9;
        }

        .card-action-btn:disabled:hover {
            background: #f1f5f9;
            border-color: #e2e8f0;
            color: #94a3b8;
            transform: none;
        }

        .card-action-btn svg {
            width: 14px;
            height: 14px;
        }

        .card-favorite-btn {
            transition: all 0.2s;
        }

        .card-favorite-btn:hover {
            background: #fef3c7 !important;
            border-color: #f59e0b !important;
            color: #f59e0b !important;
        }

        .card-favorite-btn.is-favorite {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #f59e0b;
        }

        .card-favorite-btn.is-favorite:hover {
            background: #fde68a !important;
            border-color: #d97706 !important;
        }

        .event-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .section-title {
            font-size: 10px;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .section-title svg {
            width: 12px;
            height: 12px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: start;
            padding: 2px 0;
            gap: 6px;
        }

        .detail-label {
            color: #64748b;
            font-size: 11px;
            font-weight: 500;
            flex-shrink: 0;
        }

        .detail-value {
            color: #0f172a;
            font-size: 11px;
            font-weight: 600;
            text-align: right;
            word-break: break-word;
        }

        .detail-value.empty {
            color: #cbd5e1;
            font-style: italic;
        }

        .detail-value.price {
            color: #16a34a;
            font-size: 15px;
            font-weight: 700;
        }

        .detail-value.date {
            color: #ea580c;
            font-weight: 600;
        }

        /* Loading & Empty States */
        .loading {
            text-align: center;
            padding: 60px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e2e8f0;
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: #64748b;
            font-size: 14px;
            font-weight: 500;
        }

        .no-data {
            text-align: center;
            padding: 60px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .no-data-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            color: #cbd5e1;
        }

        .no-data-text {
            color: #64748b;
            font-size: 16px;
            font-weight: 500;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-top: 32px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .pagination button {
            padding: 10px 20px;
            border: 1.5px solid #e2e8f0;
            background: white;
            color: #475569;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pagination button:hover:not(:disabled) {
            background: #f8fafc;
            border-color: #6366f1;
            color: #6366f1;
        }

        .pagination button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pagination button svg {
            width: 16px;
            height: 16px;
        }

        .page-info {
            padding: 0 16px;
            font-weight: 600;
            color: #0f172a;
            font-size: 14px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                width: 220px;
            }

            .main-content {
                margin-left: 220px;
                width: calc(100% - 220px);
            }

            .events-grid {
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                width: 100%;
                padding: 20px;
            }

            .events-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stats-bar {
                flex-direction: column;
                gap: 0;
                padding: 8px;
            }

            .stats-bar-item {
                padding: 12px;
                border-bottom: 1px solid #e2e8f0;
            }

            .stats-bar-item:last-child {
                border-bottom: none;
            }

            .stats-bar-divider {
                display: none;
            }

            .filters-bar {
                flex-direction: column;
            }

            .filter-group {
                width: 100%;
                min-width: 0;
            }

            /* Dashboard grid mobile */
            #dashboard-content {
                grid-template-columns: 1fr !important;
            }

            /* Dashboard 2-column grid to single column */
            #dashboard > div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }

            /* Ending soon header - hide less important columns */
            .ending-soon-row span:nth-child(3),
            .ending-soon-row span:nth-child(5) {
                display: none;
            }

            /* Better touch targets */
            .nav-item {
                min-height: 48px;
            }

            button, .btn, [onclick] {
                min-height: 44px;
                min-width: 44px;
            }

            /* Favorites widget responsive */
            #favorites-widget-content > div {
                padding: 12px !important;
            }

            /* Toast positioning on mobile */
            #toast-container {
                right: 16px !important;
                left: 16px !important;
                max-width: none !important;
            }

            /* Modal full width on mobile */
            .modal-content, .inspection-modal .inspection-dialog {
                width: 95% !important;
                max-width: none !important;
                margin: 10px !important;
            }

            /* Top districts chart stack vertically */
            #dashboard > div[style*="grid-template-columns: 200px 1fr"] {
                grid-template-columns: 1fr !important;
            }

            .page-header h2 {
                font-size: 20px;
            }

            /* Mobile hamburger menu */
            .mobile-menu-btn {
                display: flex !important;
            }
        }

        /* Extra small screens */
        @media (max-width: 480px) {
            .main-content {
                padding: 12px;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .ending-soon-row {
                padding: 8px !important;
                font-size: 9px !important;
            }

            .ending-soon-row span:nth-child(4) {
                display: none;
            }
        }

        /* Mobile menu button (hidden by default) */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 1001;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .mobile-menu-btn:active {
            transform: scale(0.95);
        }

        .mobile-menu-btn.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        /* Mobile overlay */
        .mobile-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .mobile-overlay.active {
            display: block;
            opacity: 1;
        }

        @media (max-width: 768px) {
            .mobile-overlay.active {
                display: block;
            }
        }

        /* Multi-Stage Controls */
        .stage-control {
            margin-bottom: 16px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .stage-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .stage-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: white;
        }

        .stage-badge.stage-1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .stage-badge.stage-2 {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .stage-badge.stage-3 {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .stage-result {
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
            padding: 4px 12px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .stage-result.success {
            color: #16a34a;
            border-color: #86efac;
            background: #dcfce7;
        }

        .stage-result.loading {
            color: #0284c7;
            border-color: #7dd3fc;
            background: #e0f2fe;
        }

        .stage-controls {
            display: flex;
            gap: 8px;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        .stage-controls textarea {
            resize: vertical;
            flex: 1;
            min-width: 200px;
        }

        /* ===== PIPELINE ANIMATIONS ===== */

        /* Animated gradient flow in progress line */
        @keyframes gradientFlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        #pipeline-progress-line {
            background: linear-gradient(90deg,
                #3b82f6 0%,
                #8b5cf6 25%,
                #ec4899 50%,
                #8b5cf6 75%,
                #3b82f6 100%) !important;
            background-size: 200% 100% !important;
            animation: gradientFlow 3s ease infinite;
        }

        /* Pipeline stage pulse effect when active */
        .pipeline-stage {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .pipeline-stage.stage-active {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(59, 130, 246, 0);
            }
        }

        /* Flow particles animation */
        @keyframes flowParticle {
            0% {
                left: 0%;
                opacity: 0;
            }
            25% {
                opacity: 1;
            }
            75% {
                opacity: 1;
            }
            100% {
                left: 100%;
                opacity: 0;
            }
        }

        /* Shimmer effect for status badges */
        @keyframes shimmer {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }

        .status-badge-running {
            position: relative;
            overflow: hidden;
        }

        .status-badge-running::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent);
            animation: shimmer 2s infinite;
        }

        /* Success checkmark bounce */
        @keyframes successBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .status-badge-success {
            animation: successBounce 0.6s ease;
        }

        /* Error shake animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .status-badge-error {
            animation: shake 0.4s ease;
        }

        /* Stat icon subtle rotation on hover */
        .stat-icon {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card:hover .stat-icon {
            transform: rotate(5deg) scale(1.1);
        }

        /* Fade in up animation for event cards */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Removed staggered animations for performance */
        .events-grid {
            animation: fadeIn 0.15s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Loading skeleton shimmer */
        @keyframes loadingSkeleton {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton {
            background: linear-gradient(
                90deg,
                #f0f0f0 25%,
                #e0e0e0 50%,
                #f0f0f0 75%
            );
            background-size: 200% 100%;
            animation: loadingSkeleton 1.5s infinite;
            border-radius: 4px;
        }

        /* Price chart tooltip - positioned via JavaScript */
        .price-chart-btn {
            position: relative;
        }
        .price-chart-btn:hover > svg { stroke: #3b82f6; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .spin { animation: spin 1s linear infinite; }
        .chart-point { pointer-events: none; opacity: 0; transition: opacity 0.15s; }
        .chart-point.last-point { opacity: 1; }
        .chart-point.active { opacity: 1; }

        /* Row hover effects for tables */
        .ending-soon-row, .recent-bid-row {
            transition: background 0.15s ease;
        }
        .ending-soon-row:hover, .ending-soon-row.highlight-linked {
            background: #dbeafe !important;
        }
        .recent-bid-row:hover, .recent-bid-row.highlight-linked {
            background: #dcfce7 !important;
        }

        /* Prevent horizontal scroll on widget containers */
        #dash-ending-soon, #dash-recent-bids {
            overflow-x: hidden;
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Sidebar -->
    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobile-overlay" onclick="closeMobileMenu()"></div>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" id="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Menu">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="6" x2="21" y2="6"/>
            <line x1="3" y1="12" x2="21" y2="12"/>
            <line x1="3" y1="18" x2="21" y2="18"/>
        </svg>
    </button>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1>
                <svg viewBox="0 0 24 24" fill="currentColor" style="width: 22px; height: 22px;">
                    <rect x="4" y="4" width="16" height="3" rx="1"/>
                    <rect x="4" y="10.5" width="12" height="3" rx="1"/>
                    <rect x="4" y="17" width="16" height="3" rx="1"/>
                </svg>
                <span>E-Leil√µes</span>
            </h1>
            <p>Sistema de Gest√£o</p>
        </div>

        <nav class="sidebar-nav">
            <!-- MAIN -->
            <div class="nav-section-label">Main</div>
            <div class="nav-item active" onclick="showPage('dashboard')" data-page="dashboard">
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                </svg>
                <span>Dashboard</span>
            </div>

            <div class="nav-divider"></div>

            <!-- EVENTS -->
            <div class="nav-section-label">Events</div>
            <div class="nav-item" onclick="showPage('eventos')" data-page="eventos">
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                </svg>
                <span>Eventos</span>
            </div>
            <div class="nav-item" onclick="showPage('favoritos')" data-page="favoritos">
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                </svg>
                <span>Favoritos</span>
                <span class="nav-badge" id="nav-favorites-badge" style="display: none;">0</span>
            </div>

            <div class="nav-divider"></div>

            <!-- TOOLS -->
            <div class="nav-section-label">Tools</div>
            <div class="nav-item" onclick="showPage('alertas')" data-page="alertas">
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                </svg>
                <span>Notifica√ß√µes</span>
                <span class="nav-badge" id="nav-alerts-badge" style="display: none;">0</span>
            </div>
            <!-- Scraping & Sync removed for public API -->
        </nav>

        <!-- Bottom Section -->
        <div class="sidebar-bottom">
            <!-- User Card -->
            <div class="user-card" id="userCard" onclick="toggleUserDropdown()">
                <div class="user-card-header">
                    <div class="user-card-avatar">JD</div>
                    <div class="user-card-info">
                        <span class="user-card-name">John Doe</span>
                        <span class="user-card-email">john@example.com</span>
                    </div>
                    <svg class="user-card-toggle" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="16" height="16">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>
                <div class="user-card-dropdown">
                    <div class="user-dropdown-item" onclick="event.stopPropagation()">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                        <span>Profile</span>
                    </div>
                    <div class="user-dropdown-item logout" onclick="event.stopPropagation()">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                        <span>Logout</span>
                    </div>
                </div>
            </div>

            <div class="nav-divider"></div>
            <!-- Theme Toggle -->
            <div class="nav-item" onclick="toggleTheme()" id="theme-toggle">
                <svg id="theme-icon-light" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                </svg>
                <svg id="theme-icon-dark" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="display: none;">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                </svg>
                <span id="theme-text">Modo Escuro</span>
            </div>
            <div class="nav-item" onclick="showPage('settings')" data-page="settings">
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <span>Defini√ß√µes</span>
            </div>
            <div class="nav-item" onclick="toggleSidebarLock()">
                <svg id="lockIcon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"/>
                </svg>
                <span>Lock Sidebar</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Dashboard Page -->
        <div id="dashboard" class="page active">
            <!-- Stats Container - Total on left, 2x3 grid on right -->
            <div class="stats-container">
                <!-- Total Card -->
                <div class="stats-total-card">
                    <div class="stats-total-icon">üì¶</div>
                    <span class="stats-total-value" id="stat-total">0</span>
                    <span class="stats-total-label">Ativos</span>
                    <div class="stats-total-breakdown">
                        <span><span class="lo" id="stat-total-lo">0</span> LO</span>
                        <span><span class="np" id="stat-total-np">0</span> NP</span>
                    </div>
                    <div class="stats-inactive-row" title="Eventos terminados ou inativos">
                        <span class="inactive-dot"></span>
                        <span class="inactive-value" id="stat-total-inactive">0</span>
                        <span class="inactive-label">inativos</span>
                    </div>
                </div>

                <!-- 2x3 Grid of Event Types -->
                <div class="stats-grid">
                    <!-- Row 1 -->
                    <div class="stats-card">
                        <button class="stats-card-view-btn" onclick="showPage('imoveis')" title="Ver Im√≥veis">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                        </button>
                        <div class="stats-card-header">
                            <div class="stats-card-icon green">üè†</div>
                            <div class="stats-card-info">
                                <span class="stats-card-value" id="stat-imoveis">0</span>
                                <span class="stats-card-label">Im√≥veis</span>
                            </div>
                        </div>
                        <div class="stats-card-breakdown">
                            <span><span class="lo" id="stat-imoveis-lo">0</span> LO</span>
                            <span><span class="np" id="stat-imoveis-np">0</span> NP</span>
                        </div>
                    </div>
                    <div class="stats-card">
                        <button class="stats-card-view-btn" onclick="showPage('veiculos')" title="Ver Ve√≠culos">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                        </button>
                        <div class="stats-card-header">
                            <div class="stats-card-icon purple">üöó</div>
                            <div class="stats-card-info">
                                <span class="stats-card-value" id="stat-veiculos">0</span>
                                <span class="stats-card-label">Ve√≠culos</span>
                            </div>
                        </div>
                        <div class="stats-card-breakdown">
                            <span><span class="lo" id="stat-veiculos-lo">0</span> LO</span>
                            <span><span class="np" id="stat-veiculos-np">0</span> NP</span>
                        </div>
                    </div>
                    <div class="stats-card">
                        <button class="stats-card-view-btn" onclick="showPage('direitos')" title="Ver Direitos">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                        </button>
                        <div class="stats-card-header">
                            <div class="stats-card-icon orange">üìú</div>
                            <div class="stats-card-info">
                                <span class="stats-card-value" id="stat-direitos">0</span>
                                <span class="stats-card-label">Direitos</span>
                            </div>
                        </div>
                        <div class="stats-card-breakdown">
                            <span><span class="lo" id="stat-direitos-lo">0</span> LO</span>
                            <span><span class="np" id="stat-direitos-np">0</span> NP</span>
                        </div>
                    </div>
                    <!-- Row 2 -->
                    <div class="stats-card">
                        <button class="stats-card-view-btn" onclick="showPage('equipamentos')" title="Ver Equipamentos">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                        </button>
                        <div class="stats-card-header">
                            <div class="stats-card-icon cyan">üîß</div>
                            <div class="stats-card-info">
                                <span class="stats-card-value" id="stat-equipamentos">0</span>
                                <span class="stats-card-label">Equipamentos</span>
                            </div>
                        </div>
                        <div class="stats-card-breakdown">
                            <span><span class="lo" id="stat-equipamentos-lo">0</span> LO</span>
                            <span><span class="np" id="stat-equipamentos-np">0</span> NP</span>
                        </div>
                    </div>
                    <div class="stats-card">
                        <button class="stats-card-view-btn" onclick="showPage('mobiliario')" title="Ver Mobili√°rio">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                        </button>
                        <div class="stats-card-header">
                            <div class="stats-card-icon yellow">ü™ë</div>
                            <div class="stats-card-info">
                                <span class="stats-card-value" id="stat-mobiliario">0</span>
                                <span class="stats-card-label">Mobili√°rio</span>
                            </div>
                        </div>
                        <div class="stats-card-breakdown">
                            <span><span class="lo" id="stat-mobiliario-lo">0</span> LO</span>
                            <span><span class="np" id="stat-mobiliario-np">0</span> NP</span>
                        </div>
                    </div>
                    <div class="stats-card">
                        <button class="stats-card-view-btn" onclick="showPage('maquinas')" title="Ver M√°quinas">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                        </button>
                        <div class="stats-card-header">
                            <div class="stats-card-icon red">‚öôÔ∏è</div>
                            <div class="stats-card-info">
                                <span class="stats-card-value" id="stat-maquinas">0</span>
                                <span class="stats-card-label">M√°quinas</span>
                            </div>
                        </div>
                        <div class="stats-card-breakdown">
                            <span><span class="lo" id="stat-maquinas-lo">0</span> LO</span>
                            <span><span class="np" id="stat-maquinas-np">0</span> NP</span>
                        </div>
                    </div>
                </div>

                <!-- Divider -->
                <div class="stats-divider"></div>

                <!-- Quick Access Section -->
                <div class="quick-access-section">
                    <!-- Scraping & Sync Card -->
                    <div class="quick-card sync-card">
                        <div class="quick-card-header">
                            <div class="quick-card-icon blue">üîÑ</div>
                            <span class="quick-card-title">Pipelines</span>
                        </div>
                        <div class="quick-card-content">
                            <div class="urgency-badges">
                                <span class="urgency-badge critical" title="Cr√≠tico < 5min">üî¥ <span id="x-critical">0</span></span>
                                <span class="urgency-badge urgent" title="Urgente < 1h">üü† <span id="x-urgent">0</span></span>
                                <span class="urgency-badge soon" title="Em breve < 24h">üü° <span id="x-soon">0</span></span>
                            </div>
                            <div class="pipeline-timers">
                                <div class="pipeline-timer" id="card-xmonitor">
                                    <span class="timer-label">X</span>
                                    <span class="timer-value red" id="timer-xmonitor">--:--</span>
                                </div>
                                <div class="pipeline-timer" id="card-ysync">
                                    <span class="timer-label">Y</span>
                                    <span class="timer-value blue" id="timer-ysync">--:--</span>
                                </div>
                                <div class="pipeline-timer" id="card-zwatch">
                                    <span class="timer-label">Z</span>
                                    <span class="timer-value green" id="timer-zwatch">--:--</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Alertas Card -->
                    <div class="quick-card alerts-card" onclick="showPage('alertas')">
                        <div class="quick-card-header">
                            <div class="quick-card-icon orange">üîî</div>
                            <span class="quick-card-title">Alertas</span>
                            <button class="mute-btn" id="mute-notifications-btn" onclick="event.stopPropagation(); toggleNotificationsMute()" title="Silenciar notifica√ß√µes">
                                <span id="mute-icon">üîä</span>
                            </button>
                        </div>
                        <div class="quick-card-stats">
                            <div class="alert-stat" title="Notifica√ß√µes n√£o lidas">
                                <span class="alert-value" id="dash-unread-count">0</span>
                                <span class="alert-label">Novas</span>
                            </div>
                            <div class="alert-stat" title="Regras ativas">
                                <span class="alert-value muted" id="dash-rules-count">0</span>
                                <span class="alert-label">Regras</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Grid: 2 columns -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 12px;">

                <!-- Leil√µes a Terminar em Breve -->
                <div style="background: white; border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08);">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 16px;">‚è∞</span>
                            <span style="font-weight: 600; color: #1e293b; font-size: 14px;">A Terminar em Breve</span>
                        </div>
                        <div style="display: flex; gap: 6px;">
                            <select id="ending-filter-tipo" onchange="filterEndingSoon()" style="padding: 4px 8px; font-size: 10px; border: 1px solid #e2e8f0; border-radius: 4px; background: #f8fafc; color: #64748b;">
                                <option value="">Todos os tipos</option>
                                <option value="1">Im√≥veis</option>
                                <option value="2">Ve√≠culos</option>
                                <option value="3">Equipamentos</option>
                                <option value="4">Mobili√°rio</option>
                                <option value="5">M√°quinas</option>
                                <option value="6">Direitos</option>
                            </select>
                            <select id="ending-filter-distrito" onchange="filterEndingSoon()" style="padding: 4px 8px; font-size: 10px; border: 1px solid #e2e8f0; border-radius: 4px; background: #f8fafc; color: #64748b;">
                                <option value="">Todos os distritos</option>
                            </select>
                        </div>
                    </div>
                    <!-- Header row (sortable) -->
                    <div style="display: flex; align-items: center; padding: 6px 10px; font-size: 9px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; background: #f8fafc; border-radius: 4px; margin-bottom: 4px; border-bottom: 1px solid #e2e8f0;">
                        <span onclick="sortEndingSoon('timer')" style="width: 72px; cursor: pointer; display: flex; align-items: center; gap: 2px;" title="Ordenar por tempo">Timer <span id="sort-icon-timer">‚Üë</span></span>
                        <span onclick="sortEndingSoon('reference')" style="width: 85px; cursor: pointer; display: flex; align-items: center; gap: 2px;" title="Ordenar por ID">ID <span id="sort-icon-reference"></span></span>
                        <span onclick="sortEndingSoon('tipo')" style="width: 65px; cursor: pointer; display: flex; align-items: center; gap: 2px;" title="Ordenar por tipo">Tipo <span id="sort-icon-tipo"></span></span>
                        <span onclick="sortEndingSoon('subtipo')" style="flex: 1; cursor: pointer; display: flex; align-items: center; gap: 2px;" title="Ordenar por subtipo">Subtipo <span id="sort-icon-subtipo"></span></span>
                        <span onclick="sortEndingSoon('distrito')" style="width: 55px; cursor: pointer; display: flex; align-items: center; gap: 2px;" title="Ordenar por distrito">Zona <span id="sort-icon-distrito"></span></span>
                        <span onclick="sortEndingSoon('lance_atual')" style="width: 75px; cursor: pointer; display: flex; align-items: center; gap: 2px; justify-content: flex-end;" title="Ordenar por valor">Valor <span id="sort-icon-lance_atual"></span></span>
                        <span style="width: 24px;"></span>
                        <span style="width: 24px;"></span>
                        <span style="width: 24px;"></span>
                    </div>
                    <div id="dash-ending-soon" style="display: flex; flex-direction: column; gap: 2px; max-height: 320px; overflow-y: auto;">
                        <!-- Loading placeholder -->
                        <div style="text-align: center; padding: 20px; color: #94a3b8; font-size: 11px;">A carregar...</div>
                    </div>
                </div>

                <!-- Licita√ß√µes Recentes -->
                <div style="background: white; border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08);">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 16px;">üí∞</span>
                            <span style="font-weight: 600; color: #1e293b; font-size: 14px;">Licita√ß√µes Recentes</span>
                        </div>
                    </div>
                    <!-- Header row (sortable) -->
                    <div style="display: flex; align-items: center; padding: 6px 10px; font-size: 9px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; background: #f8fafc; border-radius: 4px; margin-bottom: 4px; border-bottom: 1px solid #e2e8f0;">
                        <span onclick="sortRecentBids('reference')" style="width: 80px; cursor: pointer; display: flex; align-items: center; gap: 2px;" title="Ordenar por ID">ID <span id="bids-sort-icon-reference"></span></span>
                        <span onclick="sortRecentBids('preco_atual')" style="flex: 1; cursor: pointer; display: flex; align-items: center; gap: 2px;" title="Ordenar por pre√ßo">Pre√ßo <span id="bids-sort-icon-preco_atual"></span></span>
                        <span onclick="sortRecentBids('variacao')" style="width: 55px; cursor: pointer; display: flex; align-items: center; gap: 2px; justify-content: flex-end;" title="Ordenar por varia√ß√£o">Var. <span id="bids-sort-icon-variacao"></span></span>
                        <span onclick="sortRecentBids('timestamp')" style="width: 30px; cursor: pointer; display: flex; align-items: center; gap: 2px; justify-content: flex-end;" title="Ordenar por tempo">H√° <span id="bids-sort-icon-timestamp">‚Üì</span></span>
                    </div>
                    <div id="dash-recent-bids" style="display: flex; flex-direction: column; gap: 4px; max-height: 320px; overflow-y: auto;">
                        <div style="text-align: center; padding: 20px; color: #94a3b8; font-size: 11px;">A carregar...</div>
                    </div>
                </div>

                <!-- Eventos por Distrito -->
                <div style="background: white; border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); grid-column: span 2;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                        <span style="font-size: 16px;">üìä</span>
                        <span style="font-weight: 600; color: #1e293b; font-size: 14px;">Top Distritos</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 200px 1fr; gap: 24px; align-items: center;">
                        <!-- Donut Chart -->
                        <div style="position: relative; width: 180px; height: 180px;">
                            <canvas id="districts-chart"></canvas>
                        </div>
                        <!-- Breakdown List -->
                        <div id="dash-districts-breakdown" style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="text-align: center; padding: 20px; color: #94a3b8; font-size: 12px;">A carregar...</div>
                        </div>
                    </div>
                </div>

                <!-- New Events Banner -->
                <div style="background: white; border-radius: 12px; padding: 12px 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); border: 1px solid #e5e7eb; grid-column: span 2; overflow: hidden;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-weight: 600; color: #1e293b; font-size: 13px;">Novos Eventos</span>
                            <span id="new-events-count" style="background: #3b82f6; color: white; font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 10px;">0</span>
                        </div>
                        <div style="display: flex; gap: 6px;">
                            <button onclick="scrollNewEvents('left')" style="background: #f1f5f9; border: 1px solid #e2e8f0; width: 24px; height: 24px; border-radius: 6px; color: #64748b; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f1f5f9'">‚Äπ</button>
                            <button onclick="scrollNewEvents('right')" style="background: #f1f5f9; border: 1px solid #e2e8f0; width: 24px; height: 24px; border-radius: 6px; color: #64748b; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f1f5f9'">‚Ä∫</button>
                        </div>
                    </div>
                    <div id="new-events-track" style="display: flex; gap: 10px; overflow-x: auto; scroll-behavior: smooth; padding: 4px 0; scrollbar-width: none; -ms-overflow-style: none;">
                        <div style="color: #94a3b8; font-size: 11px; padding: 20px; white-space: nowrap;">A carregar novos eventos...</div>
                    </div>
                </div>

                <!-- Meus Favoritos / Eventos com Notifica√ß√µes -->
                <div style="background: white; border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); grid-column: span 2;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 16px;">üîî</span>
                            <span style="font-weight: 600; color: #1e293b; font-size: 14px;">Meus Favoritos</span>
                            <span id="favorites-count" style="background: #dbeafe; color: #2563eb; font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 10px;">0</span>
                        </div>
                        <button onclick="showPage('favoritos')" style="padding: 4px 8px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer; font-size: 10px; color: #64748b; transition: all 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='#f8fafc'">Ver todos</button>
                    </div>
                    <div id="favorites-widget-content" style="display: flex; gap: 10px; overflow-x: auto; scroll-behavior: smooth; padding: 4px 0; scrollbar-width: none; -ms-overflow-style: none;">
                        <div style="text-align: center; padding: 20px; color: #94a3b8; width: 100%;">
                            <div style="font-size: 24px; margin-bottom: 8px;">üîî</div>
                            <div style="font-size: 11px;">Sem favoritos</div>
                            <div style="font-size: 10px; color: #cbd5e1; margin-top: 4px;">Clique no üîî nos eventos para adicionar aos favoritos</div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Eventos Page (Unified) -->
        <div id="eventos" class="page">
            <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <h2>Todos os Eventos</h2>
                    <p>Todos os eventos dispon√≠veis em leil√£o</p>
                </div>
            </div>

            <div class="type-badges">
                <div class="type-badge lo" onclick="toggleTypeFilter('LO', this)">
                    <span>LO</span>
                    <span>Leil√£o Online</span>
                </div>
                <div class="type-badge np" onclick="toggleTypeFilter('NP', this)">
                    <span>NP</span>
                    <span>Negocia√ß√£o Particular</span>
                </div>
            </div>

            <div class="filters-bar filters-bar-compact">
                <div class="filters-main-row">
                    <div class="filters-inputs">
                        <div class="filter-search-wrapper">
                            <svg class="search-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                            <input type="text" class="filter-input filter-search" id="search-eventos" placeholder="Pesquisar...">
                        </div>
                        <select class="filter-select" id="tipo-eventos" title="Tipo">
                            <option value="">Todos os tipos</option>
                            <option value="1">Im√≥veis</option>
                            <option value="2">Ve√≠culos</option>
                            <option value="3">Equipamentos</option>
                            <option value="4">Mobili√°rio</option>
                            <option value="5">M√°quinas</option>
                            <option value="6">Direitos</option>
                        </select>
                        <select class="filter-select" id="sort-eventos" title="Ordenar">
                            <option value="">Ordenar...</option>
                            <option value="dataFim_asc">Data fim (pr√≥xima)</option>
                            <option value="dataFim_desc">Data fim (distante)</option>
                            <option value="valorBase_asc">Valor base (baixo)</option>
                            <option value="valorBase_desc">Valor base (alto)</option>
                            <option value="lanceAtual_desc">Lance atual (alto)</option>
                        </select>
                        <select class="filter-select" id="distrito-eventos" title="Distrito">
                            <option value="">Todos os distritos</option>
                        </select>
                    </div>
                    <div class="filters-buttons">
                        <button class="btn-icon" onclick="reloadAllData('eventos')" title="Atualizar Tudo">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                        </button>
                        <button class="btn-icon" onclick="clearFiltersEventos()" title="Limpar Filtros">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <div id="eventos-content">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">A carregar eventos...</div>
                </div>
            </div>

            <div id="pagination-eventos" class="pagination" style="display: none;"></div>
        </div>

        <!-- Im√≥veis Page -->
        <div id="imoveis" class="page" style="display: none;">
            <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <h2>Im√≥veis</h2>
                    <p>Todos os im√≥veis dispon√≠veis em leil√£o</p>
                </div>
                <button class="notification-toggle-btn" id="notify-btn-imoveis" onclick="toggleQuickNotification('imoveis', 1)" title="Ativar notifica√ß√µes para novos im√≥veis">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="20" height="20">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                    </svg>
                    <span>Notificar</span>
                </button>
            </div>

            <div class="type-badges">
                <div class="type-badge lo" onclick="toggleTypeFilter('LO', this)">
                    <span>LO</span>
                    <span>Leil√£o Online</span>
                </div>
                <div class="type-badge np" onclick="toggleTypeFilter('NP', this)">
                    <span>NP</span>
                    <span>Negocia√ß√£o Particular</span>
                </div>
            </div>

            <div class="filters-bar filters-bar-compact">
                <div class="filters-main-row">
                    <div class="filters-inputs">
                        <div class="filter-search-wrapper">
                            <svg class="search-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                            <input type="text" class="filter-input filter-search" id="search-imoveis" placeholder="Pesquisar...">
                        </div>
                        <select class="filter-select" id="sort-imoveis" title="Ordenar">
                            <option value="">Ordenar...</option>
                            <option value="dataFim_asc">Data fim (proxima)</option>
                            <option value="dataFim_desc">Data fim (distante)</option>
                            <option value="valorBase_asc">Valor base (baixo)</option>
                            <option value="valorBase_desc">Valor base (alto)</option>
                            <option value="lanceAtual_desc">Lance atual (alto)</option>
                        </select>
                        <select class="filter-select" id="subtipo-imoveis" title="Subtipo">
                            <option value="">Subtipo...</option>
                        </select>
                    </div>
                    <div class="filters-buttons">
                        <button class="btn-icon" onclick="toggleAdvancedFilters('imoveis')" title="Filtros Avan√ßados" id="btn-advanced-imoveis">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                            </svg>
                        </button>
                        <button class="btn-icon" onclick="reloadAllData('imoveis')" title="Atualizar Tudo">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                        </button>
                        <button class="btn-icon" onclick="clearFilters('imoveis')" title="Limpar Filtros">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Advanced Filters Content -->
                <div class="advanced-filters-content" id="advanced-filters-imoveis">
                    <div class="advanced-filters-grid">
                        <div class="filter-group">
                            <label class="filter-label">Distrito</label>
                            <select class="filter-select" id="distrito-imoveis" onchange="updateConcelhoFilter('imoveis')">
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Concelho</label>
                            <select class="filter-select" id="concelho-imoveis" onchange="updateFreguesiaFilter('imoveis')" disabled>
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Freguesia</label>
                            <select class="filter-select" id="freguesia-imoveis" disabled>
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Tipologia</label>
                            <select class="filter-select" id="tipologia-imoveis">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Valor Min</label>
                            <input type="number" class="filter-input" id="valor-min-imoveis" placeholder="Min">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Valor Max</label>
                            <input type="number" class="filter-input" id="valor-max-imoveis" placeholder="Max">
                        </div>
                    </div>
                </div>
            </div>

            <div id="imoveis-content">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">A carregar im√≥veis...</div>
                </div>
            </div>

            <div id="pagination-imoveis" class="pagination" style="display: none;"></div>
        </div>

        <!-- Ve√≠culos Page -->
        <div id="veiculos" class="page">
            <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <h2>Ve√≠culos</h2>
                    <p>Todos os ve√≠culos dispon√≠veis em leil√£o</p>
                </div>
                <button class="notification-toggle-btn" id="notify-btn-veiculos" onclick="toggleQuickNotification('veiculos', 2)" title="Ativar notifica√ß√µes para novos ve√≠culos">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="20" height="20">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                    </svg>
                    <span>Notificar</span>
                </button>
            </div>
            <div class="type-badges">
                <div class="type-badge lo" onclick="toggleTypeFilter('LO', this)"><span>LO</span><span>Leil√£o Online</span></div>
                <div class="type-badge np" onclick="toggleTypeFilter('NP', this)"><span>NP</span><span>Negocia√ß√£o Particular</span></div>
            </div>
            <div class="filters-bar filters-bar-compact">
                <div class="filters-main-row">
                    <div class="filters-inputs">
                        <div class="filter-search-wrapper">
                            <svg class="search-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                            <input type="text" class="filter-input filter-search" id="search-veiculos" placeholder="Pesquisar...">
                        </div>
                        <select class="filter-select" id="sort-veiculos" title="Ordenar">
                            <option value="">Ordenar...</option>
                            <option value="dataFim_asc">Data fim (proxima)</option>
                            <option value="dataFim_desc">Data fim (distante)</option>
                            <option value="valorBase_asc">Valor base (baixo)</option>
                            <option value="valorBase_desc">Valor base (alto)</option>
                            <option value="lanceAtual_desc">Lance atual (alto)</option>
                        </select>
                        <select class="filter-select" id="subtipo-veiculos" title="Subtipo">
                            <option value="">Subtipo...</option>
                        </select>
                    </div>
                    <div class="filters-buttons">
                        <button class="btn-icon" onclick="toggleAdvancedFilters('veiculos')" title="Filtros Avan√ßados" id="btn-advanced-veiculos">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                            </svg>
                        </button>
                        <button class="btn-icon" onclick="reloadAllData('veiculos')" title="Atualizar Tudo">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                        </button>
                        <button class="btn-icon" onclick="clearFilters('veiculos')" title="Limpar Filtros">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="advanced-filters-content" id="advanced-filters-veiculos">
                    <div class="advanced-filters-grid">
                        <div class="filter-group">
                            <label class="filter-label">Marca</label>
                            <select class="filter-select" id="marca-veiculos">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Valor Min</label>
                            <input type="number" class="filter-input" id="valor-min-veiculos" placeholder="Min">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Valor Max</label>
                            <input type="number" class="filter-input" id="valor-max-veiculos" placeholder="Max">
                        </div>
                    </div>
                </div>
            </div>
            <div id="veiculos-content"><div class="loading"><div class="loading-spinner"></div><div class="loading-text">A carregar ve√≠culos...</div></div></div>
            <div id="pagination-veiculos" class="pagination" style="display: none;"></div>
        </div>

        <!-- Direitos Page -->
        <div id="direitos" class="page">
            <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <h2>Direitos</h2>
                    <p>Todos os direitos dispon√≠veis em leil√£o</p>
                </div>
                <button class="notification-toggle-btn" id="notify-btn-direitos" onclick="toggleQuickNotification('direitos', 6)" title="Ativar notifica√ß√µes para novos direitos">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="20" height="20">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                    </svg>
                    <span>Notificar</span>
                </button>
            </div>
            <div class="type-badges">
                <div class="type-badge lo" onclick="toggleTypeFilter('LO', this)"><span>LO</span><span>Leil√£o Online</span></div>
                <div class="type-badge np" onclick="toggleTypeFilter('NP', this)"><span>NP</span><span>Negocia√ß√£o Particular</span></div>
            </div>
            <div class="filters-bar filters-bar-compact">
                <div class="filters-main-row">
                    <div class="filters-inputs">
                        <div class="filter-search-wrapper">
                            <svg class="search-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                            <input type="text" class="filter-input filter-search" id="search-direitos" placeholder="Pesquisar...">
                        </div>
                        <select class="filter-select" id="sort-direitos" title="Ordenar">
                            <option value="">Ordenar...</option>
                            <option value="dataFim_asc">Data fim (proxima)</option>
                            <option value="dataFim_desc">Data fim (distante)</option>
                            <option value="valorBase_asc">Valor base (baixo)</option>
                            <option value="valorBase_desc">Valor base (alto)</option>
                            <option value="lanceAtual_desc">Lance atual (alto)</option>
                        </select>
                        <select class="filter-select" id="subtipo-direitos" title="Subtipo">
                            <option value="">Subtipo...</option>
                        </select>
                    </div>
                    <div class="filters-buttons">
                        <button class="btn-icon" onclick="toggleAdvancedFilters('direitos')" title="Filtros Avan√ßados" id="btn-advanced-direitos">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                            </svg>
                        </button>
                        <button class="btn-icon" onclick="reloadAllData('direitos')" title="Atualizar Tudo">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                        </button>
                        <button class="btn-icon" onclick="clearFilters('direitos')" title="Limpar Filtros">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="advanced-filters-content" id="advanced-filters-direitos">
                    <div class="advanced-filters-grid">
                        <div class="filter-group">
                            <label class="filter-label">Valor Min</label>
                            <input type="number" class="filter-input" id="valor-min-direitos" placeholder="Min">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Valor Max</label>
                            <input type="number" class="filter-input" id="valor-max-direitos" placeholder="Max">
                        </div>
                    </div>
                </div>
            </div>
            <div id="direitos-content"><div class="loading"><div class="loading-spinner"></div><div class="loading-text">A carregar direitos...</div></div></div>
            <div id="pagination-direitos" class="pagination" style="display: none;"></div>
        </div>

        <!-- Equipamentos Page -->
        <div id="equipamentos" class="page">
            <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <h2>Equipamentos</h2>
                    <p>Todos os equipamentos dispon√≠veis em leil√£o</p>
                </div>
                <button class="notification-toggle-btn" id="notify-btn-equipamentos" onclick="toggleQuickNotification('equipamentos', 3)" title="Ativar notifica√ß√µes para novos equipamentos">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="20" height="20">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                    </svg>
                    <span>Notificar</span>
                </button>
            </div>
            <div class="type-badges">
                <div class="type-badge lo" onclick="toggleTypeFilter('LO', this)"><span>LO</span><span>Leil√£o Online</span></div>
                <div class="type-badge np" onclick="toggleTypeFilter('NP', this)"><span>NP</span><span>Negocia√ß√£o Particular</span></div>
            </div>
            <div class="filters-bar filters-bar-compact">
                <div class="filters-main-row">
                    <div class="filters-inputs">
                        <div class="filter-search-wrapper">
                            <svg class="search-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                            <input type="text" class="filter-input filter-search" id="search-equipamentos" placeholder="Pesquisar...">
                        </div>
                        <select class="filter-select" id="sort-equipamentos" title="Ordenar">
                            <option value="">Ordenar...</option>
                            <option value="dataFim_asc">Data fim (proxima)</option>
                            <option value="dataFim_desc">Data fim (distante)</option>
                            <option value="valorBase_asc">Valor base (baixo)</option>
                            <option value="valorBase_desc">Valor base (alto)</option>
                            <option value="lanceAtual_desc">Lance atual (alto)</option>
                        </select>
                        <select class="filter-select" id="subtipo-equipamentos" title="Subtipo">
                            <option value="">Subtipo...</option>
                        </select>
                    </div>
                    <div class="filters-buttons">
                        <button class="btn-icon" onclick="toggleAdvancedFilters('equipamentos')" title="Filtros Avan√ßados" id="btn-advanced-equipamentos">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                            </svg>
                        </button>
                        <button class="btn-icon" onclick="reloadAllData('equipamentos')" title="Atualizar Tudo">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                        </button>
                        <button class="btn-icon" onclick="clearFilters('equipamentos')" title="Limpar Filtros">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="advanced-filters-content" id="advanced-filters-equipamentos">
                    <div class="advanced-filters-grid">
                        <div class="filter-group">
                            <label class="filter-label">Valor Min</label>
                            <input type="number" class="filter-input" id="valor-min-equipamentos" placeholder="Min">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Valor Max</label>
                            <input type="number" class="filter-input" id="valor-max-equipamentos" placeholder="Max">
                        </div>
                    </div>
                </div>
            </div>
            <div id="equipamentos-content"><div class="loading"><div class="loading-spinner"></div><div class="loading-text">A carregar equipamentos...</div></div></div>
            <div id="pagination-equipamentos" class="pagination" style="display: none;"></div>
        </div>

        <!-- Mobili√°rio Page -->
        <div id="mobiliario" class="page">
            <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <h2>Mobili√°rio</h2>
                    <p>Todo o mobili√°rio dispon√≠vel em leil√£o</p>
                </div>
                <button class="notification-toggle-btn" id="notify-btn-mobiliario" onclick="toggleQuickNotification('mobiliario', 4)" title="Ativar notifica√ß√µes para novo mobili√°rio">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="20" height="20">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                    </svg>
                    <span>Notificar</span>
                </button>
            </div>
            <div class="type-badges">
                <div class="type-badge lo" onclick="toggleTypeFilter('LO', this)"><span>LO</span><span>Leil√£o Online</span></div>
                <div class="type-badge np" onclick="toggleTypeFilter('NP', this)"><span>NP</span><span>Negocia√ß√£o Particular</span></div>
            </div>
            <div class="filters-bar filters-bar-compact">
                <div class="filters-main-row">
                    <div class="filters-inputs">
                        <div class="filter-search-wrapper">
                            <svg class="search-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                            <input type="text" class="filter-input filter-search" id="search-mobiliario" placeholder="Pesquisar...">
                        </div>
                        <select class="filter-select" id="sort-mobiliario" title="Ordenar">
                            <option value="">Ordenar...</option>
                            <option value="dataFim_asc">Data fim (proxima)</option>
                            <option value="dataFim_desc">Data fim (distante)</option>
                            <option value="valorBase_asc">Valor base (baixo)</option>
                            <option value="valorBase_desc">Valor base (alto)</option>
                            <option value="lanceAtual_desc">Lance atual (alto)</option>
                        </select>
                        <select class="filter-select" id="subtipo-mobiliario" title="Subtipo">
                            <option value="">Subtipo...</option>
                        </select>
                    </div>
                    <div class="filters-buttons">
                        <button class="btn-icon" onclick="toggleAdvancedFilters('mobiliario')" title="Filtros Avan√ßados" id="btn-advanced-mobiliario">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                            </svg>
                        </button>
                        <button class="btn-icon" onclick="reloadAllData('mobiliario')" title="Atualizar Tudo">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                        </button>
                        <button class="btn-icon" onclick="clearFilters('mobiliario')" title="Limpar Filtros">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="advanced-filters-content" id="advanced-filters-mobiliario">
                    <div class="advanced-filters-grid">
                        <div class="filter-group">
                            <label class="filter-label">Valor Min</label>
                            <input type="number" class="filter-input" id="valor-min-mobiliario" placeholder="Min">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Valor Max</label>
                            <input type="number" class="filter-input" id="valor-max-mobiliario" placeholder="Max">
                        </div>
                    </div>
                </div>
            </div>
            <div id="mobiliario-content"><div class="loading"><div class="loading-spinner"></div><div class="loading-text">A carregar mobili√°rio...</div></div></div>
            <div id="pagination-mobiliario" class="pagination" style="display: none;"></div>
        </div>

        <!-- M√°quinas Page -->
        <div id="maquinas" class="page">
            <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <h2>M√°quinas</h2>
                    <p>Todas as m√°quinas dispon√≠veis em leil√£o</p>
                </div>
                <button class="notification-toggle-btn" id="notify-btn-maquinas" onclick="toggleQuickNotification('maquinas', 5)" title="Ativar notifica√ß√µes para novas m√°quinas">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="20" height="20">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                    </svg>
                    <span>Notificar</span>
                </button>
            </div>
            <div class="type-badges">
                <div class="type-badge lo" onclick="toggleTypeFilter('LO', this)"><span>LO</span><span>Leil√£o Online</span></div>
                <div class="type-badge np" onclick="toggleTypeFilter('NP', this)"><span>NP</span><span>Negocia√ß√£o Particular</span></div>
            </div>
            <div class="filters-bar filters-bar-compact">
                <div class="filters-main-row">
                    <div class="filters-inputs">
                        <div class="filter-search-wrapper">
                            <svg class="search-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                            <input type="text" class="filter-input filter-search" id="search-maquinas" placeholder="Pesquisar...">
                        </div>
                        <select class="filter-select" id="sort-maquinas" title="Ordenar">
                            <option value="">Ordenar...</option>
                            <option value="dataFim_asc">Data fim (proxima)</option>
                            <option value="dataFim_desc">Data fim (distante)</option>
                            <option value="valorBase_asc">Valor base (baixo)</option>
                            <option value="valorBase_desc">Valor base (alto)</option>
                            <option value="lanceAtual_desc">Lance atual (alto)</option>
                        </select>
                        <select class="filter-select" id="subtipo-maquinas" title="Subtipo">
                            <option value="">Subtipo...</option>
                        </select>
                    </div>
                    <div class="filters-buttons">
                        <button class="btn-icon" onclick="toggleAdvancedFilters('maquinas')" title="Filtros Avan√ßados" id="btn-advanced-maquinas">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                            </svg>
                        </button>
                        <button class="btn-icon" onclick="reloadAllData('maquinas')" title="Atualizar Tudo">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                        </button>
                        <button class="btn-icon" onclick="clearFilters('maquinas')" title="Limpar Filtros">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="advanced-filters-content" id="advanced-filters-maquinas">
                    <div class="advanced-filters-grid">
                        <div class="filter-group">
                            <label class="filter-label">Valor Min</label>
                            <input type="number" class="filter-input" id="valor-min-maquinas" placeholder="Min">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Valor Max</label>
                            <input type="number" class="filter-input" id="valor-max-maquinas" placeholder="Max">
                        </div>
                    </div>
                </div>
            </div>
            <div id="maquinas-content"><div class="loading"><div class="loading-spinner"></div><div class="loading-text">A carregar m√°quinas...</div></div></div>
            <div id="pagination-maquinas" class="pagination" style="display: none;"></div>
        </div>

        <!-- ========== NOTIFICA√á√ïES PAGE ========== -->
        <div id="alertas" class="page">
            <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <h2>Notifica√ß√µes</h2>
                    <p>Gerencie as suas notifica√ß√µes e regras</p>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <span style="font-size: 13px; color: #64748b;" id="alertas-unread-count">0</span>
                    <span style="font-size: 12px; color: #94a3b8;">n√£o lidas</span>
                </div>
            </div>

            <!-- Tabs -->
            <div class="alertas-tabs" style="display: flex; gap: 0; margin-bottom: 24px; border-bottom: 2px solid #e2e8f0;">
                <button class="alertas-tab active" onclick="switchAlertasTab('notifications')" id="tab-notifications" style="padding: 12px 24px; background: none; border: none; border-bottom: 2px solid #3b82f6; margin-bottom: -2px; font-size: 14px; font-weight: 600; color: #3b82f6; cursor: pointer; transition: all 0.2s;">
                    Notifica√ß√µes
                </button>
                <button class="alertas-tab" onclick="switchAlertasTab('rules')" id="tab-rules" style="padding: 12px 24px; background: none; border: none; border-bottom: 2px solid transparent; margin-bottom: -2px; font-size: 14px; font-weight: 500; color: #64748b; cursor: pointer; transition: all 0.2s;">
                    Regras <span id="alertas-rules-count" style="background: #e2e8f0; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 6px;">0</span>
                </button>
            </div>

            <!-- Tab Content: Notifications -->
            <div id="tab-content-notifications" class="alertas-tab-content">
                <div style="display: flex; justify-content: flex-end; gap: 8px; margin-bottom: 16px;">
                    <button onclick="markAllNotificationsRead()" style="padding: 8px 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 12px; color: #64748b; cursor: pointer; transition: all 0.2s;">
                        Marcar todas lidas
                    </button>
                    <button onclick="deleteAllNotifications()" style="padding: 8px 16px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; font-size: 12px; color: #dc2626; cursor: pointer; transition: all 0.2s;">
                        Limpar todas
                    </button>
                </div>
                <div id="notifications-list" style="display: flex; flex-direction: column; gap: 8px;">
                    <div class="loading"><div class="loading-spinner"></div></div>
                </div>
            </div>

            <!-- Tab Content: Rules -->
            <div id="tab-content-rules" class="alertas-tab-content" style="display: none;">
                <div style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
                    <button class="btn-primary" onclick="showCreateRuleModal()" style="padding: 10px 20px; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="16" height="16">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                        </svg>
                        Nova Regra
                    </button>
                </div>
                <!-- Rules Table -->
                <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead>
                            <tr style="background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #374151;">Nome</th>
                                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #374151;">Tipo</th>
                                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #374151;">Filtros</th>
                                <th style="padding: 12px 16px; text-align: center; font-weight: 600; color: #374151;">Disparos</th>
                                <th style="padding: 12px 16px; text-align: center; font-weight: 600; color: #374151;">Estado</th>
                                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #374151;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="rules-table-body">
                            <tr><td colspan="6" style="padding: 40px; text-align: center; color: #94a3b8;">A carregar...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ========== FAVORITOS PAGE ========== -->
        <div id="favoritos" class="page">
            <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <h2>Favoritos</h2>
                    <p>Eventos que est√° a acompanhar</p>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <span style="font-size: 13px; color: #64748b;" id="favoritos-total-count">0</span>
                    <span style="font-size: 12px; color: #94a3b8;">eventos</span>
                </div>
            </div>

            <!-- Stats Cards -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                <div class="stats-card">
                    <div class="stats-card-value" id="fav-stat-total">0</div>
                    <div class="stats-card-label">Total Favoritos</div>
                </div>
                <div class="stats-card">
                    <div class="stats-card-value" id="fav-stat-active">0</div>
                    <div class="stats-card-label">Leil√µes Ativos</div>
                </div>
                <div class="stats-card">
                    <div class="stats-card-value" id="fav-stat-ending">0</div>
                    <div class="stats-card-label">A Terminar Hoje</div>
                </div>
                <div class="stats-card">
                    <div class="stats-card-value" id="fav-stat-changes">0</div>
                    <div class="stats-card-label">Altera√ß√µes Pre√ßo</div>
                </div>
            </div>

            <!-- Filters -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div style="display: flex; gap: 8px;">
                    <select id="fav-filter-status" onchange="loadFavoritosPage()" style="padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 12px; background: white;">
                        <option value="">Todos os estados</option>
                        <option value="active">Ativos</option>
                        <option value="ending">A terminar</option>
                        <option value="ended">Terminados</option>
                    </select>
                    <select id="fav-filter-sort" onchange="loadFavoritosPage()" style="padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 12px; background: white;">
                        <option value="created_desc">Mais recentes</option>
                        <option value="created_asc">Mais antigos</option>
                        <option value="ending_soon">A terminar primeiro</option>
                        <option value="price_asc">Pre√ßo: menor</option>
                        <option value="price_desc">Pre√ßo: maior</option>
                    </select>
                </div>
                <button onclick="checkFavoritesPrices()" style="padding: 8px 16px; background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; font-size: 12px; color: #166534; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="14" height="14">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Atualizar Pre√ßos
                </button>
            </div>

            <!-- Favorites List -->
            <div id="favoritos-list" style="display: flex; flex-direction: column; gap: 12px;">
                <div class="loading"><div class="loading-spinner"></div><div class="loading-text">A carregar favoritos...</div></div>
            </div>

            <!-- Empty State -->
            <div id="favoritos-empty" style="display: none; text-align: center; padding: 60px 20px;">
                <svg fill="none" stroke="#94a3b8" stroke-width="1.5" viewBox="0 0 24 24" width="64" height="64" style="margin: 0 auto 16px;">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                </svg>
                <h3 style="color: #64748b; font-weight: 500; margin-bottom: 8px;">Sem favoritos</h3>
                <p style="color: #94a3b8; font-size: 13px; margin-bottom: 16px;">Adicione eventos aos favoritos clicando na estrela</p>
                <button onclick="showPage('eventos')" class="btn-primary" style="padding: 10px 20px; font-size: 13px;">
                    Explorar Eventos
                </button>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settings" class="page">
            <div class="page-header">
                <h2>‚öôÔ∏è Defini√ß√µes</h2>
                <p>Configura√ß√µes do sistema</p>
            </div>

            <div style="display: flex; flex-direction: column; gap: 24px; max-width: 800px;">
                <!-- General Settings Section -->
                <div class="scraper-control-card">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                        <span style="font-size: 16px;">üîß</span>
                        <span style="font-weight: 600; color: #1e293b;">Configura√ß√µes Gerais</span>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <!-- API Endpoint -->
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: #f8fafc; border-radius: 8px;">
                            <div style="font-weight: 500; color: #1e293b; font-size: 12px;">API Endpoint</div>
                            <code style="padding: 4px 8px; background: #e2e8f0; border-radius: 4px; font-size: 11px; color: #334155;">localhost:8000</code>
                        </div>
                        <!-- Theme -->
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: #f8fafc; border-radius: 8px;">
                            <div style="font-weight: 500; color: #1e293b; font-size: 12px;">Tema</div>
                            <select style="padding: 4px 8px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 11px; background: white;">
                                <option value="light">Claro</option>
                                <option value="dark" disabled>Escuro</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Security Section -->
                <div class="scraper-control-card" style="background: linear-gradient(135deg, #fef3c7 0%, #fff 100%); border: 1px solid #fbbf24;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                        <span style="font-size: 16px;">üîê</span>
                        <span style="font-weight: 600; color: #92400e;">Seguran√ßa API</span>
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <!-- API Key Input -->
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <label style="font-weight: 500; color: #1e293b; font-size: 12px;">Chave de Autentica√ß√£o</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="password" id="api-auth-key-input"
                                    placeholder="Insira a chave API..."
                                    style="flex: 1; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 12px; font-family: monospace;">
                                <button onclick="toggleKeyVisibility()" style="padding: 10px 12px; background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer;" title="Mostrar/Esconder">
                                    üëÅÔ∏è
                                </button>
                                <button onclick="saveApiKey()" style="padding: 10px 16px; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; border-radius: 8px; font-weight: 500; font-size: 12px; cursor: pointer;">
                                    üíæ Guardar
                                </button>
                            </div>
                        </div>

                        <!-- Status -->
                        <div id="api-auth-status" style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: #f8fafc; border-radius: 8px;">
                            <span id="api-auth-indicator" style="width: 8px; height: 8px; border-radius: 50%; background: #94a3b8;"></span>
                            <span id="api-auth-text" style="font-size: 11px; color: #64748b;">Chave n√£o configurada</span>
                        </div>

                        <!-- Info -->
                        <div style="padding: 10px; background: #fffbeb; border-radius: 8px; font-size: 11px; color: #92400e;">
                            üí° A chave √© necess√°ria para opera√ß√µes de escrita (scrapers, pipelines, etc.). A chave √© guardada no localStorage do browser.
                        </div>
                    </div>
                </div>

                <!-- Browser Extensions Section -->
                <div class="scraper-control-card" style="background: linear-gradient(135deg, #f0f9ff 0%, #fff 100%); border: 1px solid #bae6fd;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                        <span style="font-size: 16px;">üß©</span>
                        <span style="font-weight: 600; color: #0369a1;">Extens√µes Browser</span>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <!-- Chrome Extension -->
                        <div style="padding: 16px; background: white; border-radius: 12px; border: 1px solid #e0f2fe; text-align: center;">
                            <div style="width: 48px; height: 48px; margin: 0 auto 12px; background: linear-gradient(135deg, #4285f4, #1a73e8); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                                    <circle cx="12" cy="12" r="10" fill="none" stroke="white" stroke-width="2"/>
                                    <circle cx="12" cy="12" r="4" fill="white"/>
                                </svg>
                            </div>
                            <div style="font-weight: 600; color: #1e293b; font-size: 14px; margin-bottom: 4px;">Chrome Extension</div>
                            <div style="font-size: 11px; color: #64748b; margin-bottom: 12px;">Extens√£o nativa Manifest V3</div>
                            <a href="https://github.com/nunomansilhas/better-e-leiloes/tree/main/chrome-extension" target="_blank" style="display: inline-block; padding: 8px 16px; background: linear-gradient(135deg, #4285f4, #1a73e8); color: white; border-radius: 8px; font-size: 12px; font-weight: 500; text-decoration: none; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                üì• Download
                            </a>
                        </div>

                        <!-- Tampermonkey Script -->
                        <div style="padding: 16px; background: white; border-radius: 12px; border: 1px solid #e0f2fe; text-align: center;">
                            <div style="width: 48px; height: 48px; margin: 0 auto 12px; background: linear-gradient(135deg, #00485B, #006d75); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <span style="font-size: 24px;">üêí</span>
                            </div>
                            <div style="font-weight: 600; color: #1e293b; font-size: 14px; margin-bottom: 4px;">Tampermonkey Script</div>
                            <div style="font-size: 11px; color: #64748b; margin-bottom: 12px;">Userscript para Tampermonkey</div>
                            <a href="https://raw.githubusercontent.com/nunomansilhas/better-e-leiloes/main/betterE-Leiloes-CardEnhancer.user.js" target="_blank" style="display: inline-block; padding: 8px 16px; background: linear-gradient(135deg, #00485B, #006d75); color: white; border-radius: 8px; font-size: 12px; font-weight: 500; text-decoration: none; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                üì• Instalar
                            </a>
                        </div>
                    </div>

                    <div style="margin-top: 12px; padding: 10px; background: #f0f9ff; border-radius: 8px; font-size: 11px; color: #0369a1; text-align: center;">
                        üí° As extens√µes melhoram os cards no site e-leiloes.pt com carrossel, pre√ßos e countdown
                    </div>
                </div>

                <!-- Data Management Section -->
                <div class="scraper-control-card">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                        <span style="font-size: 16px;">üíæ</span>
                        <span style="font-weight: 600; color: #1e293b;">Gest√£o de Dados</span>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <!-- Export Data -->
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: #f8fafc; border-radius: 8px;">
                            <div style="font-weight: 500; color: #1e293b; font-size: 12px;">Exportar JSON</div>
                            <button onclick="exportAllData()" style="padding: 6px 12px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; border-radius: 6px; font-size: 11px; font-weight: 500; cursor: pointer;">
                                üì• Export
                            </button>
                        </div>
                        <!-- Clear Cache -->
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: #f8fafc; border-radius: 8px;">
                            <div style="font-weight: 500; color: #1e293b; font-size: 12px;">Limpar Cache</div>
                            <button onclick="clearCache()" style="padding: 6px 12px; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; border-radius: 6px; font-size: 11px; font-weight: 500; cursor: pointer;">
                                üóëÔ∏è Limpar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="scraper-control-card" style="border: 2px solid #fecaca; background: linear-gradient(135deg, #fef2f2 0%, #fff 100%);">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                        <span style="font-size: 16px;">‚ö†Ô∏è</span>
                        <span style="font-weight: 600; color: #dc2626;">Zona de Perigo</span>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <!-- Delete All Events -->
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: white; border: 1px solid #fecaca; border-radius: 8px;">
                            <div style="font-weight: 500; color: #991b1b; font-size: 12px;">Apagar Eventos</div>
                            <button onclick="confirmClearDatabase()" style="padding: 6px 12px; background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; border: none; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; white-space: nowrap;">
                                üóëÔ∏è Limpar BD
                            </button>
                        </div>
                        <!-- Delete All Notifications -->
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: white; border: 1px solid #fecaca; border-radius: 8px;">
                            <div style="font-weight: 500; color: #991b1b; font-size: 12px;">Apagar Notifica√ß√µes</div>
                            <button onclick="confirmDeleteAllNotifications()" style="padding: 6px 12px; background: linear-gradient(135deg, #f87171, #ef4444); color: white; border: none; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; white-space: nowrap;">
                                üîî Limpar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Rule Modal - Modern Design -->
        <div id="create-rule-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 9999; justify-content: center; align-items: center;">
            <div style="background: white; border-radius: 20px; width: 90%; max-width: 480px; box-shadow: 0 25px 80px rgba(0, 0, 0, 0.25); overflow: hidden; animation: slideIn 0.3s ease;">
                <!-- Header -->
                <div style="padding: 24px 28px 20px; border-bottom: 1px solid #f1f5f9;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <svg fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24" width="20" height="20">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                                </svg>
                            </div>
                            <div>
                                <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #0f172a;">Nova Regra</h3>
                                <p style="margin: 2px 0 0; font-size: 13px; color: #64748b;">Configure as notifica√ß√µes</p>
                            </div>
                        </div>
                        <button onclick="closeCreateRuleModal()" style="background: #f1f5f9; border: none; width: 36px; height: 36px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                            <svg fill="none" stroke="#64748b" stroke-width="2" viewBox="0 0 24 24" width="18" height="18">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Body -->
                <div style="padding: 24px 28px;">
                    <!-- Nome -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">Nome da regra</label>
                        <input type="text" id="rule-name" placeholder="Ex: Apartamentos em Lisboa" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px; transition: all 0.2s; outline: none; box-sizing: border-box;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e5e7eb'">
                    </div>

                    <!-- Tipo de Alerta -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">Tipo de alerta</label>
                        <div style="display: flex; gap: 10px;">
                            <label style="flex: 1; display: flex; align-items: center; gap: 10px; padding: 14px; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.2s;" onclick="this.querySelector('input').checked = true; document.querySelectorAll('.rule-type-option').forEach(el => el.style.borderColor = '#e5e7eb'); this.style.borderColor = '#3b82f6'; this.style.background = '#eff6ff';" class="rule-type-option">
                                <input type="radio" name="rule-type-radio" value="new_event" checked style="display: none;">
                                <span style="font-size: 20px;">üÜï</span>
                                <span style="font-size: 13px; font-weight: 500;">Novo Evento</span>
                            </label>
                            <label style="flex: 1; display: flex; align-items: center; gap: 10px; padding: 14px; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.2s;" onclick="this.querySelector('input').checked = true; document.querySelectorAll('.rule-type-option').forEach(el => { el.style.borderColor = '#e5e7eb'; el.style.background = 'white'; }); this.style.borderColor = '#3b82f6'; this.style.background = '#eff6ff';" class="rule-type-option">
                                <input type="radio" name="rule-type-radio" value="price_change" style="display: none;">
                                <span style="font-size: 20px;">üí∞</span>
                                <span style="font-size: 13px; font-weight: 500;">Altera√ß√£o Pre√ßo</span>
                            </label>
                        </div>
                    </div>

                    <!-- Tipos de Evento -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 10px;">Tipos de evento</label>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                            <label class="tipo-chip" style="display: flex; align-items: center; justify-content: center; gap: 6px; padding: 10px; background: #f8fafc; border: 2px solid transparent; border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 12px; font-weight: 500; color: #64748b;">
                                <input type="checkbox" class="rule-tipo" value="1" style="display: none;" onchange="this.parentElement.style.background = this.checked ? '#dbeafe' : '#f8fafc'; this.parentElement.style.borderColor = this.checked ? '#3b82f6' : 'transparent'; this.parentElement.style.color = this.checked ? '#1d4ed8' : '#64748b';">
                                üè† Im√≥veis
                            </label>
                            <label class="tipo-chip" style="display: flex; align-items: center; justify-content: center; gap: 6px; padding: 10px; background: #f8fafc; border: 2px solid transparent; border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 12px; font-weight: 500; color: #64748b;">
                                <input type="checkbox" class="rule-tipo" value="2" style="display: none;" onchange="this.parentElement.style.background = this.checked ? '#dbeafe' : '#f8fafc'; this.parentElement.style.borderColor = this.checked ? '#3b82f6' : 'transparent'; this.parentElement.style.color = this.checked ? '#1d4ed8' : '#64748b';">
                                üöó Ve√≠culos
                            </label>
                            <label class="tipo-chip" style="display: flex; align-items: center; justify-content: center; gap: 6px; padding: 10px; background: #f8fafc; border: 2px solid transparent; border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 12px; font-weight: 500; color: #64748b;">
                                <input type="checkbox" class="rule-tipo" value="6" style="display: none;" onchange="this.parentElement.style.background = this.checked ? '#dbeafe' : '#f8fafc'; this.parentElement.style.borderColor = this.checked ? '#3b82f6' : 'transparent'; this.parentElement.style.color = this.checked ? '#1d4ed8' : '#64748b';">
                                üìú Direitos
                            </label>
                            <label class="tipo-chip" style="display: flex; align-items: center; justify-content: center; gap: 6px; padding: 10px; background: #f8fafc; border: 2px solid transparent; border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 12px; font-weight: 500; color: #64748b;">
                                <input type="checkbox" class="rule-tipo" value="3" style="display: none;" onchange="this.parentElement.style.background = this.checked ? '#dbeafe' : '#f8fafc'; this.parentElement.style.borderColor = this.checked ? '#3b82f6' : 'transparent'; this.parentElement.style.color = this.checked ? '#1d4ed8' : '#64748b';">
                                üîß Equipam.
                            </label>
                            <label class="tipo-chip" style="display: flex; align-items: center; justify-content: center; gap: 6px; padding: 10px; background: #f8fafc; border: 2px solid transparent; border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 12px; font-weight: 500; color: #64748b;">
                                <input type="checkbox" class="rule-tipo" value="4" style="display: none;" onchange="this.parentElement.style.background = this.checked ? '#dbeafe' : '#f8fafc'; this.parentElement.style.borderColor = this.checked ? '#3b82f6' : 'transparent'; this.parentElement.style.color = this.checked ? '#1d4ed8' : '#64748b';">
                                ü™ë Mobili√°rio
                            </label>
                            <label class="tipo-chip" style="display: flex; align-items: center; justify-content: center; gap: 6px; padding: 10px; background: #f8fafc; border: 2px solid transparent; border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 12px; font-weight: 500; color: #64748b;">
                                <input type="checkbox" class="rule-tipo" value="5" style="display: none;" onchange="this.parentElement.style.background = this.checked ? '#dbeafe' : '#f8fafc'; this.parentElement.style.borderColor = this.checked ? '#3b82f6' : 'transparent'; this.parentElement.style.color = this.checked ? '#1d4ed8' : '#64748b';">
                                ‚öôÔ∏è M√°quinas
                            </label>
                        </div>
                    </div>

                    <!-- Distritos -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">Distritos <span style="font-weight: 400; color: #94a3b8;">(opcional)</span></label>
                        <input type="text" id="rule-distritos" placeholder="Ex: Lisboa, Porto, Set√∫bal" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px; transition: all 0.2s; outline: none; box-sizing: border-box;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e5e7eb'">
                    </div>

                    <!-- Pre√ßos -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <label style="display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">Pre√ßo m√≠n <span style="font-weight: 400; color: #94a3b8;">‚Ç¨</span></label>
                            <input type="number" id="rule-preco-min" placeholder="0" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px; transition: all 0.2s; outline: none; box-sizing: border-box;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e5e7eb'">
                        </div>
                        <div>
                            <label style="display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">Pre√ßo m√°x <span style="font-weight: 400; color: #94a3b8;">‚Ç¨</span></label>
                            <input type="number" id="rule-preco-max" placeholder="Sem limite" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px; transition: all 0.2s; outline: none; box-sizing: border-box;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e5e7eb'">
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div style="padding: 20px 28px; background: #f8fafc; border-top: 1px solid #f1f5f9; display: flex; justify-content: flex-end; gap: 12px;">
                    <button onclick="closeCreateRuleModal()" style="padding: 12px 24px; background: white; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px; font-weight: 600; color: #64748b; cursor: pointer; transition: all 0.2s;">
                        Cancelar
                    </button>
                    <button onclick="createNotificationRule()" style="padding: 12px 24px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border: none; border-radius: 10px; font-size: 14px; font-weight: 600; color: white; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px;">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="16" height="16">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                        </svg>
                        Criar Regra
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dynamic API base - works from any host/port
        const API_BASE = window.location.origin;
        // Backend URL for scraping/refresh operations (defaults to same origin, configure if different)
        const BACKEND_URL = window.BACKEND_URL || API_BASE;

        // ============== THEME MANAGEMENT ==============

        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
        }

        function applyTheme(theme) {
            const html = document.documentElement;
            const lightIcon = document.getElementById('theme-icon-light');
            const darkIcon = document.getElementById('theme-icon-dark');
            const themeText = document.getElementById('theme-text');

            if (theme === 'dark') {
                html.setAttribute('data-theme', 'dark');
                if (lightIcon) lightIcon.style.display = 'none';
                if (darkIcon) darkIcon.style.display = 'block';
                if (themeText) themeText.textContent = 'Modo Claro';
            } else {
                html.removeAttribute('data-theme');
                if (lightIcon) lightIcon.style.display = 'block';
                if (darkIcon) darkIcon.style.display = 'none';
                if (themeText) themeText.textContent = 'Modo Escuro';
            }
        }

        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        }

        // Initialize theme immediately to prevent flash
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();

        // ============== Mobile Menu ==============
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            const menuBtn = document.getElementById('mobile-menu-btn');

            const isOpen = sidebar.classList.contains('mobile-open');

            if (isOpen) {
                closeMobileMenu();
            } else {
                sidebar.classList.add('mobile-open');
                overlay.classList.add('active');
                menuBtn.classList.add('active');
            }
        }

        function closeMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            const menuBtn = document.getElementById('mobile-menu-btn');

            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
            menuBtn.classList.remove('active');
        }

        // ============== FAVORITES CACHE (from /api/favorites) ==============
        // Must be declared before FAVORITES object which uses getFavoritesFromCache
        let favoritesCache = null;
        let favoritesCacheTime = 0;
        const FAVORITES_CACHE_TTL = 60000; // 1 minute cache

        async function getFavoritesFromCache(forceRefresh = false) {
            const now = Date.now();
            if (!forceRefresh && favoritesCache && (now - favoritesCacheTime) < FAVORITES_CACHE_TTL) {
                return favoritesCache;
            }

            try {
                const response = await fetch(`${API_BASE}/api/favorites`);
                favoritesCache = await response.json();
                favoritesCacheTime = now;
                return favoritesCache;
            } catch (error) {
                console.error('Error fetching favorites:', error);
                return favoritesCache || [];
            }
        }

        function updateFavoritesCacheEntry(reference, add) {
            if (!favoritesCache) return;
            if (add) {
                if (!favoritesCache.some(f => f.event_reference === reference)) {
                    favoritesCache.push({ event_reference: reference });
                }
            } else {
                favoritesCache = favoritesCache.filter(f => f.event_reference !== reference);
            }
        }

        // ============== FAVORITES MANAGEMENT (uses notification rules from DB) ==============

        const FAVORITES = {
            // Cache of notification rules (event-specific only)
            _cache: [],
            _cacheTime: 0,
            _cacheTTL: 60000, // 60 seconds (WebSocket handles real-time updates)
            _allRulesCache: [], // Cache for all rules (used by updateNotificationIcons)
            _pendingRequest: null, // Prevent duplicate simultaneous requests

            async getAll() {
                // Use cache if fresh
                if (Date.now() - this._cacheTime < this._cacheTTL && this._cache.length > 0) {
                    return this._cache;
                }

                // If request already in-flight, wait for it
                if (this._pendingRequest) {
                    await this._pendingRequest;
                    return this._cache;
                }

                // Make request and store promise
                this._pendingRequest = (async () => {
                    try {
                        const response = await fetch(`${API_BASE}/api/notification-rules`);
                        const rules = await response.json();
                        this._allRulesCache = Array.isArray(rules) ? rules : [];
                        // Filter only event-specific rules (favorites)
                        this._cache = this._allRulesCache.filter(r => r.event_reference && r.active);
                        this._cacheTime = Date.now();
                    } catch (err) {
                        console.error('Error fetching favorites:', err);
                    } finally {
                        this._pendingRequest = null;
                    }
                })();

                await this._pendingRequest;
                return this._cache;
            },

            // Get all rules (including non-event-specific) from cache
            async getAllRules() {
                if (Date.now() - this._cacheTime < this._cacheTTL && this._allRulesCache.length > 0) {
                    return this._allRulesCache;
                }
                await this.getAll(); // This populates _allRulesCache
                return this._allRulesCache;
            },

            async add(reference, eventData = {}) {
                try {
                    const ruleData = {
                        name: eventData.titulo ? `Evento: ${eventData.titulo.substring(0, 50)}` : `Evento: ${reference}`,
                        rule_type: 'price_change',
                        event_reference: reference,
                        active: true
                    };
                    const response = await fetch(`${API_BASE}/api/notification-rules`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(ruleData)
                    });
                    if (response.ok) {
                        // Optimistically add to cache immediately
                        if (!this._cache.some(r => r.event_reference === reference)) {
                            this._cache.push({ event_reference: reference, active: true });
                        }
                        // Update buttons IMMEDIATELY after cache update (sync)
                        updateEndingSoonFavoriteButtons();
                        this._cacheTime = 0; // Mark for refresh on next getAll
                        if (typeof invalidateRulesCountCache === 'function') invalidateRulesCountCache();
                        this.updateWidget();
                        updateNotificationIcons();
                        showToast('Favorito adicionado', `${reference} foi adicionado aos favoritos`, 'success');
                    }
                } catch (err) {
                    console.error('Error adding favorite:', err);
                    showToast('Erro', 'N√£o foi poss√≠vel adicionar aos favoritos', 'error');
                }
            },

            async remove(reference) {
                try {
                    const rules = await this.getAll();
                    const rule = rules.find(r => r.event_reference === reference);
                    if (rule) {
                        const response = await fetch(`${API_BASE}/api/notification-rules/${rule.id}`, {
                            method: 'DELETE'
                        });
                        if (response.ok) {
                            // Optimistically remove from cache immediately
                            this._cache = this._cache.filter(r => r.event_reference !== reference);
                            // Update buttons IMMEDIATELY after cache update (sync)
                            updateEndingSoonFavoriteButtons();
                            this._cacheTime = 0; // Mark for refresh on next getAll
                            if (typeof invalidateRulesCountCache === 'function') invalidateRulesCountCache();
                            this.updateWidget();
                            updateNotificationIcons();
                            showToast('Favorito removido', `${reference} foi removido dos favoritos`, 'info');
                        }
                    }
                } catch (err) {
                    console.error('Error removing favorite:', err);
                    showToast('Erro', 'N√£o foi poss√≠vel remover dos favoritos', 'error');
                }
            },

            async toggle(reference, eventData = {}) {
                if (await this.isFavorite(reference)) {
                    return this.remove(reference);
                } else {
                    return this.add(reference, eventData);
                }
            },

            async isFavorite(reference) {
                const rules = await this.getAll();
                return rules.some(r => r.event_reference === reference);
            },

            // Synchronous check - uses cache only (for use in templates)
            isFavoriteSync(reference) {
                return this._cache.some(r => r.event_reference === reference);
            },

            async updateWidget() {
                const container = document.getElementById('favorites-widget-content');
                if (!container) return;

                // Use /api/favorites endpoint (not notification-rules)
                const favorites = await getFavoritesFromCache();
                const count = document.getElementById('favorites-count');
                if (count) count.textContent = favorites.length;

                if (favorites.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #94a3b8; width: 100%;">
                            <div style="font-size: 24px; margin-bottom: 8px;">üîî</div>
                            <div style="font-size: 11px;">Sem favoritos</div>
                            <div style="font-size: 10px; color: #cbd5e1; margin-top: 4px;">Clique no üîî nos eventos para adicionar aos favoritos</div>
                        </div>
                    `;
                    return;
                }

                // Get event references from favorites (notification rules)
                const refs = favorites.map(f => f.event_reference);
                let eventsData = {};

                try {
                    const response = await fetch(`${API_BASE}/api/events?limit=500&active_only=false`);
                    const data = await response.json();
                    if (data.events) {
                        data.events.forEach(e => {
                            if (refs.includes(e.reference)) {
                                eventsData[e.reference] = e;
                            }
                        });
                    }
                } catch (err) {
                    console.error('Error fetching favorites data:', err);
                }

                // Build carousel cards similar to "Novos Eventos"
                container.innerHTML = favorites.map(fav => {
                    const event = eventsData[fav.event_reference];
                    if (!event) {
                        // Event not found in DB, show minimal card
                        return `
                            <div style="min-width: 180px; max-width: 180px; background: #f8fafc; border-radius: 8px; padding: 12px; border: 1px solid #e2e8f0;">
                                <div style="font-size: 11px; font-weight: 600; color: #1e293b;">${fav.event_reference}</div>
                                <div style="font-size: 10px; color: #94a3b8; margin-top: 4px;">Dados n√£o dispon√≠veis</div>
                                <button onclick="event.stopPropagation(); FAVORITES.remove('${fav.event_reference}');" style="margin-top: 8px; background: #fee2e2; border: none; border-radius: 4px; padding: 4px 8px; font-size: 10px; color: #dc2626; cursor: pointer;">Remover</button>
                            </div>
                        `;
                    }

                    const tipoEmoji = {1: 'üè†', 2: 'üöó', 3: 'üîß', 4: 'ü™ë', 5: '‚öôÔ∏è', 6: 'üìú'}[event.tipo_id] || 'üì¶';
                    const lance = event.lance_atual ? `‚Ç¨${Number(event.lance_atual).toLocaleString('pt-PT')}` : '-';
                    const dataFim = event.data_fim ? getTimeLeftShort(new Date(event.data_fim)) : '-';
                    const isActive = event.ativo !== false && !event.terminado;
                    const capa = event.capa || '';
                    const titulo = event.titulo || event.reference;

                    return `
                        <div style="min-width: 200px; max-width: 200px; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid ${isActive ? '#e2e8f0' : '#fecaca'}; cursor: pointer; transition: all 0.2s;" onclick="openEventModal('${event.reference}')" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='none'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'">
                            <div style="height: 100px; background: ${capa ? `url('${capa}') center/cover` : 'linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%)'}; position: relative;">
                                <div style="position: absolute; top: 6px; left: 6px; background: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; display: flex; align-items: center; gap: 4px;">
                                    ${tipoEmoji} ${event.reference}
                                </div>
                                <div style="position: absolute; top: 6px; right: 6px; background: ${isActive ? '#3b82f6' : '#ef4444'}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 600;">
                                    ${isActive ? dataFim : 'Terminado'}
                                </div>
                                <button onclick="event.stopPropagation(); FAVORITES.remove('${event.reference}');" style="position: absolute; bottom: 6px; right: 6px; background: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 3px rgba(0,0,0,0.2);" title="Remover dos favoritos">üîî</button>
                            </div>
                            <div style="padding: 8px;">
                                <div style="font-size: 10px; color: #64748b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${titulo.substring(0, 40)}${titulo.length > 40 ? '...' : ''}</div>
                                <div style="font-size: 13px; font-weight: 700; color: #1e293b; margin-top: 4px;">${lance}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        };

        async function toggleFavorite(reference, eventData = {}) {
            await FAVORITES.toggle(reference, eventData);
            // Icons are updated by updateNotificationIcons() called in FAVORITES.add/remove
            // Also update the star buttons in "A Terminar em Breve" (cache is updated optimistically)
            updateEndingSoonFavoriteButtons();
        }

        // Update favorite star buttons in the "A Terminar em Breve" section
        async function updateEndingSoonFavoriteButtons() {
            const buttons = document.querySelectorAll('button[data-favorite-ref]');
            // Use favoritesCache (from /api/favorites) - same as updateFavoriteStars
            const favorites = await getFavoritesFromCache();
            const favReferences = new Set(favorites.map(f => f.event_reference));

            buttons.forEach(btn => {
                const ref = btn.dataset.favoriteRef;
                const isFav = favReferences.has(ref);
                btn.innerHTML = isFav ? '‚≠ê' : '‚òÜ';
                btn.style.color = isFav ? '#f59e0b' : '#cbd5e1';
                btn.title = isFav ? 'Remover dos favoritos' : 'Adicionar aos favoritos';
            });
        }

        // ============== PRICE CHANGE CHECKER ==============

        // Check for price changes on watched events and create notifications
        async function checkForPriceChanges() {
            try {
                // Call the backend to check for price changes and create notifications
                const response = await fetch(`${API_BASE}/api/notifications/check-prices`, { method: 'POST' });
                const result = await response.json();

                if (result.notifications_created > 0) {
                    // Fetch and show new notifications
                    const notifsResponse = await fetch(`${API_BASE}/api/notifications?limit=10`);
                    const notifications = await notifsResponse.json();

                    // Show toasts for unread notifications
                    const unreadNotifs = notifications.filter(n => !n.read && n.notification_type === 'price_change');
                    unreadNotifs.slice(0, 3).forEach(n => {
                        const diff = n.preco_atual - n.preco_anterior;
                        const diffStr = diff > 0 ? `+‚Ç¨${diff.toLocaleString('pt-PT')}` : `-‚Ç¨${Math.abs(diff).toLocaleString('pt-PT')}`;
                        showToast(
                            `üí∞ Pre√ßo alterado: ${n.event_reference}`,
                            `Novo lance: ‚Ç¨${n.preco_atual.toLocaleString('pt-PT')} (${diffStr})`,
                            'warning',
                            8000
                        );
                    });

                    // Update notification badge
                    updateNotificationBadge();
                }
            } catch (err) {
                console.error('Error checking for price changes:', err);
            }
        }

        // ============== SECURITY: HMAC Authentication ==============

        const API_AUTH = {
            secretKey: null,

            setKey(key) {
                this.secretKey = key;
                localStorage.setItem('api_auth_key', key);
                console.log('üîê API Auth: Key configured');
            },

            clearKey() {
                this.secretKey = null;
                localStorage.removeItem('api_auth_key');
                console.log('üîê API Auth: Key cleared');
            },

            async generateSignature(method, path, body = '') {
                if (!this.secretKey) return null;

                const timestamp = Math.floor(Date.now() / 1000).toString();
                const message = timestamp + method.toUpperCase() + path + body;

                const encoder = new TextEncoder();
                const keyData = encoder.encode(this.secretKey);
                const messageData = encoder.encode(message);

                const cryptoKey = await crypto.subtle.importKey(
                    'raw', keyData, { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']
                );

                const signature = await crypto.subtle.sign('HMAC', cryptoKey, messageData);
                const hashArray = Array.from(new Uint8Array(signature));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

                return { signature: hashHex, timestamp };
            }
        };

        // Authenticated fetch wrapper - automatically adds HMAC headers for mutations
        async function authFetch(url, options = {}) {
            const method = options.method || 'GET';
            const path = new URL(url, window.location.origin).pathname;
            const body = options.body || '';

            // Add auth headers for non-GET requests if key is set
            if (method.toUpperCase() !== 'GET' && API_AUTH.secretKey) {
                const auth = await API_AUTH.generateSignature(method, path, body);
                if (auth) {
                    options.headers = {
                        ...options.headers,
                        'X-Signature': auth.signature,
                        'X-Timestamp': auth.timestamp
                    };
                }
            }

            return fetch(url, options);
        }

        // Initialize auth key from localStorage
        (function initAuth() {
            const savedKey = localStorage.getItem('api_auth_key');
            if (savedKey) {
                API_AUTH.secretKey = savedKey;
                console.log('üîê API Auth: Key loaded from storage');
            }
        })();

        // ============== END SECURITY ==============

        // Normalize event data - handles both old nested and new flat model formats
        function normalizeEvent(event) {
            // Check if already in old format (has nested objects)
            if (event.valores && event.detalhes) {
                return event; // Already normalized
            }

            // Transform new flat format to old nested format for frontend compatibility
            const tipoIdToEvento = {
                1: 'imoveis', 2: 'veiculos', 3: 'equipamentos',
                4: 'mobiliario', 5: 'maquinas', 6: 'direitos'
            };

            // Extract images from fotos array
            let imagens = [];
            if (event.fotos && Array.isArray(event.fotos)) {
                imagens = event.fotos.map(f => {
                    if (!f) return null;
                    if (typeof f === 'string') return f;
                    return f.image || f.url || null;
                }).filter(Boolean);
            }

            return {
                reference: event.reference,
                tipoId: event.tipo_id,
                tipoEvento: tipoIdToEvento[event.tipo_id] || 'imoveis',
                titulo: event.titulo,
                capa: event.capa,
                valores: {
                    valorBase: event.valor_base,
                    valorAbertura: event.valor_abertura,
                    valorMinimo: event.valor_minimo,
                    lanceAtual: event.lance_atual || 0
                },
                gps: (event.latitude && event.longitude) ? {
                    latitude: event.latitude,
                    longitude: event.longitude
                } : null,
                detalhes: {
                    tipo: event.tipo || 'N/A',
                    subtipo: event.subtipo || 'N/A',
                    tipologia: event.tipologia,
                    areaPrivativa: event.area_privativa,
                    areaDependente: event.area_dependente,
                    areaTotal: event.area_total,
                    distrito: event.distrito,
                    concelho: event.concelho,
                    freguesia: event.freguesia,
                    morada: event.morada,
                    matricula: event.matricula
                },
                processo: {
                    numero: event.processo_numero,
                    tribunal: event.processo_tribunal,
                    comarca: event.processo_comarca
                },
                dataInicio: event.data_inicio,
                dataFim: event.data_fim,
                imagens: imagens,
                descricao: event.descricao,
                observacoes: event.observacoes,
                cancelado: event.cancelado || false,
                terminado: event.terminado || false,
                ativo: event.ativo !== undefined ? event.ativo : true,
                // New fields from API
                gestor_nome: event.gestor_nome,
                gestor_email: event.gestor_email
            };
        }

        // Normalize array of events
        function normalizeEvents(events) {
            return events.map(normalizeEvent);
        }

        let currentPageData = { imoveis: 1, veiculos: 1, direitos: 1, equipamentos: 1, mobiliario: 1, maquinas: 1 };
        let totalPagesData = { imoveis: 1, veiculos: 1, direitos: 1, equipamentos: 1, mobiliario: 1, maquinas: 1 };
        let allDistritos = new Set();
        let allSubtipos = new Set();
        let allTipologias = new Set();
        let activeTypeFilter = null;
        let allLoadedEvents = {
            imoveis: [],
            veiculos: [],
            direitos: [],
            equipamentos: [],
            mobiliario: [],
            maquinas: []
        }; // Store all loaded events

        // Inspection modal state
        let inspectionCurrentEvent = null;
        let inspectionCurrentIndex = 0;

        // Toggle advanced filters
        function toggleAdvancedFilters(type) {
            const btn = document.getElementById(`btn-advanced-${type}`);
            const content = document.getElementById(`advanced-filters-${type}`);
            if (content) {
                content.classList.toggle('open');
            }
            if (btn) {
                btn.classList.toggle('active');
            }
        }

        // Update subtipo filter
        function updateSubtipoFilter() {
            const select = document.getElementById('subtipo-imoveis');
            if (!select) return;

            const currentValue = select.value;
            select.innerHTML = '<option value="">Todos os subtipos</option>';

            const sortedSubtipos = Array.from(allSubtipos).sort();
            sortedSubtipos.forEach(subtipo => {
                if (subtipo && subtipo !== 'N/A') {
                    const option = document.createElement('option');
                    option.value = subtipo;
                    option.textContent = subtipo;
                    select.appendChild(option);
                }
            });

            if (currentValue) {
                select.value = currentValue;
            }
        }

        // Update tipologia filter
        function updateTipologiaFilter() {
            const select = document.getElementById('tipologia-imoveis');
            if (!select) return;

            const currentValue = select.value;
            select.innerHTML = '<option value="">Todas as tipologias</option>';

            const sortedTipologias = Array.from(allTipologias).sort();
            sortedTipologias.forEach(tipologia => {
                if (tipologia) {
                    const option = document.createElement('option');
                    option.value = tipologia;
                    option.textContent = tipologia;
                    select.appendChild(option);
                }
            });

            if (currentValue) {
                select.value = currentValue;
            }
        }

        // Inspection Modal Functions
        async function openInspectionModal(reference) {
            const type = document.querySelector('.page.active')?.id;

            // Check cache based on page type
            let event = null;
            if (type === 'eventos') {
                event = allEventsCached.find(e => e.reference === reference);
            } else {
                event = allLoadedEvents[type]?.find(e => e.reference === reference);
            }

            // If not found in loaded events, fetch from API (always fetch to get full fotos)
            if (!event || !event.imagens || event.imagens.length === 0) {
                try {
                    const response = await fetch(`${API_BASE}/api/events/${reference}`);
                    if (!response.ok) throw new Error('Event not found');
                    const apiEvent = await response.json();

                    // Extract images from fotos array (API returns strings or {image, thumbnail} objects)
                    let imagens = [];
                    if (apiEvent.fotos && Array.isArray(apiEvent.fotos)) {
                        imagens = apiEvent.fotos.map(f => {
                            if (typeof f === 'string') return f;
                            if (f && typeof f === 'object') return f.image || f.thumbnail || f.url;
                            return null;
                        }).filter(Boolean);
                    }
                    if (imagens.length === 0 && apiEvent.capa) {
                        imagens = [apiEvent.capa];
                    }

                    // Convert API response to expected format with ALL fields
                    event = {
                        reference: apiEvent.reference,
                        titulo: apiEvent.titulo,
                        imagens: imagens,
                        capa: apiEvent.capa,
                        tipoId: apiEvent.tipo_id,
                        tipoEvento: apiEvent.tipo_id === 1 ? 'imoveis' : (apiEvent.tipo_id === 2 ? 'veiculos' : 'outros'),
                        detalhes: {
                            tipo: apiEvent.tipo,
                            subtipo: apiEvent.subtipo,
                            tipologia: apiEvent.tipologia,
                            distrito: apiEvent.distrito,
                            concelho: apiEvent.concelho,
                            freguesia: apiEvent.freguesia,
                            morada: apiEvent.morada,
                            moradaCp: apiEvent.morada_cp,
                            areaPrivativa: apiEvent.area_privativa,
                            areaDependente: apiEvent.area_dependente,
                            areaTotal: apiEvent.area_total,
                            matricula: apiEvent.matricula
                        },
                        valores: {
                            valorBase: apiEvent.valor_base,
                            valorAbertura: apiEvent.valor_abertura,
                            valorMinimo: apiEvent.valor_minimo,
                            lanceAtual: apiEvent.lance_atual
                        },
                        dataInicio: apiEvent.data_inicio,
                        dataFim: apiEvent.data_fim,
                        gps: apiEvent.latitude ? { latitude: apiEvent.latitude, longitude: apiEvent.longitude } : null,
                        processo: {
                            numero: apiEvent.processo_numero,
                            tribunal: apiEvent.processo_tribunal,
                            comarca: apiEvent.processo_comarca
                        },
                        cerimonia: {
                            data: apiEvent.cerimonia_data,
                            local: apiEvent.cerimonia_local,
                            morada: apiEvent.cerimonia_morada
                        },
                        gestor: {
                            nome: apiEvent.gestor_nome,
                            email: apiEvent.gestor_email,
                            telefone: apiEvent.gestor_telefone,
                            tipo: apiEvent.gestor_tipo,
                            cedula: apiEvent.gestor_cedula
                        },
                        descricao: apiEvent.descricao,
                        observacoes: apiEvent.observacoes
                    };
                } catch (error) {
                    console.error('Error fetching event:', error);
                    showToast('Erro', 'N√£o foi poss√≠vel carregar o evento', 'error');
                    return;
                }
            }

            inspectionCurrentEvent = event;
            inspectionCurrentIndex = 0;

            const modal = document.getElementById('inspection-modal');
            const imagesContainer = document.getElementById('inspection-images');
            const indicatorsContainer = document.getElementById('inspection-indicators');
            const counter = document.getElementById('inspection-counter');
            const details = document.getElementById('inspection-details');

            // Build images
            const images = event.imagens && event.imagens.length > 0 ? event.imagens : [event.capa || ''];
            imagesContainer.innerHTML = images.map(img =>
                `<div class="inspection-carousel-image" style="background-image: url('${img || ''}')"></div>`
            ).join('');

            // Reset carousel position to first image
            imagesContainer.style.transform = 'translateX(0)';

            // Build indicators
            indicatorsContainer.innerHTML = images.map((_, idx) =>
                `<div class="inspection-carousel-indicator ${idx === 0 ? 'active' : ''}" onclick="inspectionGoTo(${idx})"></div>`
            ).join('');

            // Update counter
            counter.textContent = `1 / ${images.length}`;

            // Show/hide nav buttons
            const prevBtn = document.querySelector('.inspection-carousel-nav.prev');
            const nextBtn = document.querySelector('.inspection-carousel-nav.next');
            if (images.length <= 1) {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
                indicatorsContainer.style.display = 'none';
            } else {
                prevBtn.style.display = 'flex';
                nextBtn.style.display = 'flex';
                indicatorsContainer.style.display = 'flex';
            }

            // Build details
            const typePrefix = event.reference.substring(0, 2);
            const typePrefixClass = typePrefix === 'LO' ? 'lo' : 'np';

            const formatPrice = (price) => {
                if (!price) return 'N/A';
                return new Intl.NumberFormat('pt-PT', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(price);
            };

            const formatDate = (dateStr) => {
                if (!dateStr) return 'N/A';
                const date = new Date(dateStr);
                return date.toLocaleString('pt-PT', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            };

            const getValue = (val) => val || 'N/A';
            const isImovel = event.tipoEvento === 'imoveis' || event.tipoId === 1;
            const isVeiculo = event.tipoEvento === 'veiculos' || event.tipoId === 2;

            // Build location string
            const locationParts = [event.detalhes?.morada, event.detalhes?.moradaCp, event.detalhes?.freguesia, event.detalhes?.concelho, event.detalhes?.distrito].filter(Boolean);
            const fullLocation = locationParts.join(', ');

            details.innerHTML = `
                <div class="inspection-header">
                    <div class="inspection-ref">
                        <span class="inspection-ref-prefix ${typePrefixClass}">${typePrefix}</span>
                        <span class="inspection-ref-text">${event.reference.substring(2)}</span>
                    </div>
                    <div class="inspection-type">${getValue(event.detalhes?.tipo)} ${event.detalhes?.subtipo && event.detalhes?.subtipo !== 'N/A' ? '‚Ä¢ ' + event.detalhes.subtipo : ''}</div>
                    ${event.titulo ? `<div style="font-size: 12px; color: #64748b; margin-top: 4px; line-height: 1.4;">${event.titulo}</div>` : ''}
                </div>

                <!-- Valores - Destaque -->
                <div class="inspection-section" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 12px; padding: 16px; margin: -4px -4px 12px -4px;">
                    <div class="inspection-section-title" style="color: #166534;">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Valores
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <div class="inspection-row" style="flex-direction: column; align-items: flex-start; gap: 2px;">
                            <span class="inspection-label" style="font-size: 10px;">Valor Base</span>
                            <span class="inspection-value ${event.valores?.valorBase ? 'price' : 'empty'}" style="font-size: 14px; font-weight: 700;">${formatPrice(event.valores?.valorBase)}</span>
                        </div>
                        <div class="inspection-row" style="flex-direction: column; align-items: flex-start; gap: 2px;">
                            <span class="inspection-label" style="font-size: 10px;">Valor M√≠nimo</span>
                            <span class="inspection-value ${event.valores?.valorMinimo ? 'price' : 'empty'}" style="font-size: 14px; font-weight: 700;">${formatPrice(event.valores?.valorMinimo)}</span>
                        </div>
                    </div>
                    <div class="inspection-row" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(22, 101, 52, 0.2);">
                        <span class="inspection-label" style="font-weight: 600;">Lance Atual</span>
                        <span class="inspection-lance-atual-value"><span class="inspection-value price" style="font-size: 16px; font-weight: 700; color: #166534;">${formatPrice(event.valores?.lanceAtual)}</span></span>
                        <button onclick="refreshModalPrice('${event.reference}')" style="background: none; border: none; padding: 4px; cursor: pointer; color: #166534; display: flex; align-items: center; transition: opacity 0.2s; margin-left: 4px;" title="Atualizar lance" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                        </button>
                    </div>
                </div>

                <!-- Datas -->
                <div class="inspection-section">
                    <div class="inspection-section-title">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        Datas do Leil√£o
                    </div>
                    <div class="inspection-row">
                        <span class="inspection-label">In√≠cio</span>
                        <span class="inspection-value ${event.dataInicio ? '' : 'empty'}">${formatDate(event.dataInicio)}</span>
                    </div>
                    <div class="inspection-row">
                        <span class="inspection-label">Fim</span>
                        <span class="inspection-value ${event.dataFim ? '' : 'empty'}">${formatDate(event.dataFim)}</span>
                    </div>
                </div>

                <!-- Localiza√ß√£o (para im√≥veis ou se tiver dados) -->
                ${(isImovel || event.detalhes?.distrito) ? `
                    <div class="inspection-section">
                        <div class="inspection-section-title">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            Localiza√ß√£o
                        </div>
                        ${event.detalhes?.morada ? `
                            <div class="inspection-row">
                                <span class="inspection-label">Morada</span>
                                <span class="inspection-value" style="text-align: right; max-width: 60%;">${event.detalhes.morada}</span>
                            </div>
                        ` : ''}
                        <div class="inspection-row">
                            <span class="inspection-label">Distrito</span>
                            <span class="inspection-value ${event.detalhes?.distrito ? '' : 'empty'}">${getValue(event.detalhes?.distrito)}</span>
                        </div>
                        <div class="inspection-row">
                            <span class="inspection-label">Concelho</span>
                            <span class="inspection-value ${event.detalhes?.concelho ? '' : 'empty'}">${getValue(event.detalhes?.concelho)}</span>
                        </div>
                        <div class="inspection-row">
                            <span class="inspection-label">Freguesia</span>
                            <span class="inspection-value ${event.detalhes?.freguesia ? '' : 'empty'}">${getValue(event.detalhes?.freguesia)}</span>
                        </div>
                    </div>
                ` : ''}

                <!-- √Åreas (para im√≥veis) -->
                ${isImovel ? `
                    <div class="inspection-section">
                        <div class="inspection-section-title">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
                            </svg>
                            Caracter√≠sticas
                        </div>
                        ${event.detalhes?.tipologia ? `
                            <div class="inspection-row">
                                <span class="inspection-label">Tipologia</span>
                                <span class="inspection-value">${event.detalhes.tipologia}</span>
                            </div>
                        ` : ''}
                        <div class="inspection-row">
                            <span class="inspection-label">√Årea Privativa</span>
                            <span class="inspection-value ${event.detalhes?.areaPrivativa ? '' : 'empty'}">${event.detalhes?.areaPrivativa ? event.detalhes.areaPrivativa + ' m¬≤' : 'N/A'}</span>
                        </div>
                        ${event.detalhes?.areaDependente ? `
                            <div class="inspection-row">
                                <span class="inspection-label">√Årea Dependente</span>
                                <span class="inspection-value">${event.detalhes.areaDependente} m¬≤</span>
                            </div>
                        ` : ''}
                        <div class="inspection-row">
                            <span class="inspection-label">√Årea Total</span>
                            <span class="inspection-value ${event.detalhes?.areaTotal ? '' : 'empty'}">${event.detalhes?.areaTotal ? event.detalhes.areaTotal + ' m¬≤' : 'N/A'}</span>
                        </div>
                    </div>
                ` : ''}

                <!-- Matr√≠cula (para ve√≠culos) -->
                ${isVeiculo && event.detalhes?.matricula ? `
                    <div class="inspection-section">
                        <div class="inspection-section-title">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"/>
                            </svg>
                            Ve√≠culo
                        </div>
                        <div class="inspection-row">
                            <span class="inspection-label">Matr√≠cula</span>
                            <span class="inspection-value" style="font-family: monospace; font-weight: 600;">${event.detalhes.matricula}</span>
                        </div>
                    </div>
                ` : ''}

                <!-- Processo -->
                ${event.processo?.numero ? `
                    <div class="inspection-section">
                        <div class="inspection-section-title">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            Processo
                        </div>
                        <div class="inspection-row">
                            <span class="inspection-label">N√∫mero</span>
                            <span class="inspection-value" style="font-family: monospace;">${event.processo.numero}</span>
                        </div>
                        ${event.processo.tribunal ? `
                            <div class="inspection-row">
                                <span class="inspection-label">Tribunal</span>
                                <span class="inspection-value" style="text-align: right; max-width: 60%; font-size: 11px;">${event.processo.tribunal}</span>
                            </div>
                        ` : ''}
                        ${event.processo.comarca ? `
                            <div class="inspection-row">
                                <span class="inspection-label">Comarca</span>
                                <span class="inspection-value" style="text-align: right; max-width: 60%; font-size: 11px;">${event.processo.comarca}</span>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}

                <!-- Cerim√≥nia -->
                ${event.cerimonia?.data || event.cerimonia?.local ? `
                    <div class="inspection-section">
                        <div class="inspection-section-title">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                            </svg>
                            Cerim√≥nia
                        </div>
                        ${event.cerimonia.data ? `
                            <div class="inspection-row">
                                <span class="inspection-label">Data</span>
                                <span class="inspection-value">${formatDate(event.cerimonia.data)}</span>
                            </div>
                        ` : ''}
                        ${event.cerimonia.local ? `
                            <div class="inspection-row">
                                <span class="inspection-label">Local</span>
                                <span class="inspection-value" style="text-align: right; max-width: 60%;">${event.cerimonia.local}</span>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}

                <!-- Gestor -->
                ${event.gestor?.nome ? `
                    <div class="inspection-section">
                        <div class="inspection-section-title">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                            Agente de Execu√ß√£o
                        </div>
                        <div class="inspection-row">
                            <span class="inspection-label">Nome</span>
                            <span class="inspection-value">${event.gestor.nome}</span>
                        </div>
                        ${event.gestor.tipo ? `
                            <div class="inspection-row">
                                <span class="inspection-label">Tipo</span>
                                <span class="inspection-value" style="font-size: 11px;">${event.gestor.tipo}</span>
                            </div>
                        ` : ''}
                        ${event.gestor.cedula ? `
                            <div class="inspection-row">
                                <span class="inspection-label">C√©dula</span>
                                <span class="inspection-value" style="font-family: monospace;">${event.gestor.cedula}</span>
                            </div>
                        ` : ''}
                        ${event.gestor.email ? `
                            <div class="inspection-row">
                                <span class="inspection-label">Email</span>
                                <a href="mailto:${event.gestor.email}" class="inspection-value" style="color: #3b82f6; text-decoration: none;">${event.gestor.email}</a>
                            </div>
                        ` : ''}
                        ${event.gestor.telefone ? `
                            <div class="inspection-row">
                                <span class="inspection-label">Telefone</span>
                                <a href="tel:${event.gestor.telefone}" class="inspection-value" style="color: #3b82f6; text-decoration: none;">${event.gestor.telefone}</a>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}

                <!-- Descri√ß√£o -->
                ${event.descricao ? `
                    <div class="inspection-section">
                        <div class="inspection-section-title">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h7"/>
                            </svg>
                            Descri√ß√£o
                        </div>
                        <div style="font-size: 12px; color: #475569; line-height: 1.6; max-height: 150px; overflow-y: auto; padding-right: 8px;">${event.descricao}</div>
                    </div>
                ` : ''}

                <!-- Observa√ß√µes -->
                ${event.observacoes ? `
                    <div class="inspection-section" style="background: #fef3c7; border-radius: 8px; padding: 12px; margin: 0 -4px;">
                        <div class="inspection-section-title" style="color: #92400e; margin-bottom: 8px;">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            Observa√ß√µes
                        </div>
                        <div style="font-size: 12px; color: #92400e; line-height: 1.5;">${event.observacoes}</div>
                    </div>
                ` : ''}

                <div class="inspection-actions">
                    <button class="inspection-action-btn primary" onclick="viewEvent('${event.reference}')">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                        </svg>
                        Ver no Site
                    </button>
                    <button class="inspection-action-btn secondary" onclick="reloadEventFromModal('${event.reference}')">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Atualizar
                    </button>
                    ${event.gps?.latitude ? `
                        <button class="inspection-action-btn secondary" onclick="openLocation(${event.gps.latitude}, ${event.gps.longitude})">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            </svg>
                            Mapa
                        </button>
                    ` : ''}
                </div>
            `;

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeInspectionModal() {
            const modal = document.getElementById('inspection-modal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
            inspectionCurrentEvent = null;
        }

        function inspectionCarouselPrev() {
            if (!inspectionCurrentEvent) return;
            const images = inspectionCurrentEvent.imagens || [];
            if (images.length <= 1) return;
            inspectionCurrentIndex = inspectionCurrentIndex > 0 ? inspectionCurrentIndex - 1 : images.length - 1;
            updateInspectionCarousel();
        }

        function inspectionCarouselNext() {
            if (!inspectionCurrentEvent) return;
            const images = inspectionCurrentEvent.imagens || [];
            if (images.length <= 1) return;
            inspectionCurrentIndex = inspectionCurrentIndex < images.length - 1 ? inspectionCurrentIndex + 1 : 0;
            updateInspectionCarousel();
        }

        function inspectionGoTo(index) {
            inspectionCurrentIndex = index;
            updateInspectionCarousel();
        }

        function updateInspectionCarousel() {
            const imagesContainer = document.getElementById('inspection-images');
            const indicators = document.querySelectorAll('.inspection-carousel-indicator');
            const counter = document.getElementById('inspection-counter');

            if (!inspectionCurrentEvent) return;
            const images = inspectionCurrentEvent.imagens || [];

            imagesContainer.style.transform = `translateX(-${inspectionCurrentIndex * 100}%)`;

            indicators.forEach((ind, idx) => {
                ind.classList.toggle('active', idx === inspectionCurrentIndex);
            });

            counter.textContent = `${inspectionCurrentIndex + 1} / ${images.length}`;
        }

        // Reload event from modal (full refresh via queue)
        async function reloadEventFromModal(reference) {
            try {
                // Show loading overlay
                showModalLoading('‚è≥ Na fila...', 'Pedido de atualiza√ß√£o enviado');

                // Step 1: Queue the refresh request (full type)
                const queueResponse = await fetch(`${API_BASE}/api/refresh/${reference}?refresh_type=full`, { method: 'POST' });
                if (!queueResponse.ok) throw new Error('Failed to queue request');

                const queueData = await queueResponse.json();
                if (!queueData.success) throw new Error(queueData.message || 'Queue failed');

                const requestId = queueData.request_id;
                updateModalLoading('üîÑ A processar...', 'Backend a recolher dados do e-leiloes.pt');

                // Step 2: Poll for completion (max 30 seconds)
                const maxAttempts = 30;
                for (let i = 0; i < maxAttempts; i++) {
                    await new Promise(r => setTimeout(r, 1000));

                    const statusResponse = await fetch(`${API_BASE}/api/refresh/status/${requestId}`);
                    if (!statusResponse.ok) continue;

                    const status = await statusResponse.json();

                    // Update loading text based on state
                    if (status.state === 1) {
                        updateModalLoading('üîÑ A processar...', `A atualizar ${reference}...`);
                    }

                    if (status.state === 2) {
                        updateModalLoading('‚úÖ Conclu√≠do!', 'A carregar dados atualizados...');

                        // Completed - reload the event data from DB and re-open modal
                        const response = await fetch(`${API_BASE}/api/events/${reference}?t=${Date.now()}`);
                        if (response.ok) {
                            const apiEvent = await response.json();

                            // Update cached entry
                            const type = document.querySelector('.page.active')?.id;
                            if (allLoadedEvents[type]) {
                                const idx = allLoadedEvents[type].findIndex(e => e.reference === reference);
                                if (idx >= 0) {
                                    allLoadedEvents[type][idx].valores.lanceAtual = apiEvent.lance_atual;
                                    allLoadedEvents[type][idx].dataFim = apiEvent.data_fim;
                                }
                            }

                            // Hide overlay before re-opening modal
                            hideModalLoading();

                            // Re-open modal with fresh data
                            await openInspectionModal(reference);
                        }
                        showToast('‚úÖ Atualizado', status.result_message || 'Dados atualizados', 'success');
                        return;
                    } else if (status.state === 3) {
                        hideModalLoading();
                        showToast('‚ùå Erro', status.result_message || 'Falha ao atualizar', 'error');
                        return;
                    }
                }

                // Timeout
                hideModalLoading();
                showToast('‚è±Ô∏è Timeout', 'Demorou demasiado tempo', 'warning');
            } catch (error) {
                console.error('Error reloading event:', error);
                hideModalLoading();
                showToast('Erro', 'N√£o foi poss√≠vel atualizar', 'error');
            }
        }

        // Modal loading overlay helpers
        function showModalLoading(text = 'A processar...', subtext = 'Aguarde enquanto atualizamos os dados') {
            const overlay = document.getElementById('modal-loading-overlay');
            const textEl = document.getElementById('modal-loading-text');
            const subtextEl = document.getElementById('modal-loading-subtext');
            if (overlay) {
                if (textEl) textEl.textContent = text;
                if (subtextEl) subtextEl.textContent = subtext;
                overlay.classList.add('active');
            }
        }

        function updateModalLoading(text, subtext) {
            const textEl = document.getElementById('modal-loading-text');
            const subtextEl = document.getElementById('modal-loading-subtext');
            if (textEl) textEl.textContent = text;
            if (subtextEl) subtextEl.textContent = subtext || '';
        }

        function hideModalLoading() {
            const overlay = document.getElementById('modal-loading-overlay');
            if (overlay) overlay.classList.remove('active');
        }

        // Refresh only the price (lance atual) for modal
        // Uses queue system: creates request in DB, backend processes it, frontend polls for result
        async function refreshModalPrice(reference) {
            const priceElement = document.querySelector('.inspection-lance-atual-value');
            try {
                if (priceElement) {
                    priceElement.innerHTML = '<span style="color: #f59e0b; font-size: 11px;">‚è≥ Na fila...</span>';
                }

                // Step 1: Queue the refresh request
                const queueResponse = await fetch(`${API_BASE}/api/refresh/${reference}`, { method: 'POST' });
                if (!queueResponse.ok) throw new Error('Failed to queue request');

                const queueData = await queueResponse.json();
                if (!queueData.success) throw new Error(queueData.message || 'Queue failed');

                const requestId = queueData.request_id;

                if (priceElement) {
                    priceElement.innerHTML = '<span style="color: #3b82f6; font-size: 11px;">üîÑ A processar...</span>';
                }

                // Step 2: Poll for completion (max 30 seconds)
                const maxAttempts = 30;
                for (let i = 0; i < maxAttempts; i++) {
                    await new Promise(r => setTimeout(r, 1000)); // Wait 1 second

                    const statusResponse = await fetch(`${API_BASE}/api/refresh/status/${requestId}`);
                    if (!statusResponse.ok) continue;

                    const status = await statusResponse.json();

                    // State: 0=pending, 1=processing, 2=completed, 3=error
                    if (status.state === 2) {
                        // Completed - show result
                        if (status.result_lance !== null && priceElement) {
                            const formatted = new Intl.NumberFormat('pt-PT', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(status.result_lance);
                            priceElement.innerHTML = `<span class="inspection-value price">${formatted}</span>`;

                            // Update stored event
                            if (inspectionCurrentEvent) {
                                inspectionCurrentEvent.valores.lanceAtual = status.result_lance;
                            }

                            showToast('Lance atualizado', formatted, 'success');
                        } else {
                            showToast('Atualizado', status.result_message || 'Conclu√≠do', 'success');
                        }
                        return;
                    } else if (status.state === 3) {
                        // Error
                        showToast('Erro', status.result_message || 'Falha no refresh', 'error');
                        // Show current DB value
                        const volatileRes = await fetch(`${API_BASE}/api/volatile/${reference}`);
                        if (volatileRes.ok && priceElement) {
                            const data = await volatileRes.json();
                            const formatted = new Intl.NumberFormat('pt-PT', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(data.lance_atual || 0);
                            priceElement.innerHTML = `<span class="inspection-value price">${formatted}</span>`;
                        }
                        return;
                    }
                    // Still pending or processing - continue polling
                }

                // Timeout - show current DB value
                showToast('Timeout', 'Demorou demasiado tempo', 'warning');
                const volatileRes = await fetch(`${API_BASE}/api/volatile/${reference}`);
                if (volatileRes.ok && priceElement) {
                    const data = await volatileRes.json();
                    const formatted = new Intl.NumberFormat('pt-PT', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(data.lance_atual || 0);
                    priceElement.innerHTML = `<span class="inspection-value price">${formatted}</span>`;
                }

            } catch (error) {
                console.error('Error refreshing price:', error);
                showToast('Erro', 'N√£o foi poss√≠vel atualizar o lance', 'error');
                // Show current value from DB
                if (priceElement) {
                    const volatileRes = await fetch(`${API_BASE}/api/volatile/${reference}`);
                    if (volatileRes.ok) {
                        const data = await volatileRes.json();
                        const formatted = new Intl.NumberFormat('pt-PT', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(data.lance_atual || 0);
                        priceElement.innerHTML = `<span class="inspection-value price">${formatted}</span>`;
                    }
                }
            }
        }

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeInspectionModal();
            }
        });

        // Close modal on background click
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('inspection-modal')) {
                closeInspectionModal();
            }
        });
        let filteredEvents = {
            imoveis: [],
            veiculos: [],
            direitos: [],
            equipamentos: [],
            mobiliario: [],
            maquinas: []
        }; // Store filtered events
        const ITEMS_PER_PAGE = 24; // Reduced for faster rendering

        // Global variables for console and modals
        let consolePollingInterval = null;
        let autoScroll = true;

        // Pipeline X countdown variables
        let pipelineXCountdown = 5;
        let pipelineXCountdownInterval = null;
        let pipelineXCachedEvents = 0;
        let deleteTimerInterval = null;

        // Manual Pipeline control variables
        let pipelineRunning = false;
        let pipelineAbortController = null;
        // API mode is now the only mode - faster and more complete!

        // Sidebar Lock
        function toggleSidebarLock() {
            const sidebar = document.getElementById('sidebar');
            const lockIcon = document.getElementById('lockIcon');
            const isLocked = sidebar.classList.contains('locked');

            if (isLocked) {
                sidebar.classList.remove('locked');
                lockIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"/>';
                localStorage.setItem('sidebarLocked', 'false');
            } else {
                sidebar.classList.add('locked');
                lockIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>';
                localStorage.setItem('sidebarLocked', 'true');
            }
        }

        // User Card Dropdown Toggle
        function toggleUserDropdown() {
            const userCard = document.getElementById('userCard');
            userCard.classList.toggle('open');
        }

        // Restore sidebar state on load
        function restoreSidebarState() {
            const isLocked = localStorage.getItem('sidebarLocked') === 'true';
            if (isLocked) {
                document.getElementById('sidebar').classList.add('locked');
                document.getElementById('lockIcon').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>';
            }
        }

        // Close dropdowns when sidebar collapses
        document.getElementById('sidebar').addEventListener('mouseleave', function() {
            if (!this.classList.contains('locked')) {
                document.querySelectorAll('.nav-item.dropdown-open').forEach(item => {
                    item.classList.remove('dropdown-open');
                });
                // Also close user card dropdown
                const userCard = document.getElementById('userCard');
                if (userCard) {
                    userCard.classList.remove('open');
                }
            }
        });

        // Navigation
        function showPage(pageId) {
            // Close mobile menu if open
            if (window.innerWidth <= 768) {
                closeMobileMenu();
            }

            // Hide all pages
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));

            // Show selected page
            document.getElementById(pageId).classList.add('active');

            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

            // Use data-page attribute for more reliable selection
            const navItem = document.querySelector(`.nav-item[data-page="${pageId}"]`) ||
                           document.querySelector(`.nav-item[onclick*="${pageId}"]`);
            if (navItem) navItem.classList.add('active');

            if (pageId === 'dashboard') {
                loadDashboard();
            } else if (pageId === 'eventos') {
                loadAllEvents();
            } else if (['imoveis', 'veiculos', 'direitos', 'equipamentos', 'mobiliario', 'maquinas'].includes(pageId)) {
                loadEvents(pageId);
            }

            // Reset type filter when changing page
            activeTypeFilter = null;
            document.querySelectorAll('.type-badge').forEach(b => b.classList.remove('active'));
        }

        function scrollToPipelines() {
            showPage('dashboard');
            setTimeout(() => {
                const scraperCard = document.querySelector('.dashboard-row');
                if (scraperCard) {
                    scraperCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }

        function openSettings() {
            // TODO: Implement settings modal/page
            alert('Settings - Em breve!');
        }

        function toggleTypeFilter(type, element) {
            if (activeTypeFilter === type) {
                activeTypeFilter = null;
                element.classList.remove('active');
            } else {
                activeTypeFilter = type;
                document.querySelectorAll('.type-badge').forEach(b => b.classList.remove('active'));
                element.classList.add('active');
            }

            // Reload events page if on eventos page
            const activePage = document.querySelector('.page.active');
            if (activePage && activePage.id === 'eventos') {
                loadAllEvents(1);
            }
        }

        // Load Dashboard - with auto-refresh
        let statsRefreshInterval = null;

        async function loadDashboard() {
            try {
                await updateDashboardStats();

                // Load DB maintenance stats
                refreshDbStats();

                // Initialize scraper controls
                initScraperControls();
                // Check scraper status
                updateScraperStatus();

                // Start auto-refresh of stats every 10 seconds
                if (!statsRefreshInterval) {
                    statsRefreshInterval = setInterval(updateDashboardStats, 10000);
                    console.log('üìä Stats auto-refresh started (10s)');
                }
            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
            }
        }

        async function updateDashboardStats() {
            try {
                // Use optimized quick-stats endpoint (SQL COUNT queries, much faster!)
                const response = await fetch(`${API_BASE}/api/dashboard/quick-stats`);
                const stats = await response.json();

                // Helper to update stat with animation on change
                const updateStat = (id, value) => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    const oldValue = parseInt(el.textContent) || 0;
                    if (oldValue !== value) {
                        el.textContent = value;
                        el.style.transition = 'transform 0.2s ease, color 0.3s ease';
                        el.style.transform = 'scale(1.15)';
                        el.style.color = value > oldValue ? '#10b981' : '#ef4444';
                        setTimeout(() => {
                            el.style.transform = 'scale(1)';
                            el.style.color = '';
                        }, 300);
                    }
                };

                // Total
                updateStat('stat-total', stats.total);
                updateStat('stat-total-lo', stats.total_lo);
                updateStat('stat-total-np', stats.total_np);
                updateStat('stat-total-inactive', stats.total_inactive);

                // By type
                const types = ['imoveis', 'veiculos', 'direitos', 'equipamentos', 'mobiliario', 'maquinas'];
                types.forEach(type => {
                    const data = stats.by_type[type] || { total: 0, lo: 0, np: 0 };
                    updateStat(`stat-${type}`, data.total);
                    updateStat(`stat-${type}-lo`, data.lo);
                    updateStat(`stat-${type}-np`, data.np);
                });

            } catch (error) {
                console.error('Erro ao atualizar stats:', error);
            }
        }

        // ========== DASHBOARD WIDGETS ==========

        async function loadDashboardWidgets() {
            await Promise.all([
                loadEndingSoonWidget(),
                loadRecentBidsWidget(),
                loadDistrictBreakdownWidget(),
                loadNewEventsBanner(),
                FAVORITES.updateWidget()
            ]);
        }

        let endingSoonEventsAll = [];
        let endingSoonEvents = [];
        let endingSoonInterval = null;

        async function loadEndingSoonWidget() {
            const container = document.getElementById('dash-ending-soon');
            if (!container) return;

            try {
                const response = await fetch(`${API_BASE}/api/dashboard/ending-soon?hours=24&limit=1000&include_terminated=true&terminated_hours=120`);
                endingSoonEventsAll = await response.json();

                if (endingSoonEventsAll.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #94a3b8; font-size: 11px;">Nenhum evento a terminar nas pr√≥ximas 24h</div>';
                    return;
                }

                // Populate distrito filter
                const distritoSelect = document.getElementById('ending-filter-distrito');
                if (distritoSelect) {
                    const distritos = [...new Set(endingSoonEventsAll.map(e => e.distrito).filter(Boolean))].sort();
                    distritoSelect.innerHTML = '<option value="">Todos os distritos</option>' +
                        distritos.map(d => `<option value="${d}">${d}</option>`).join('');
                }

                filterEndingSoon();

                // Start live countdown
                if (endingSoonInterval) clearInterval(endingSoonInterval);
                endingSoonInterval = setInterval(updateEndingSoonTimers, 1000);
            } catch (error) {
                console.error('Erro ao carregar eventos a terminar:', error);
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444; font-size: 11px;">Erro ao carregar</div>';
            }
        }

        let endingSoonSort = { column: 'timer', direction: 'asc' };

        function filterEndingSoon() {
            const tipoFilter = document.getElementById('ending-filter-tipo')?.value || '';
            const distritoFilter = document.getElementById('ending-filter-distrito')?.value || '';

            endingSoonEvents = endingSoonEventsAll.filter(e => {
                // Filter by tipo_id (1=Im√≥veis, 2=Ve√≠culos, etc)
                if (tipoFilter && e.tipo_id !== parseInt(tipoFilter)) return false;
                if (distritoFilter && e.distrito !== distritoFilter) return false;
                return true;
            });

            applySortEndingSoon();
            renderEndingSoonWidget();
        }

        function sortEndingSoon(column) {
            if (endingSoonSort.column === column) {
                endingSoonSort.direction = endingSoonSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                endingSoonSort.column = column;
                endingSoonSort.direction = 'asc';
            }

            // Update sort icons
            const columns = ['timer', 'reference', 'tipo', 'subtipo', 'distrito', 'lance_atual'];
            columns.forEach(col => {
                const icon = document.getElementById(`sort-icon-${col}`);
                if (icon) {
                    if (col === column) {
                        icon.textContent = endingSoonSort.direction === 'asc' ? '‚Üë' : '‚Üì';
                    } else {
                        icon.textContent = '';
                    }
                }
            });

            applySortEndingSoon();
            renderEndingSoonWidget();
        }

        function applySortEndingSoon() {
            const { column, direction } = endingSoonSort;
            const dir = direction === 'asc' ? 1 : -1;

            endingSoonEvents.sort((a, b) => {
                let valA, valB;

                if (column === 'timer') {
                    valA = new Date(a.data_fim).getTime();
                    valB = new Date(b.data_fim).getTime();
                } else if (column === 'lance_atual') {
                    valA = a.lance_atual || 0;
                    valB = b.lance_atual || 0;
                } else {
                    valA = (a[column] || '').toString().toLowerCase();
                    valB = (b[column] || '').toString().toLowerCase();
                }

                if (valA < valB) return -1 * dir;
                if (valA > valB) return 1 * dir;

                // Secondary sort: when timer is primary, use lance_atual desc as tiebreaker
                if (column === 'timer') {
                    const lanceA = a.lance_atual || 0;
                    const lanceB = b.lance_atual || 0;
                    return lanceB - lanceA; // Descending (higher value first)
                }
                return 0;
            });
        }

        async function renderEndingSoonWidget() {
            const container = document.getElementById('dash-ending-soon');
            if (!container) return;

            if (!endingSoonEvents.length) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #94a3b8; font-size: 11px;">Nenhum evento encontrado</div>';
                return;
            }

            // Pre-load favorites cache for sync checks during render
            await FAVORITES.getAll();
            await getFavoritesFromCache(); // Also load favoritesCache for star buttons

            // Separate active and terminated events
            const activeEvents = endingSoonEvents.filter(e => !e.terminado);
            const terminatedEvents = endingSoonEvents.filter(e => e.terminado);

            const renderEvent = (event, isTerminated) => {
                const dataFim = new Date(event.data_fim);
                const now = new Date();
                const diffMs = dataFim - now;
                const diffHours = diffMs / (1000 * 60 * 60);

                // Color based on urgency (gray for terminated)
                let bgColor, borderColor, textColor;
                if (isTerminated) {
                    bgColor = '#f8fafc'; borderColor = '#94a3b8'; textColor = '#94a3b8';
                } else if (diffHours < 3) {
                    bgColor = '#fef2f2'; borderColor = '#ef4444'; textColor = '#ef4444';
                } else if (diffHours < 6) {
                    bgColor = '#fff7ed'; borderColor = '#f97316'; textColor = '#f97316';
                } else {
                    bgColor = '#fefce8'; borderColor = '#eab308'; textColor = '#eab308';
                }

                const valor = event.lance_atual ? `‚Ç¨${event.lance_atual.toLocaleString('pt-PT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}` : '-';
                const zona = event.distrito || '-';
                // Map tipo_id to category name
                const tipoIdToName = {1: 'Im√≥veis', 2: 'Ve√≠culos', 3: 'Equip.', 4: 'Mobil.', 5: 'M√°q.', 6: 'Direitos'};
                const tipo = tipoIdToName[event.tipo_id] || event.tipo || '-';
                const subtipo = event.subtipo || '-';

                // Price values for chart data attributes
                const vBase = event.valor_base || 0;
                const vAbertura = event.valor_abertura || 0;
                const vMinimo = event.valor_minimo || 0;
                const vAtual = event.lance_atual || 0;

                // Timer text for terminated events
                const timerText = isTerminated ? 'Terminado' : '--:--';
                const valueColor = isTerminated ? '#94a3b8' : '#1e293b';
                const labelColor = isTerminated ? '#94a3b8' : '#64748b';

                return `
                    <div class="ending-soon-row" data-ref="${event.reference}" data-terminated="${isTerminated}" style="display: flex; align-items: center; padding: 5px 10px; background: ${bgColor}; border-radius: 4px; border-left: 3px solid ${borderColor};">
                        <span class="ending-timer" data-ref="${event.reference}" data-terminated="${isTerminated}" style="font-size: 10px; font-weight: 600; color: ${textColor}; width: 72px;">${timerText}</span>
                        <span style="font-size: 10px; color: ${labelColor}; width: 85px; cursor: pointer; text-decoration: underline;" title="Ver detalhes" onclick="openInspectionModal('${event.reference}')">${event.reference}</span>
                        <span style="font-size: 10px; color: ${valueColor}; width: 65px;">${tipo}</span>
                        <span style="font-size: 10px; color: ${labelColor}; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${subtipo}">${subtipo}</span>
                        <span style="font-size: 10px; color: ${labelColor}; width: 55px;">${zona}</span>
                        <span style="font-size: 10px; font-weight: 600; color: ${valueColor}; width: 75px; text-align: right;">${valor}</span>
                        <div class="price-chart-btn" data-ref="${event.reference}" data-base="${vBase}" data-abertura="${vAbertura}" data-minimo="${vMinimo}" data-atual="${vAtual}" style="width: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px;" title="Ver gr√°fico de pre√ßo">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="${labelColor}" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                        </div>
                        <button data-favorite-ref="${event.reference}" onclick="event.stopPropagation(); toggleFavorite('${event.reference}', {titulo: '${(event.titulo || '').replace(/'/g, "\\'")}', tipo_id: ${event.tipo_id || 'null'}, lance_atual: ${event.lance_atual || 'null'}, data_fim: '${event.data_fim || ''}'});" style="background: none; border: none; cursor: pointer; width: 24px; display: flex; align-items: center; justify-content: center; font-size: 14px; color: ${FAVORITES.isFavoriteSync(event.reference) ? '#f59e0b' : '#cbd5e1'}; transition: color 0.2s;" title="${FAVORITES.isFavoriteSync(event.reference) ? 'Remover dos favoritos' : 'Adicionar aos favoritos'}">${FAVORITES.isFavoriteSync(event.reference) ? '‚≠ê' : '‚òÜ'}</button>
                        <a href="https://www.e-leiloes.pt/evento/${event.reference}" target="_blank" onclick="event.stopPropagation()" style="width: 24px; display: flex; align-items: center; justify-content: center; text-decoration: none; font-size: 12px;" title="Abrir no e-leil√µes">üîó</a>
                    </div>
                `;
            };

            let html = '';

            // Render active events
            html += activeEvents.map(event => renderEvent(event, false)).join('');

            // Add divider and terminated events if any
            if (terminatedEvents.length > 0) {
                html += `
                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px 0; margin: 4px 0;">
                        <div style="flex: 1; height: 1px; background: #e2e8f0;"></div>
                        <span style="font-size: 9px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px;">Terminados (${terminatedEvents.length})</span>
                        <div style="flex: 1; height: 1px; background: #e2e8f0;"></div>
                    </div>
                `;
                html += terminatedEvents.map(event => renderEvent(event, true)).join('');
            }

            container.innerHTML = html;

            // Initial timer update
            updateEndingSoonTimers();

            // Update favorite star buttons with correct state from favoritesCache
            await updateEndingSoonFavoriteButtons();

            // Setup chart tooltip positioning
            setupChartTooltips();

            // Setup linked hover between tables
            setupLinkedHover();
        }

        // Store loaded chart data for modal reuse
        const chartDataCache = {};

        // Global price chart tooltip (appended to body for correct positioning)
        let globalChartTooltip = null;
        let currentChartBtn = null;

        function getOrCreateGlobalTooltip() {
            if (!globalChartTooltip) {
                globalChartTooltip = document.createElement('div');
                globalChartTooltip.id = 'global-price-chart-tooltip';
                globalChartTooltip.style.cssText = 'display: none; position: fixed; background: white; border: 1px solid #e2e8f0; border-radius: 10px; padding: 14px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); z-index: 99999; min-width: 280px; pointer-events: none;';
                globalChartTooltip.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-size: 11px; font-weight: 600; color: #1e293b;">Evolucao de Preco</span>
                        <span class="chart-variation" style="font-size: 10px; font-weight: 600; padding: 2px 6px; border-radius: 4px;"></span>
                    </div>
                    <div class="chart-container" style="height: 100px; position: relative; margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #94a3b8;">
                            <svg class="spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4m0 12v4m-8-10h4m12 0h4m-5.66-5.66l-2.82 2.82m-5.04 5.04l-2.82 2.82m0-11.32l2.82 2.82m5.04 5.04l2.82 2.82"/></svg>
                        </div>
                    </div>
                    <div class="chart-legend" style="color: #64748b;"></div>
                    <div style="text-align: center; margin-top: 8px; padding-top: 8px; border-top: 1px solid #f1f5f9;">
                        <span style="font-size: 9px; color: #94a3b8;">Clica para expandir</span>
                    </div>
                `;
                document.body.appendChild(globalChartTooltip);
            }
            return globalChartTooltip;
        }

        function positionTooltip(btn) {
            const tooltip = getOrCreateGlobalTooltip();
            const rect = btn.getBoundingClientRect();
            const tooltipW = 280; // min-width
            const tooltipH = 220; // approximate height

            let top = rect.top - tooltipH - 8;
            let left = rect.left - tooltipW + 30;

            // If tooltip would go above viewport, show below
            if (top < 10) {
                top = rect.bottom + 8;
            }
            // Keep within viewport horizontally
            if (left < 10) left = 10;
            if (left + tooltipW > window.innerWidth - 10) {
                left = window.innerWidth - tooltipW - 10;
            }

            tooltip.style.top = top + 'px';
            tooltip.style.left = left + 'px';
        }

        function setupChartTooltips() {
            document.querySelectorAll('.price-chart-btn').forEach(btn => {
                const ref = btn.dataset.ref;

                btn.addEventListener('mouseenter', async (e) => {
                    currentChartBtn = btn;
                    const tooltip = getOrCreateGlobalTooltip();

                    // Reset tooltip content to loading state
                    tooltip.querySelector('.chart-container').innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #94a3b8;">
                            <svg class="spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4m0 12v4m-8-10h4m12 0h4m-5.66-5.66l-2.82 2.82m-5.04 5.04l-2.82 2.82m0-11.32l2.82 2.82m5.04 5.04l2.82 2.82"/></svg>
                        </div>
                    `;
                    tooltip.querySelector('.chart-legend').innerHTML = '';

                    // Position and show tooltip
                    positionTooltip(btn);
                    tooltip.style.display = 'block';

                    // Load data
                    const vBase = parseFloat(btn.dataset.base) || 0;
                    const vAbertura = parseFloat(btn.dataset.abertura) || 0;
                    const vMinimo = parseFloat(btn.dataset.minimo) || 0;
                    const vAtual = parseFloat(btn.dataset.atual) || 0;

                    // Check cache first
                    if (chartDataCache[ref]) {
                        const cached = chartDataCache[ref];
                        renderPriceChart(tooltip, cached.history, cached.vBase, cached.vAbertura, cached.vMinimo, cached.vAtual);
                    } else {
                        try {
                            const response = await fetch(`${API_BASE}/api/dashboard/price-history/${ref}`);
                            const history = await response.json();
                            chartDataCache[ref] = { history, vBase, vAbertura, vMinimo, vAtual };
                            // Only render if still hovering this button
                            if (currentChartBtn === btn) {
                                renderPriceChart(tooltip, history, vBase, vAbertura, vMinimo, vAtual);
                            }
                        } catch (err) {
                            chartDataCache[ref] = { history: [{preco: vAtual}], vBase, vAbertura, vMinimo, vAtual };
                            if (currentChartBtn === btn) {
                                renderPriceChart(tooltip, [{preco: vAtual}], vBase, vAbertura, vMinimo, vAtual);
                            }
                        }
                    }
                });

                btn.addEventListener('mouseleave', () => {
                    currentChartBtn = null;
                    const tooltip = getOrCreateGlobalTooltip();
                    tooltip.style.display = 'none';
                });

                // Click to open expanded modal
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const tooltip = getOrCreateGlobalTooltip();
                    tooltip.style.display = 'none';
                    openPriceChartModal(ref, btn.dataset);
                });
            });
        }

        // Show price chart for a reference (wrapper for favorites page)
        async function showPriceChart(ref) {
            // Fetch event data to get price values
            try {
                const response = await fetch(`${API_BASE}/api/event/${ref}`);
                if (response.ok) {
                    const event = await response.json();
                    const dataset = {
                        base: event.valor_base || 0,
                        abertura: event.valor_abertura || 0,
                        minimo: event.valor_minimo || 0,
                        atual: event.lance_atual || 0
                    };
                    openPriceChartModal(ref, dataset);
                } else {
                    // Fallback - open modal without preset values
                    openPriceChartModal(ref, { base: 0, abertura: 0, minimo: 0, atual: 0 });
                }
            } catch (error) {
                console.error('Error fetching event for price chart:', error);
                openPriceChartModal(ref, { base: 0, abertura: 0, minimo: 0, atual: 0 });
            }
        }

        // Expanded price chart modal
        function openPriceChartModal(ref, dataset) {
            const vBase = parseFloat(dataset.base) || 0;
            const vAbertura = parseFloat(dataset.abertura) || 0;
            const vMinimo = parseFloat(dataset.minimo) || 0;
            const vAtual = parseFloat(dataset.atual) || 0;

            const modal = document.createElement('div');
            modal.id = 'price-chart-modal';
            modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 99999;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 20px; max-width: 520px; width: 90%; box-shadow: 0 20px 50px rgba(0,0,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div>
                            <div style="font-size: 14px; font-weight: 600; color: #1e293b;">Evolucao de Preco</div>
                            <div style="font-size: 11px; color: #64748b;">${ref}</div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <a href="https://www.e-leiloes.pt/evento/${ref}" target="_blank" style="display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: #dbeafe; border-radius: 6px; text-decoration: none;" title="Abrir no e-leiloes.pt">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                            </a>
                            <button onclick="this.closest('#price-chart-modal').remove()" style="display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: #f1f5f9; border: none; border-radius: 6px; cursor: pointer;" title="Fechar">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                            </button>
                        </div>
                    </div>
                    <div class="chart-container" style="height: 200px; margin-bottom: 12px; display: flex; align-items: center; justify-content: center;">
                        <svg class="spin" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2"><path d="M12 2v4m0 12v4m-8-10h4m12 0h4m-5.66-5.66l-2.82 2.82m-5.04 5.04l-2.82 2.82m0-11.32l2.82 2.82m5.04 5.04l2.82 2.82"/></svg>
                    </div>
                    <div class="chart-legend" style="color: #64748b;"></div>
                </div>
            `;

            document.body.appendChild(modal);

            // Always fetch fresh data for modal (ignore stale cache)
            const fetchUrl = `${API_BASE}/api/dashboard/price-history/${ref}`;
            console.log(`[Chart Modal] Fetching from: ${fetchUrl}`);
            fetch(fetchUrl)
                .then(r => {
                    console.log(`[Chart Modal] Response status: ${r.status}`);
                    return r.json();
                })
                .then(history => {
                    console.log(`[Chart Modal] API returned ${history.length} records for ${ref}`, history.slice(0, 2));
                    // Update cache with fresh data
                    chartDataCache[ref] = { history, vBase, vAbertura, vMinimo, vAtual };
                    renderPriceChart(modal.querySelector('div > div'), history, vBase, vAbertura, vMinimo, vAtual, true);
                })
                .catch((err) => {
                    console.error(`[Chart Modal] Fetch error:`, err);
                    renderPriceChart(modal.querySelector('div > div'), [{preco: vAtual}], vBase, vAbertura, vMinimo, vAtual, true);
                });
        }

        function renderPriceChart(tooltip, history, vBase, vAbertura, vMinimo, vAtual, isModal = false) {
            const container = tooltip.querySelector('.chart-container');
            const legend = tooltip.querySelector('.chart-legend');
            const variationEl = tooltip.querySelector('.chart-variation');

            // Prepare data with timestamps - include abertura as first point
            let dataPoints = [];

            console.log(`[Chart] Received history:`, history.length, 'records', history.slice(0, 3));

            // Add abertura (opening price) as first point if available
            if (vAbertura > 0) {
                dataPoints.push({ preco: vAbertura, timestamp: null, label: 'Abertura' });
            }

            // Add all history points (ALL of them - each bid is a point)
            if (history && history.length > 0) {
                history.forEach((h, idx) => {
                    if (h.preco != null) {
                        dataPoints.push({
                            preco: h.preco,
                            timestamp: h.timestamp || null
                        });
                    }
                });
            }

            // Add current price as last point if different from last recorded
            if (vAtual > 0) {
                const lastRecorded = dataPoints.length > 0 ? dataPoints[dataPoints.length - 1].preco : null;
                if (lastRecorded !== vAtual) {
                    dataPoints.push({ preco: vAtual, timestamp: null, label: 'Atual' });
                }
            }

            // If still no points, add current price
            if (dataPoints.length === 0) {
                dataPoints.push({ preco: vAtual || vAbertura || vBase, timestamp: null });
            }

            // Ensure at least 2 points for line chart
            if (dataPoints.length === 1) {
                dataPoints = [{ preco: dataPoints[0].preco * 0.98, timestamp: null }, dataPoints[0]];
            }

            console.log(`[Chart ${isModal ? 'Modal' : 'Tooltip'}] Points:`, dataPoints.length, dataPoints.map(d => d.preco));

            const prices = dataPoints.map(d => d.preco);
            const firstPrice = prices[0];
            const lastPrice = prices[prices.length - 1];

            // Calculate variation %
            const variation = firstPrice > 0 ? ((lastPrice - firstPrice) / firstPrice * 100) : 0;
            const isPositive = variation >= 0;

            if (variationEl) {
                variationEl.textContent = `${isPositive ? '+' : ''}${variation.toFixed(1)}%`;
                variationEl.style.background = isPositive ? '#dcfce7' : '#fee2e2';
                variationEl.style.color = isPositive ? '#16a34a' : '#dc2626';
            }

            // Price range - always include vMinimo in range so the line is visible
            const dataMin = Math.min(...prices);
            const dataMax = Math.max(...prices);
            const minPrice = Math.min(dataMin, vMinimo || dataMin) * 0.95;
            const maxPrice = Math.max(dataMax, vMinimo || dataMax) * 1.05;
            const range = maxPrice - minPrice || 1;

            // SVG dimensions - more left padding for Y-axis labels in modal
            const width = isModal ? 480 : 252;
            const height = isModal ? 200 : 100;
            const padL = isModal ? 55 : 15, padR = 15, padT = 15, padB = isModal ? 30 : 12;
            const chartW = width - padL - padR;
            const chartH = height - padT - padB;

            const getX = (i) => padL + (i / (prices.length - 1 || 1)) * chartW;
            const getY = (p) => padT + chartH - ((p - minPrice) / range) * chartH;

            // Build smooth path
            let pathD = `M ${getX(0)} ${getY(prices[0])}`;
            for (let i = 1; i < prices.length; i++) {
                const x0 = getX(i - 1), y0 = getY(prices[i - 1]);
                const x1 = getX(i), y1 = getY(prices[i]);
                const cpx = (x0 + x1) / 2;
                pathD += ` C ${cpx} ${y0}, ${cpx} ${y1}, ${x1} ${y1}`;
            }
            let areaD = pathD + ` L ${getX(prices.length - 1)} ${padT + chartH} L ${getX(0)} ${padT + chartH} Z`;

            const vMinimoY = vMinimo > 0 ? getY(vMinimo) : -100;
            const uid = 'g' + Math.random().toString(36).substr(2, 9);

            const svgStyle = isModal ? 'display: block; width: 100%; background: #fafbfc; border-radius: 6px;' : 'display: block; background: #fafbfc; border-radius: 6px;';
            let svg = `<svg viewBox="0 0 ${width} ${height}" ${isModal ? '' : `width="${width}" height="${height}"`} style="${svgStyle}">`;
            svg += `<defs>
                <linearGradient id="${uid}-grad" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" stop-color="#22c55e" stop-opacity="0.25"/>
                    <stop offset="100%" stop-color="#22c55e" stop-opacity="0.02"/>
                </linearGradient>
            </defs>`;

            // Grid lines + Y-axis labels (only in modal)
            for (let i = 0; i <= 4; i++) {
                const y = padT + (chartH / 4) * i;
                svg += `<line x1="${padL}" y1="${y}" x2="${width - padR}" y2="${y}" stroke="#e5e7eb" stroke-width="0.5"/>`;
                if (isModal) {
                    const val = maxPrice - (range / 4) * i;
                    const label = val >= 1000 ? Math.round(val / 1000) + 'k' : Math.round(val);
                    svg += `<text x="${padL - 8}" y="${y + 3}" font-size="9" fill="#94a3b8" text-anchor="end">${label}‚Ç¨</text>`;
                }
            }

            // Valor m√≠nimo line (always show if valid)
            if (vMinimo > 0 && vMinimoY >= padT - 5 && vMinimoY <= padT + chartH + 5) {
                svg += `<line x1="${padL}" y1="${vMinimoY}" x2="${width - padR}" y2="${vMinimoY}" stroke="#f59e0b" stroke-width="1.5" stroke-dasharray="5,3" opacity="0.8"/>`;
                if (isModal) {
                    const minLabel = vMinimo >= 1000 ? Math.round(vMinimo / 1000) + 'k' : Math.round(vMinimo);
                    svg += `<text x="${padL - 8}" y="${vMinimoY + 3}" font-size="9" fill="#f59e0b" text-anchor="end" font-weight="500">${minLabel}‚Ç¨</text>`;
                }
            }

            svg += `<path d="${areaD}" fill="url(#${uid}-grad)"/>`;
            svg += `<path d="${pathD}" fill="none" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>`;

            // Interactive data points - hidden by default, appear only on hover
            dataPoints.forEach((d, i) => {
                const x = getX(i), y = getY(d.preco);
                // All points hidden (opacity 0), shown on hover via JS
                svg += `<circle id="${uid}-pt-${i}" class="chart-point" cx="${x}" cy="${y}" r="5" fill="white" stroke="#22c55e" stroke-width="2" style="opacity: 0; transition: opacity 0.15s;"/>`;
            });

            // Invisible hit areas for hover detection
            dataPoints.forEach((d, i) => {
                const x = getX(i), y = getY(d.preco);
                const time = d.timestamp ? new Date(d.timestamp).toLocaleString('pt-PT', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'}) : '';
                const timeEsc = time.replace(/'/g, "\\'");
                svg += `<circle cx="${x}" cy="${y}" r="12" fill="transparent" style="cursor: pointer;" onmouseenter="showChartPointTip(event, ${d.preco}, '${timeEsc}', '${uid}-pt-${i}')" onmouseleave="hideChartPointTip()"/>`;
            });

            // X-axis timestamps (only if modal and has data)
            if (isModal && dataPoints.length > 1 && dataPoints[0].timestamp) {
                const showCount = Math.min(5, dataPoints.length);
                const step = Math.floor((dataPoints.length - 1) / (showCount - 1)) || 1;
                for (let i = 0; i < dataPoints.length; i += step) {
                    if (dataPoints[i].timestamp) {
                        const x = getX(i);
                        const time = new Date(dataPoints[i].timestamp).toLocaleString('pt-PT', {day:'2-digit', month:'2-digit'});
                        svg += `<text x="${x}" y="${height - 5}" font-size="9" fill="#94a3b8" text-anchor="middle">${time}</text>`;
                    }
                }
            }

            svg += '</svg>';
            container.innerHTML = svg;

            // Legend
            const legendSize = isModal ? '11px' : '9px';
            const legendGap = isModal ? '8px 20px' : '3px 10px';
            legend.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: ${legendGap}; font-size: ${legendSize}; ${isModal ? 'padding: 12px; background: #f8fafc; border-radius: 8px;' : ''}">
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="width: 8px; height: 8px; background: #94a3b8; border-radius: 2px;"></span>
                        <span style="color: #64748b;">Base</span>
                        <strong style="color: #1e293b; margin-left: auto;">${vBase.toLocaleString('pt-PT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}‚Ç¨</strong>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="width: 8px; height: 8px; background: #3b82f6; border-radius: 2px;"></span>
                        <span style="color: #64748b;">Abertura</span>
                        <strong style="color: #1e293b; margin-left: auto;">${vAbertura.toLocaleString('pt-PT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}‚Ç¨</strong>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="width: 8px; height: 2px; background: #f59e0b;"></span>
                        <span style="color: #64748b;">Minimo</span>
                        <strong style="color: #1e293b; margin-left: auto;">${vMinimo.toLocaleString('pt-PT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}‚Ç¨</strong>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="width: 8px; height: 8px; background: #22c55e; border-radius: 50%;"></span>
                        <span style="color: #64748b;">Atual</span>
                        <strong style="color: #22c55e; margin-left: auto;">${vAtual.toLocaleString('pt-PT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}‚Ç¨</strong>
                    </div>
                </div>
            `;
        }

        // Chart point tooltip
        let chartPointTip = null;
        let activePointId = null;
        function showChartPointTip(e, price, time, pointId) {
            if (!chartPointTip) {
                chartPointTip = document.createElement('div');
                chartPointTip.style.cssText = 'position: fixed; padding: 5px 8px; background: #1e293b; color: white; font-size: 10px; border-radius: 4px; pointer-events: none; z-index: 9999999; white-space: nowrap;';
                document.body.appendChild(chartPointTip);
            }
            // Hide previous point
            if (activePointId) {
                const prev = document.getElementById(activePointId);
                if (prev) prev.style.opacity = '0';
            }
            // Show current point
            activePointId = pointId;
            const pt = document.getElementById(pointId);
            if (pt) pt.style.opacity = '1';

            const timeStr = time ? `<span style="color: #94a3b8; margin-left: 6px;">${time}</span>` : '';
            chartPointTip.innerHTML = `<strong style="color: #22c55e;">${price.toLocaleString('pt-PT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}‚Ç¨</strong>${timeStr}`;
            chartPointTip.style.display = 'block';
            chartPointTip.style.left = (e.clientX + 10) + 'px';
            chartPointTip.style.top = (e.clientY - 25) + 'px';
        }
        function hideChartPointTip() {
            if (chartPointTip) chartPointTip.style.display = 'none';
            if (activePointId) {
                const pt = document.getElementById(activePointId);
                if (pt) pt.style.opacity = '0';
                activePointId = null;
            }
        }

        function setupLinkedHover() {
            // Remove old listeners by cloning and replacing
            const allRows = document.querySelectorAll('.ending-soon-row, .recent-bid-row');

            allRows.forEach(row => {
                const ref = row.dataset.ref;
                if (!ref) return;

                row.addEventListener('mouseenter', () => {
                    // Find all rows with the same reference in both tables
                    document.querySelectorAll(`.ending-soon-row[data-ref="${ref}"], .recent-bid-row[data-ref="${ref}"]`).forEach(r => {
                        if (r !== row) {
                            r.classList.add('highlight-linked');
                        }
                    });
                });

                row.addEventListener('mouseleave', () => {
                    // Remove highlight from all rows with the same reference
                    document.querySelectorAll(`.ending-soon-row[data-ref="${ref}"], .recent-bid-row[data-ref="${ref}"]`).forEach(r => {
                        r.classList.remove('highlight-linked');
                    });
                });
            });
        }

        function updateEndingSoonTimers() {
            // Update timers for all non-terminated events using reference-based selectors
            document.querySelectorAll('.ending-timer').forEach(timerEl => {
                // Skip terminated events - they already show "Terminado"
                if (timerEl.dataset.terminated === 'true') return;

                const ref = timerEl.dataset.ref;
                const event = endingSoonEvents.find(e => e.reference === ref);
                if (!event) return;

                const dataFim = new Date(event.data_fim);
                const now = new Date();
                const diffMs = dataFim - now;

                if (diffMs <= 0) {
                    timerEl.textContent = 'Terminado';
                    return;
                }

                const hours = Math.floor(diffMs / (1000 * 60 * 60));
                const mins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                const secs = Math.floor((diffMs % (1000 * 60)) / 1000);

                if (hours > 0) {
                    timerEl.textContent = `${hours}h ${mins}m ${secs.toString().padStart(2, '0')}s`;
                } else {
                    timerEl.textContent = `${mins}m ${secs.toString().padStart(2, '0')}s`;
                }
            });
        }

        let recentBidsInterval = null;
        let recentBidsData = [];
        let recentBidsSort = { column: 'timestamp', direction: 'desc' };

        async function loadRecentBidsWidget() {
            const container = document.getElementById('dash-recent-bids');
            if (!container) return;

            try {
                const response = await fetch(`${API_BASE}/api/dashboard/recent-bids?limit=30`);
                const bids = await response.json();

                if (bids.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #94a3b8; font-size: 11px;">Nenhuma licita√ß√£o recente</div>';
                    return;
                }

                // Store globally for sorting
                recentBidsData = bids;
                applySortRecentBids();
                renderRecentBidsWidget();

                // Start auto-refresh if not already running
                if (!recentBidsInterval) {
                    recentBidsInterval = setInterval(loadRecentBidsWidget, 5000);
                }
            } catch (error) {
                console.error('Erro ao carregar licita√ß√µes recentes:', error);
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444; font-size: 11px;">Erro ao carregar</div>';
            }
        }

        function sortRecentBids(column) {
            if (recentBidsSort.column === column) {
                recentBidsSort.direction = recentBidsSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                recentBidsSort.column = column;
                recentBidsSort.direction = 'asc';
            }

            // Update sort icons
            const columns = ['reference', 'preco_atual', 'variacao', 'timestamp'];
            columns.forEach(col => {
                const icon = document.getElementById(`bids-sort-icon-${col}`);
                if (icon) {
                    if (col === column) {
                        icon.textContent = recentBidsSort.direction === 'asc' ? '‚Üë' : '‚Üì';
                    } else {
                        icon.textContent = '';
                    }
                }
            });

            applySortRecentBids();
            renderRecentBidsWidget();
        }

        function applySortRecentBids() {
            const { column, direction } = recentBidsSort;
            const dir = direction === 'asc' ? 1 : -1;

            recentBidsData.sort((a, b) => {
                let valA, valB;

                if (column === 'timestamp') {
                    valA = new Date(a.timestamp).getTime();
                    valB = new Date(b.timestamp).getTime();
                } else if (column === 'preco_atual' || column === 'variacao') {
                    valA = a[column] || 0;
                    valB = b[column] || 0;
                } else {
                    valA = (a[column] || '').toString().toLowerCase();
                    valB = (b[column] || '').toString().toLowerCase();
                }

                if (valA < valB) return -1 * dir;
                if (valA > valB) return 1 * dir;
                return 0;
            });
        }

        function renderRecentBidsWidget() {
            const container = document.getElementById('dash-recent-bids');
            if (!container) return;

            if (!recentBidsData.length) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #94a3b8; font-size: 11px;">Nenhuma licita√ß√£o recente</div>';
                return;
            }

            // Helper to check if event has expired (data_fim has passed)
            const isExpired = (bid) => {
                if (bid.data_fim) {
                    return new Date(bid.data_fim) < new Date();
                }
                return false;
            };

            // Separate active and inactive bids (check both ativo flag and data_fim)
            const activeBids = recentBidsData.filter(b => b.ativo !== false && !isExpired(b));
            const inactiveBids = recentBidsData.filter(b => b.ativo === false || isExpired(b));

            const renderBid = (bid) => {
                const fmtPrice = (p) => p ? `‚Ç¨${p.toLocaleString('pt-PT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}` : '?';
                const anterior = fmtPrice(bid.preco_anterior);
                const atual = fmtPrice(bid.preco_atual);
                const variacao = bid.variacao ? `+‚Ç¨${bid.variacao.toLocaleString('pt-PT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}` : '';
                const isActive = bid.ativo !== false && !isExpired(bid);

                // Time ago
                const created = new Date(bid.timestamp);
                const now = new Date();
                const diffMs = now - created;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const timeAgo = diffMins < 60 ? `${diffMins}m` : `${diffHours}h`;

                // Styling based on active/inactive status
                const rowClass = isActive ? 'recent-bid-row' : '';
                const bgColor = isActive ? '#f0fdf4' : '#f8fafc';
                const borderColor = isActive ? '#22c55e' : '#e2e8f0';
                const priceColor = isActive ? '#166534' : '#94a3b8';
                const variacaoColor = isActive ? '#22c55e' : '#94a3b8';
                const textColor = isActive ? '#64748b' : '#94a3b8';

                return `
                    <div class="${rowClass}" data-ref="${bid.reference}" style="display: flex; align-items: center; padding: 5px 10px; background: ${bgColor}; border-radius: 4px; border-left: 3px solid ${borderColor};">
                        <span style="font-size: 10px; color: ${textColor}; width: 80px; cursor: pointer; text-decoration: underline;" onclick="openInspectionModal('${bid.reference}')">${bid.reference}</span>
                        <span style="font-size: 10px; color: ${textColor}; flex: 1;">${anterior} ‚Üí <strong style="color: ${priceColor};">${atual}</strong></span>
                        <span style="font-size: 9px; color: ${variacaoColor}; font-weight: 500; width: 55px; text-align: right;">${variacao}</span>
                        <span style="font-size: 9px; color: #94a3b8; width: 30px; text-align: right;">${timeAgo}</span>
                    </div>
                `;
            };

            let html = '';

            // Render active bids first
            if (activeBids.length > 0) {
                html += activeBids.map(renderBid).join('');
            }

            // Add divider and inactive bids if any
            if (inactiveBids.length > 0) {
                html += `
                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px 0; margin: 4px 0;">
                        <div style="flex: 1; height: 1px; background: #e2e8f0;"></div>
                        <span style="font-size: 9px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px;">Inativos (${inactiveBids.length})</span>
                        <div style="flex: 1; height: 1px; background: #e2e8f0;"></div>
                    </div>
                `;
                html += inactiveBids.map(renderBid).join('');
            }

            container.innerHTML = html;

            // Setup linked hover between tables
            setupLinkedHover();
        }

        // Distrito bar tooltip
        let distritoTip = null;
        function showDistritoTip(e, label, count, color) {
            if (!distritoTip) {
                distritoTip = document.createElement('div');
                distritoTip.style.cssText = 'position: fixed; padding: 6px 10px; background: white; border: 1px solid #e2e8f0; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 11px; border-radius: 6px; pointer-events: none; z-index: 9999; white-space: nowrap;';
                document.body.appendChild(distritoTip);
            }
            distritoTip.innerHTML = `<div style="display: flex; align-items: center; gap: 6px;"><span style="width: 10px; height: 10px; background: ${color}; border-radius: 2px;"></span><span style="color: #64748b;">${label}</span><span style="font-weight: 700; color: #1e293b;">${count}</span></div>`;
            distritoTip.style.display = 'block';
            distritoTip.style.left = (e.clientX + 12) + 'px';
            distritoTip.style.top = (e.clientY - 30) + 'px';
        }
        function hideDistritoTip() {
            if (distritoTip) distritoTip.style.display = 'none';
        }

        // Chart instance
        let districtsChart = null;

        async function loadDistrictBreakdownWidget() {
            const container = document.getElementById('dash-districts-breakdown');
            const chartCanvas = document.getElementById('districts-chart');
            if (!container) return;

            try {
                const response = await fetch(`${API_BASE}/api/dashboard/stats-by-distrito?limit=5`);
                const districts = await response.json();

                if (districts.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #94a3b8; font-size: 11px;">Sem dados</div>';
                    return;
                }

                const maxTotal = Math.max(...districts.map(d => d.total));
                const types = [
                    { key: 'imoveis', label: 'Imoveis', color: '#3b82f6' },
                    { key: 'veiculos', label: 'Veiculos', color: '#22c55e' },
                    { key: 'direitos', label: 'Direitos', color: '#f59e0b' },
                    { key: 'equipamentos', label: 'Equip.', color: '#8b5cf6' },
                    { key: 'mobiliario', label: 'Mobil.', color: '#ec4899' },
                    { key: 'maquinas', label: 'Maquinas', color: '#64748b' }
                ];

                // Create/Update Donut Chart
                if (chartCanvas && typeof Chart !== 'undefined') {
                    const chartColors = ['#3b82f6', '#22c55e', '#f59e0b', '#8b5cf6', '#ec4899'];
                    const chartData = {
                        labels: districts.map(d => d.distrito),
                        datasets: [{
                            data: districts.map(d => d.total),
                            backgroundColor: chartColors.slice(0, districts.length),
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    };

                    if (districtsChart) {
                        districtsChart.data = chartData;
                        districtsChart.update('none');
                    } else {
                        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                        districtsChart = new Chart(chartCanvas, {
                            type: 'doughnut',
                            data: chartData,
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                cutout: '65%',
                                plugins: {
                                    legend: { display: false },
                                    tooltip: {
                                        backgroundColor: isDark ? '#1e293b' : 'white',
                                        titleColor: isDark ? '#f1f5f9' : '#1e293b',
                                        bodyColor: isDark ? '#cbd5e1' : '#64748b',
                                        borderColor: isDark ? '#334155' : '#e2e8f0',
                                        borderWidth: 1,
                                        padding: 10,
                                        displayColors: true,
                                        callbacks: {
                                            label: (ctx) => ` ${ctx.parsed} eventos`
                                        }
                                    }
                                },
                                animation: {
                                    animateRotate: true,
                                    animateScale: true
                                }
                            }
                        });
                    }
                }

                container.innerHTML = districts.map((d, idx) => {
                    const barWidth = Math.round((d.total / maxTotal) * 100);
                    const chartColor = ['#3b82f6', '#22c55e', '#f59e0b', '#8b5cf6', '#ec4899'][idx] || '#64748b';

                    // Stacked bar segments with hover tooltip
                    const segments = types.filter(t => d[t.key] > 0).map(t => {
                        const pct = (d[t.key] / d.total) * 100;
                        return `<div class="distrito-seg" style="width: ${pct}%; background: ${t.color}; height: 100%; position: relative; cursor: pointer; transition: opacity 0.15s;" data-label="${t.label}" data-count="${d[t.key]}" onmouseenter="this.style.opacity='0.8'; showDistritoTip(event, '${t.label}', ${d[t.key]}, '${t.color}');" onmouseleave="this.style.opacity='1'; hideDistritoTip();"></div>`;
                    }).join('');

                    return `
                        <div style="display: flex; align-items: center; gap: 10px; padding: 4px 0;">
                            <span style="width: 10px; height: 10px; background: ${chartColor}; border-radius: 2px; flex-shrink: 0;"></span>
                            <span style="font-size: 11px; font-weight: 500; color: #475569; width: 70px; text-align: left;">${d.distrito}</span>
                            <div style="flex: 1; height: 16px; background: #f1f5f9; border-radius: 3px; overflow: hidden;">
                                <div style="display: flex; height: 100%; width: ${barWidth}%; transition: width 0.3s;">${segments}</div>
                            </div>
                            <span style="font-size: 11px; font-weight: 600; color: #1e293b; width: 28px;">${d.total}</span>
                        </div>
                    `;
                }).join('') + `
                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e2e8f0;">
                    ${types.map(t => `<span style="font-size: 9px; color: #64748b; display: flex; align-items: center; gap: 3px;"><span style="width: 8px; height: 8px; background: ${t.color}; border-radius: 2px;"></span>${t.label}</span>`).join('')}
                </div>`;

            } catch (error) {
                console.error('Erro ao carregar stats por distrito:', error);
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444; font-size: 11px;">Erro</div>';
            }
        }

        function scrollNewEvents(direction) {
            const track = document.getElementById('new-events-track');
            if (!track) return;
            const scrollAmount = 300;
            track.scrollBy({ left: direction === 'right' ? scrollAmount : -scrollAmount, behavior: 'smooth' });
        }

        function getTimeLeftShort(endDate) {
            const now = new Date();
            const diff = endDate - now;
            if (diff <= 0) return 'Fim';
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            if (days > 0) return `${days}d`;
            if (hours > 0) return `${hours}h`;
            return `${mins}m`;
        }

        // New Events Banner Functions
        function createNewEventCard(e, animate = true) {
            const valorMinimo = e.valor_minimo || e.valor_base || 0;
            const priceStr = Number(valorMinimo).toLocaleString('pt-PT', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + '‚Ç¨';
            const refPrefix = e.reference?.substring(0, 2) || '';
            const prefixColor = refPrefix === 'LO' ? '#3b82f6' : '#f59e0b';
            const location = [e.concelho, e.distrito].filter(Boolean).join(', ') || '-';
            const hasImage = e.capa && e.capa.length > 0;

            const card = document.createElement('div');
            card.className = 'new-event-card';
            card.dataset.reference = e.reference;
            card.onclick = () => openInspectionModal(e.reference);

            // For animation: start with 0 width to create push effect
            if (animate) {
                card.style.cssText = `
                    flex-shrink: 0;
                    max-width: 0;
                    width: 150px;
                    opacity: 0;
                    overflow: hidden;
                    background: white;
                    border-radius: 10px;
                    cursor: pointer;
                    border: 1px solid #e2e8f0;
                    margin-right: -10px;
                    transition: max-width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1),
                                opacity 0.4s ease-out 0.1s,
                                margin-right 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
                `;
            } else {
                card.style.cssText = `
                    flex-shrink: 0;
                    width: 150px;
                    background: white;
                    border-radius: 10px;
                    overflow: hidden;
                    cursor: pointer;
                    transition: transform 0.2s ease, box-shadow 0.2s ease;
                    border: 1px solid #e2e8f0;
                `;
            }

            card.innerHTML = `
                <div style="height: 80px; background: ${hasImage ? `url('${e.capa}') center/cover` : 'linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%)'}; position: relative;">
                    ${!hasImage ? '<span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 28px; opacity: 0.4;">üè†</span>' : ''}
                </div>
                <div style="padding: 8px;">
                    <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 4px;">
                        <span style="background: ${prefixColor}; color: white; font-size: 9px; font-weight: 700; padding: 2px 5px; border-radius: 3px;">${refPrefix}</span>
                        <span style="font-size: 10px; color: #64748b; font-weight: 500;">${e.reference.substring(2)}</span>
                    </div>
                    <div style="font-size: 13px; font-weight: 600; color: #1e293b; margin-bottom: 2px;">${priceStr}</div>
                    <div style="font-size: 10px; color: #64748b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${location}">${location}</div>
                </div>
            `;

            if (!animate) {
                card.onmouseover = () => { card.style.transform = 'translateY(-3px)'; card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)'; };
                card.onmouseout = () => { card.style.transform = ''; card.style.boxShadow = ''; };
            }

            return card;
        }

        // Add new event to banner (called from SSE)
        function addNewEventToTrack(eventData) {
            const track = document.getElementById('new-events-track');
            const countBadge = document.getElementById('new-events-count');
            if (!track) return;

            // Remove "loading" or "no events" message if present
            const loadingMsg = track.querySelector('div[style*="padding: 20px"]');
            if (loadingMsg) loadingMsg.remove();

            // Check if event already exists
            if (track.querySelector(`[data-reference="${eventData.reference}"]`)) return;

            // Create card with animation enabled
            const card = createNewEventCard(eventData, true);
            track.insertBefore(card, track.firstChild);

            // Trigger the push animation
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    // Expand from 0 to full width - this pushes other cards
                    card.style.maxWidth = '150px';
                    card.style.marginRight = '0';
                    card.style.opacity = '1';
                    card.style.overflow = 'hidden';

                    // After animation completes, enable hover effects
                    setTimeout(() => {
                        card.style.transition = 'transform 0.2s ease, box-shadow 0.2s ease';
                        card.style.overflow = 'hidden';
                        card.onmouseover = () => { card.style.transform = 'translateY(-3px)'; card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)'; };
                        card.onmouseout = () => { card.style.transform = ''; card.style.boxShadow = ''; };
                    }, 600);
                });
            });

            // Scroll to start to see new event
            track.scrollTo({ left: 0, behavior: 'smooth' });

            // Update count
            const currentCount = parseInt(countBadge?.textContent || '0');
            if (countBadge) countBadge.textContent = currentCount + 1;
        }

        // Load initial events for banner
        async function loadNewEventsBanner() {
            const track = document.getElementById('new-events-track');
            const countBadge = document.getElementById('new-events-count');
            if (!track) return;

            try {
                const response = await fetch(`${API_BASE}/api/dashboard/recent-events?limit=20&days=7`);
                if (!response.ok) throw new Error('Failed to load events');

                const events = await response.json();

                // Clear track
                track.innerHTML = '';

                if (events.length === 0) {
                    track.innerHTML = '<div style="color: #94a3b8; font-size: 11px; padding: 20px; white-space: nowrap;">Nenhum evento recente</div>';
                    if (countBadge) countBadge.textContent = '0';
                    return;
                }

                // Already sorted by scraped_at DESC from API

                // Add cards (without animation for initial load)
                events.forEach(e => {
                    const card = createNewEventCard(e, false);
                    track.appendChild(card);
                });

                // Update count
                if (countBadge) countBadge.textContent = events.length;

                // Update notification icons for carousel cards
                updateNotificationIcons();
            } catch (error) {
                console.error('Erro ao carregar novos eventos:', error);
                track.innerHTML = '<div style="color: #94a3b8; font-size: 11px; padding: 20px; white-space: nowrap;">Erro ao carregar</div>';
            }
        }

        // Load dashboard widgets on page load and refresh periodically
        loadDashboardWidgets();
        setInterval(loadDashboardWidgets, 60000); // Refresh every minute

        // Scraper Control Functions
        let scraperPollInterval = null;

        function initScraperControls() {
            const btnStart = document.getElementById('btn-start-scraper');
            const btnStop = document.getElementById('btn-stop-scraper');
            const intervalSelect = document.getElementById('scrape-interval');

            btnStart?.addEventListener('click', startScraper);
            btnStop?.addEventListener('click', stopScraper);
            intervalSelect?.addEventListener('change', updateSchedule);
        }

        async function startScraper() {
            try {
                const btnStart = document.getElementById('btn-start-scraper');
                btnStart.disabled = true;
                btnStart.textContent = '‚è≥ A iniciar...';

                const interval = document.getElementById('scrape-interval').value;
                const maxPages = null; // Scrape all pages

                const response = await fetch(`${API_BASE}/scrape/all${maxPages ? '?max_pages=' + maxPages : ''}`, {
                    method: 'POST'
                });

                if (!response.ok) throw new Error('Erro ao iniciar scraper');

                // Update schedule if not manual
                if (interval !== 'manual') {
                    await updateSchedule();
                }

                // Start polling status
                startStatusPolling();

            } catch (error) {
                alert('‚ùå Erro ao iniciar scraper: ' + error.message);
                console.error(error);
                const btnStart = document.getElementById('btn-start-scraper');
                btnStart.disabled = false;
                btnStart.textContent = 'Iniciar';
            }
        }

        async function stopScraper() {
            try {
                const btnStop = document.getElementById('btn-stop-scraper');
                btnStop.disabled = true;
                btnStop.textContent = '‚è≥ A parar...';

                const response = await fetch(`${API_BASE}/scrape/stop`, {
                    method: 'POST'
                });

                if (!response.ok) throw new Error('Erro ao parar scraper');

                stopStatusPolling();
                updateScraperStatus();

            } catch (error) {
                alert('‚ùå Erro ao parar scraper: ' + error.message);
                console.error(error);
                const btnStop = document.getElementById('btn-stop-scraper');
                btnStop.disabled = false;
                btnStop.textContent = 'Parar';
            }
        }

        async function updateSchedule() {
            try {
                const interval = document.getElementById('scrape-interval').value;

                if (interval === 'manual') {
                    // Disable schedule
                    const response = await fetch(`${API_BASE}/scrape/schedule`, {
                        method: 'DELETE'
                    });

                    if (!response.ok && response.status !== 404) {
                        console.warn('Erro ao cancelar agendamento');
                    }
                } else {
                    // Set schedule (use query parameter)
                    const response = await fetch(`${API_BASE}/scrape/schedule?hours=${interval}`, {
                        method: 'POST'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log('Agendamento criado:', data);
                    }
                }
            } catch (error) {
                console.error('Erro ao atualizar schedule:', error);
            }
        }

        function startStatusPolling() {
            if (scraperPollInterval) clearInterval(scraperPollInterval);

            scraperPollInterval = setInterval(updateScraperStatus, 2000);
            updateScraperStatus(); // Update immediately
        }

        function stopStatusPolling() {
            if (scraperPollInterval) {
                clearInterval(scraperPollInterval);
                scraperPollInterval = null;
            }
        }

        async function updateScraperStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/scrape/status`);
                if (!response.ok) return; // Silently fail if endpoint doesn't exist

                const status = await response.json();

                // These elements were removed - skip if not present
                const statusDiv = document.getElementById('scraper-status');
                const statusText = document.getElementById('scraper-status-text');
                const progressDiv = document.getElementById('scraper-progress');
                const progressText = document.getElementById('progress-text');
                const progressCount = document.getElementById('progress-count');
                const progressFill = document.getElementById('progress-bar-fill');
                const btnStart = document.getElementById('btn-start-scraper');
                const btnStop = document.getElementById('btn-stop-scraper');

                if (!statusDiv) return; // Elements don't exist, skip update

                if (status.is_running) {
                    // Scraper is running
                    statusDiv.className = 'scraper-status running';
                    if (statusText) statusText.textContent = 'A correr';
                    if (progressDiv) progressDiv.classList.add('active');
                    if (btnStart) btnStart.disabled = true;
                    if (btnStop) btnStop.disabled = false;

                    // Update progress
                    const processed = status.events_processed || 0;
                    const failed = status.events_failed || 0;
                    const currentPage = status.current_page || 0;

                    if (progressText) progressText.textContent = `P√°gina ${currentPage} ‚Ä¢ ${failed} falhas`;
                    if (progressCount) progressCount.textContent = `${processed} eventos processados`;
                    if (progressFill) progressFill.style.width = '100%'; // Indeterminate progress

                    // Continue polling
                    if (!scraperPollInterval) {
                        startStatusPolling();
                    }
                } else {
                    // Scraper is stopped
                    statusDiv.className = 'scraper-status stopped';
                    if (statusText) statusText.textContent = 'Parado';
                    if (progressDiv) progressDiv.classList.remove('active');
                    if (btnStart) btnStart.disabled = false;
                    if (btnStop) btnStop.disabled = true;

                    // Stop polling
                    stopStatusPolling();

                    // Reload stats if scraper just finished
                    if (status.events_processed > 0) {
                        loadDashboard();
                    }
                }
            } catch (error) {
                console.error('Erro ao verificar status:', error);
                stopStatusPolling();
            }
        }

        // Load All Events (unified page)
        let allEventsCached = [];
        async function loadAllEvents(page = 1) {
            const content = document.getElementById('eventos-content');

            // Show skeleton loading on first load
            if (allEventsCached.length === 0) {
                content.innerHTML = createSkeletonGrid(8);
            }

            try {
                // Load ALL events if not cached
                if (allEventsCached.length === 0) {
                    const response = await fetch(`${API_BASE}/api/events?limit=5000`);
                    const data = await response.json();
                    allEventsCached = normalizeEvents(data.events);

                    // Populate distrito filter
                    const distritos = [...new Set(allEventsCached.map(e => e.detalhes?.distrito).filter(Boolean))].sort();
                    const distritoSelect = document.getElementById('distrito-eventos');
                    if (distritoSelect) {
                        distritoSelect.innerHTML = '<option value="">Todos os distritos</option>' +
                            distritos.map(d => `<option value="${d}">${d}</option>`).join('');
                    }
                }

                // Get filter values
                const search = document.getElementById('search-eventos')?.value || '';
                const tipoId = document.getElementById('tipo-eventos')?.value || '';
                const sortBy = document.getElementById('sort-eventos')?.value || '';
                const distrito = document.getElementById('distrito-eventos')?.value || '';

                // Apply filters
                let events = [...allEventsCached];

                if (search) {
                    const searchLower = search.toLowerCase();
                    events = events.filter(e =>
                        e.reference.toLowerCase().includes(searchLower) ||
                        (e.detalhes?.tipo && e.detalhes.tipo.toLowerCase().includes(searchLower)) ||
                        (e.detalhes?.subtipo && e.detalhes.subtipo.toLowerCase().includes(searchLower)) ||
                        (e.detalhes?.distrito && e.detalhes.distrito.toLowerCase().includes(searchLower))
                    );
                }
                if (tipoId) {
                    events = events.filter(e => e.tipoId == tipoId);
                }
                if (activeTypeFilter) {
                    events = events.filter(e => e.reference.startsWith(activeTypeFilter));
                }
                if (distrito) {
                    events = events.filter(e => e.detalhes?.distrito === distrito);
                }

                // Sort
                if (sortBy) {
                    const [field, dir] = sortBy.split('_');
                    events.sort((a, b) => {
                        let valA, valB;
                        if (field === 'dataFim') {
                            valA = a.dataFim ? new Date(a.dataFim).getTime() : 0;
                            valB = b.dataFim ? new Date(b.dataFim).getTime() : 0;
                        } else if (field === 'valorBase') {
                            valA = a.valores?.valorBase || 0;
                            valB = b.valores?.valorBase || 0;
                        } else if (field === 'lanceAtual') {
                            valA = a.valores?.lanceAtual || 0;
                            valB = b.valores?.lanceAtual || 0;
                        }
                        return dir === 'asc' ? valA - valB : valB - valA;
                    });
                }

                // Pagination
                const totalPages = Math.ceil(events.length / ITEMS_PER_PAGE);
                const startIndex = (page - 1) * ITEMS_PER_PAGE;
                const pageEvents = events.slice(startIndex, startIndex + ITEMS_PER_PAGE);

                // Render using batch innerHTML
                if (pageEvents.length === 0) {
                    content.innerHTML = '<div style="text-align: center; padding: 40px; color: #94a3b8;">Nenhum evento encontrado</div>';
                } else {
                    const cardsHTML = pageEvents.map(e => createEventCardHTML(e)).join('');
                    content.innerHTML = `<div class="events-grid">${cardsHTML}</div>`;
                    setupCarouselDelegation(content, pageEvents);
                }

                // Update pagination
                const pagination = document.getElementById('pagination-eventos');
                if (pagination) {
                    if (totalPages <= 1) {
                        pagination.style.display = 'none';
                    } else {
                        pagination.style.display = 'flex';
                        pagination.innerHTML = `
                            <button ${page === 1 ? 'disabled' : ''} onclick="loadAllEvents(${page - 1})">
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
                                </svg>
                                Anterior
                            </button>
                            <span class="page-info">P√°gina ${page} de ${totalPages} (${events.length} eventos)</span>
                            <button ${page === totalPages ? 'disabled' : ''} onclick="loadAllEvents(${page + 1})">
                                Pr√≥xima
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
                                </svg>
                            </button>
                        `;
                    }
                }

                // Add filter listeners if first time
                setupEventosFilters();

                // Update notification icons after events are loaded
                updateNotificationIcons();

                // Update favorite star button states
                console.log('[loadAllEvents] Calling updateFavoriteStars');
                await updateFavoriteStars();

            } catch (error) {
                console.error('Erro ao carregar eventos:', error);
                content.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Erro ao carregar eventos</div>';
            }
        }

        // Debounce utility
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        let eventosFiltersSetup = false;
        function setupEventosFilters() {
            if (eventosFiltersSetup) return;
            eventosFiltersSetup = true;

            const debouncedSearch = debounce(() => loadAllEvents(1), 300);

            ['search-eventos', 'tipo-eventos', 'sort-eventos', 'distrito-eventos'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('change', () => loadAllEvents(1));
                    if (id === 'search-eventos') {
                        el.addEventListener('input', debouncedSearch);
                    }
                }
            });
        }

        function clearFiltersEventos() {
            document.getElementById('search-eventos').value = '';
            document.getElementById('tipo-eventos').value = '';
            document.getElementById('sort-eventos').value = '';
            document.getElementById('distrito-eventos').value = '';
            loadAllEvents(1);
        }

        // Load Events
        async function loadEvents(type, page = 1) {
            const contentId = `${type}-content`;
            const content = document.getElementById(contentId);

            // Show skeleton loading on first load
            if (allLoadedEvents[type].length === 0) {
                content.innerHTML = createSkeletonGrid(8);
            }

            try {
                // Load ALL events if not already loaded
                if (allLoadedEvents[type].length === 0) {
                    let url = `${API_BASE}/api/events?limit=5000`;
                    url += `&tipo_evento=${type}`;

                    const response = await fetch(url);
                    const data = await response.json();

                    // Normalize events to handle both old and new API formats
                    allLoadedEvents[type] = normalizeEvents(data.events);

                    // Collect distritos, subtipos, tipologias (using normalized data)
                    if (type === 'imoveis') {
                        allLoadedEvents[type].forEach(event => {
                            if (event.detalhes) {
                                if (event.detalhes.distrito) allDistritos.add(event.detalhes.distrito);
                                if (event.detalhes.subtipo && event.detalhes.subtipo !== 'N/A') allSubtipos.add(event.detalhes.subtipo);
                                if (event.detalhes.tipologia) allTipologias.add(event.detalhes.tipologia);
                            }
                        });
                        updateDistritoFilter();
                        updateSubtipoFilter();
                        updateTipologiaFilter();
                    }
                }

                // Get filter values
                const searchInput = document.getElementById(`search-${type}`);
                const distritoSelect = document.getElementById(`distrito-${type}`);
                const concelhoSelect = document.getElementById(`concelho-${type}`);
                const freguesiaSelect = document.getElementById(`freguesia-${type}`);
                const sortSelect = document.getElementById(`sort-${type}`);
                const subtipoSelect = document.getElementById(`subtipo-${type}`);
                const tipologiaSelect = document.getElementById(`tipologia-${type}`);
                const valorMinInput = document.getElementById(`valor-min-${type}`);
                const valorMaxInput = document.getElementById(`valor-max-${type}`);

                const search = searchInput ? searchInput.value : '';
                const distrito = distritoSelect ? distritoSelect.value : '';
                const concelho = concelhoSelect ? concelhoSelect.value : '';
                const freguesia = freguesiaSelect ? freguesiaSelect.value : '';
                const sortBy = sortSelect ? sortSelect.value : '';
                const subtipo = subtipoSelect ? subtipoSelect.value : '';
                const tipologia = tipologiaSelect ? tipologiaSelect.value : '';
                const valorMin = valorMinInput ? parseFloat(valorMinInput.value) || 0 : 0;
                const valorMax = valorMaxInput ? parseFloat(valorMaxInput.value) || Infinity : Infinity;

                // Apply ALL filters to create filtered list
                let events = [...allLoadedEvents[type]];

                if (search) {
                    const searchLower = search.toLowerCase();
                    events = events.filter(e =>
                        e.reference.toLowerCase().includes(searchLower) ||
                        (e.detalhes?.tipo && e.detalhes.tipo.toLowerCase().includes(searchLower)) ||
                        (e.detalhes?.subtipo && e.detalhes.subtipo.toLowerCase().includes(searchLower)) ||
                        (e.detalhes?.distrito && e.detalhes.distrito.toLowerCase().includes(searchLower)) ||
                        (e.detalhes?.concelho && e.detalhes.concelho.toLowerCase().includes(searchLower)) ||
                        (e.detalhes?.freguesia && e.detalhes.freguesia.toLowerCase().includes(searchLower))
                    );
                }
                if (activeTypeFilter) {
                    events = events.filter(e => e.reference.startsWith(activeTypeFilter));
                }
                if (distrito) {
                    events = events.filter(e => e.detalhes?.distrito === distrito);
                }
                if (concelho) {
                    events = events.filter(e => e.detalhes?.concelho === concelho);
                }
                if (freguesia) {
                    events = events.filter(e => e.detalhes?.freguesia === freguesia);
                }
                if (subtipo) {
                    events = events.filter(e => e.detalhes?.subtipo === subtipo);
                }
                if (tipologia) {
                    events = events.filter(e => e.detalhes?.tipologia === tipologia);
                }
                if (valorMin > 0 || valorMax < Infinity) {
                    events = events.filter(e => {
                        const valor = e.valores?.valorBase || 0;
                        return valor >= valorMin && valor <= valorMax;
                    });
                }

                // Apply sorting
                if (sortBy) {
                    const [field, order] = sortBy.split('_');
                    events.sort((a, b) => {
                        let valueA, valueB;

                        switch(field) {
                            case 'dataInicio':
                                valueA = a.dataInicio ? new Date(a.dataInicio) : new Date(0);
                                valueB = b.dataInicio ? new Date(b.dataInicio) : new Date(0);
                                break;
                            case 'dataFim':
                                valueA = a.dataFim ? new Date(a.dataFim) : new Date(0);
                                valueB = b.dataFim ? new Date(b.dataFim) : new Date(0);
                                break;
                            case 'valorBase':
                                valueA = a.valores?.valorBase || 0;
                                valueB = b.valores?.valorBase || 0;
                                break;
                            case 'valorMinimo':
                                valueA = a.valores?.valorMinimo || 0;
                                valueB = b.valores?.valorMinimo || 0;
                                break;
                            case 'lanceAtual':
                                valueA = a.valores?.lanceAtual || 0;
                                valueB = b.valores?.lanceAtual || 0;
                                break;
                            default:
                                return 0;
                        }

                        if (order === 'asc') {
                            return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
                        } else {
                            return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
                        }
                    });
                }

                // Store filtered events
                filteredEvents[type] = events;

                // Calculate pagination
                const totalItems = events.length;
                const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
                currentPageData[type] = page;
                totalPagesData[type] = totalPages;

                // Get items for current page
                const startIdx = (page - 1) * ITEMS_PER_PAGE;
                const endIdx = startIdx + ITEMS_PER_PAGE;
                const pageEvents = events.slice(startIdx, endIdx);

                if (pageEvents.length === 0) {
                    content.innerHTML = `
                        <div class="no-data">
                            <svg class="no-data-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <div class="no-data-text">Nenhum evento encontrado</div>
                        </div>
                    `;
                    document.getElementById(`pagination-${type}`).style.display = 'none';
                    return;
                }

                // Batch render all cards using innerHTML for performance
                const cardsHTML = pageEvents.map(event => createEventCardHTML(event)).join('');
                content.innerHTML = `<div class="events-grid">${cardsHTML}</div>`;

                // Setup event delegation for carousels after DOM is ready
                setupCarouselDelegation(content, pageEvents);

                updatePagination(type);

                // Update favorite star button states (await to ensure cache is loaded)
                console.log('[loadEvents] About to call updateFavoriteStars, cards rendered:', pageEvents.length);
                await updateFavoriteStars();
                console.log('[loadEvents] updateFavoriteStars completed');

            } catch (error) {
                console.error('Erro ao carregar eventos:', error);
                content.innerHTML = `
                    <div class="no-data">
                        <div class="no-data-text">Erro ao carregar eventos</div>
                    </div>
                `;
            }
        }

        // Generate skeleton loading grid
        function createSkeletonGrid(count = 12) {
            const skeletonCardHTML = `
                <div class="skeleton-card">
                    <div class="skeleton-header">
                        <div class="skeleton-element skeleton-badge"></div>
                        <div class="skeleton-element skeleton-type"></div>
                    </div>
                    <div class="skeleton-element skeleton-image"></div>
                    <div class="skeleton-body">
                        <div class="skeleton-section">
                            <div class="skeleton-element skeleton-title"></div>
                            <div class="skeleton-row">
                                <div class="skeleton-element skeleton-label"></div>
                                <div class="skeleton-element skeleton-value"></div>
                            </div>
                            <div class="skeleton-row">
                                <div class="skeleton-element skeleton-label"></div>
                                <div class="skeleton-element skeleton-value"></div>
                            </div>
                        </div>
                        <div class="skeleton-section">
                            <div class="skeleton-element skeleton-title"></div>
                            <div class="skeleton-row">
                                <div class="skeleton-element skeleton-label"></div>
                                <div class="skeleton-element skeleton-value"></div>
                            </div>
                            <div class="skeleton-row">
                                <div class="skeleton-element skeleton-label"></div>
                                <div class="skeleton-element skeleton-value"></div>
                            </div>
                            <div class="skeleton-row">
                                <div class="skeleton-element skeleton-label"></div>
                                <div class="skeleton-element skeleton-value"></div>
                            </div>
                        </div>
                        <div class="skeleton-section">
                            <div class="skeleton-element skeleton-title"></div>
                            <div class="skeleton-row">
                                <div class="skeleton-element skeleton-label"></div>
                                <div class="skeleton-element skeleton-value"></div>
                            </div>
                            <div class="skeleton-row">
                                <div class="skeleton-element skeleton-label"></div>
                                <div class="skeleton-element skeleton-value"></div>
                            </div>
                        </div>
                    </div>
                    <div class="skeleton-actions">
                        <div class="skeleton-element skeleton-btn"></div>
                        <div class="skeleton-element skeleton-btn"></div>
                        <div class="skeleton-element skeleton-btn"></div>
                        <div class="skeleton-element skeleton-btn"></div>
                    </div>
                </div>
            `;
            return `<div class="events-grid">${skeletonCardHTML.repeat(count)}</div>`;
        }

        // Shared format functions for card rendering
        const cardFormatDate = (dateStr) => {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleString('pt-PT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        };

        const cardFormatPrice = (price) => {
            if (!price) return 'N/A';
            return new Intl.NumberFormat('pt-PT', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(price);
        };

        const cardTipoInfo = {
            1: { name: 'Im√≥vel', class: 'imovel', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>' },
            2: { name: 'Ve√≠culo', class: 'veiculo', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M8 17h8M8 17v-4m8 4v-4m-8 0h8m-8 0l-2-4h12l-2 4M6 17H4a1 1 0 01-1-1v-1a2 2 0 012-2h14a2 2 0 012 2v1a1 1 0 01-1 1h-2"/>' },
            3: { name: 'Equipamento', class: 'equipamento', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>' },
            4: { name: 'Mobili√°rio', class: 'mobiliario', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>' },
            5: { name: 'M√°quina', class: 'maquina', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>' },
            6: { name: 'Direito', class: 'direito', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>' }
        };

        // Returns HTML string for performance (no DOM creation)
        function createEventCardHTML(event) {
            const typePrefix = event.reference.substring(0, 2);
            const typePrefixClass = typePrefix === 'LO' ? 'lo' : 'np';
            const tipoId = event.tipoId || 1;
            const currentTipo = cardTipoInfo[tipoId] || cardTipoInfo[1];
            const getValue = (val) => val || 'N/A';
            const referenceWithoutPrefix = event.reference.substring(2);

            // Build carousel/image HTML - show all images if available, otherwise capa
            let imageHTML = '';
            const images = (event.imagens && event.imagens.length > 0) ? event.imagens : (event.capa ? [event.capa] : []);
            const imageCount = images.length;

            if (imageCount > 0) {
                const imagesHTML = images.map((img, idx) =>
                    `<div class="event-carousel-image" data-bg="${img}"${idx === 0 ? '' : ' data-lazy="true"'}></div>`
                ).join('');

                const indicatorsHTML = images.map((_, idx) =>
                    `<div class="event-carousel-indicator ${idx === 0 ? 'active' : ''}" data-index="${idx}"></div>`
                ).join('');

                imageHTML = `
                    <div class="event-carousel" data-reference="${event.reference}" data-image-count="${imageCount}">
                        <div class="event-carousel-images">
                            ${imagesHTML}
                        </div>
                        ${imageCount > 1 ? `
                            <button class="event-carousel-nav prev">
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
                                </svg>
                            </button>
                            <button class="event-carousel-nav next">
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
                                </svg>
                            </button>
                            <div class="event-carousel-indicators">
                                ${indicatorsHTML}
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                imageHTML = `
                    <div class="event-carousel">
                        <div class="event-carousel-placeholder">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="width: 48px; height: 48px;">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </div>
                    </div>
                `;
            }

            // Build location badge if available
            let locationBadgeHTML = '';
            const locationParts = [];
            if (event.detalhes?.distrito) locationParts.push(event.detalhes.distrito);
            if (event.detalhes?.concelho) locationParts.push(event.detalhes.concelho);
            if (event.detalhes?.freguesia) locationParts.push(event.detalhes.freguesia);

            if (locationParts.length > 0) {
                locationBadgeHTML = `
                    <div class="event-location-badge">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        <span>${locationParts.join(', ')}</span>
                    </div>
                `;
            }

            // Escape single quotes for JSON data attribute
            const eventDataJSON = JSON.stringify({
                titulo: event.titulo,
                tipo: event.detalhes?.tipo,
                subtipo: event.detalhes?.subtipo,
                distrito: event.localizacao?.distrito,
                data_fim: event.dataFim,
                lance_atual: event.valores?.lanceAtual,
                valor_base: event.valores?.valorBase
            }).replace(/'/g, "&apos;");

            return `
            <div class="event-card" data-reference="${event.reference}">
                <div class="event-card-header">
                    <div class="event-ref-badge">
                        <span class="event-type-prefix ${typePrefixClass}">${typePrefix}</span>
                        <span class="event-ref-text">${referenceWithoutPrefix}</span>
                    </div>
                    <div class="event-type-badge ${currentTipo.class}">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            ${currentTipo.icon}
                        </svg>
                        ${currentTipo.name}
                    </div>
                </div>

                ${imageHTML}
                ${locationBadgeHTML}

                <div class="event-card-body">
                    <div class="event-section">
                        <div class="section-title">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Informa√ß√µes B√°sicas
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Tipo:</span>
                            <span class="detail-value ${!event.detalhes?.tipo || event.detalhes.tipo === 'N/A' ? 'empty' : ''}">${getValue(event.detalhes?.tipo)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Subtipo:</span>
                            <span class="detail-value ${!event.detalhes?.subtipo || event.detalhes.subtipo === 'N/A' ? 'empty' : ''}">${getValue(event.detalhes?.subtipo)}</span>
                        </div>
                        ${(event.tipoEvento === 'imoveis' || event.tipoId === 1) ? `
                            <div class="detail-row">
                                <span class="detail-label">Tipologia:</span>
                                <span class="detail-value ${!event.detalhes?.tipologia ? 'empty' : ''}">${getValue(event.detalhes?.tipologia)}</span>
                            </div>
                        ` : ''}
                        ${(event.tipoEvento === 'veiculos' || event.tipoId === 2) ? `
                            <div class="detail-row">
                                <span class="detail-label">Matr√≠cula:</span>
                                <span class="detail-value ${!event.detalhes?.matricula ? 'empty' : ''}">${getValue(event.detalhes?.matricula)}</span>
                            </div>
                        ` : ''}
                    </div>

                    <div class="event-section">
                        <div class="section-title">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Valores
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Valor Base:</span>
                            <span class="detail-value ${!event.valores?.valorBase ? 'empty' : 'price'}">${cardFormatPrice(event.valores?.valorBase)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Valor Abertura:</span>
                            <span class="detail-value ${!event.valores?.valorAbertura ? 'empty' : 'price'}">${cardFormatPrice(event.valores?.valorAbertura)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Valor M√≠nimo:</span>
                            <span class="detail-value ${!event.valores?.valorMinimo ? 'empty' : 'price'}">${cardFormatPrice(event.valores?.valorMinimo)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Lance Atual:</span>
                            <span class="detail-value ${!event.valores?.lanceAtual ? 'empty' : 'price'}">${cardFormatPrice(event.valores?.lanceAtual)}</span>
                        </div>
                    </div>

                    <div class="event-section">
                        <div class="section-title">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            Datas do Evento
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">In√≠cio:</span>
                            <span class="detail-value ${!event.dataInicio ? 'empty' : 'date'}">${cardFormatDate(event.dataInicio)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Fim:</span>
                            <span class="detail-value ${!event.dataFim ? 'empty' : 'date'}">${cardFormatDate(event.dataFim)}</span>
                        </div>
                    </div>
                </div>

                <div class="card-actions">
                    <button class="card-action-btn" onclick="viewEvent('${event.reference}')" title="Ver no e-leiloes.pt">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                        </svg>
                    </button>
                    <button class="card-action-btn" onclick="reloadEvent('${event.reference}')" title="Recarregar dados">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                    </button>
                    <button class="card-action-btn" onclick="openLocation(${event.gps?.latitude || 'null'}, ${event.gps?.longitude || 'null'})" ${!event.gps?.latitude ? 'disabled' : ''} title="Ver no mapa">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </button>
                    <button class="card-action-btn card-favorite-btn" id="fav-event-${event.reference}" onclick="toggleFavoriteFromCard('${event.reference}', this)" title="Adicionar aos favoritos" data-event='${eventDataJSON}'>
                        <svg class="star-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                        </svg>
                    </button>
                </div>
            </div>
            `;
        }

        // Lazy loading for background images using IntersectionObserver
        let imageObserver = null;
        function setupLazyImageLoading(container) {
            // Load first images immediately (visible cards)
            const allImages = container.querySelectorAll('.event-carousel-image[data-bg]');

            // Create observer if not exists
            if (!imageObserver) {
                imageObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            if (img.dataset.bg && !img.style.backgroundImage) {
                                img.style.backgroundImage = `url('${img.dataset.bg}')`;
                            }
                            imageObserver.unobserve(img);
                        }
                    });
                }, {
                    rootMargin: '200px', // Start loading 200px before entering viewport
                    threshold: 0.01
                });
            }

            // Observe all images
            allImages.forEach(img => {
                // Load first image of each carousel immediately
                if (!img.dataset.lazy && img.dataset.bg) {
                    img.style.backgroundImage = `url('${img.dataset.bg}')`;
                } else {
                    imageObserver.observe(img);
                }
            });
        }

        // Event delegation for carousel navigation (avoids attaching listeners to each card)
        function setupCarouselDelegation(container, events) {
            // Setup lazy loading for images
            setupLazyImageLoading(container);

            // Track current carousel indices
            const carouselIndices = {};

            // Single delegated click handler for all carousels
            container.addEventListener('click', (e) => {
                const carousel = e.target.closest('.event-carousel');
                if (!carousel) return;

                const reference = carousel.dataset.reference;
                const imageCount = parseInt(carousel.dataset.imageCount) || 0;

                // Handle nav buttons
                const navBtn = e.target.closest('.event-carousel-nav');
                if (navBtn) {
                    e.stopPropagation();
                    if (imageCount <= 1) return;

                    if (!carouselIndices[reference]) carouselIndices[reference] = 0;
                    let idx = carouselIndices[reference];

                    if (navBtn.classList.contains('prev')) {
                        idx = idx > 0 ? idx - 1 : imageCount - 1;
                    } else {
                        idx = idx < imageCount - 1 ? idx + 1 : 0;
                    }

                    carouselIndices[reference] = idx;
                    updateCarouselPosition(carousel, idx);
                    return;
                }

                // Handle indicator clicks
                const indicator = e.target.closest('.event-carousel-indicator');
                if (indicator) {
                    e.stopPropagation();
                    const idx = parseInt(indicator.dataset.index);
                    carouselIndices[reference] = idx;
                    updateCarouselPosition(carousel, idx);
                    return;
                }

                // Click on carousel image opens modal
                if (reference) {
                    openInspectionModal(reference);
                }
            });
        }

        function updateCarouselPosition(carousel, index) {
            const imagesContainer = carousel.querySelector('.event-carousel-images');
            const indicators = carousel.querySelectorAll('.event-carousel-indicator');
            const images = carousel.querySelectorAll('.event-carousel-image');

            if (imagesContainer) {
                imagesContainer.style.transform = `translateX(-${index * 100}%)`;
            }
            indicators.forEach((ind, idx) => {
                ind.classList.toggle('active', idx === index);
            });

            // Lazy load the current and adjacent images when navigating
            [index - 1, index, index + 1].forEach(i => {
                if (images[i] && images[i].dataset.bg && !images[i].style.backgroundImage) {
                    images[i].style.backgroundImage = `url('${images[i].dataset.bg}')`;
                }
            });
        }

        // Legacy function for single card creation (used by reloadEvent)
        function createEventCard(event) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = createEventCardHTML(event);
            return tempDiv.firstElementChild;
        }

        // Card Actions - uses queue system for refresh
        async function reloadEvent(reference) {
            const oldCard = document.querySelector(`.event-card[data-reference="${reference}"]`);
            let originalBadgeHTML = null;

            // Helper to restore original card state
            const restoreCard = () => {
                if (oldCard) {
                    oldCard.style.opacity = '1';
                    oldCard.style.pointerEvents = 'auto';
                    const badge = oldCard.querySelector('.event-type-badge');
                    if (badge && originalBadgeHTML) {
                        badge.innerHTML = originalBadgeHTML;
                    }
                }
            };

            try {
                // Save original badge HTML and show loading indicator
                if (oldCard) {
                    const badge = oldCard.querySelector('.event-type-badge');
                    if (badge) originalBadgeHTML = badge.innerHTML;
                    oldCard.style.opacity = '0.5';
                    oldCard.style.pointerEvents = 'none';
                    if (badge) badge.innerHTML = '‚è≥ Na fila...';
                }

                // Step 1: Queue the refresh request
                const queueResponse = await fetch(`${API_BASE}/api/refresh/${reference}?refresh_type=full`, { method: 'POST' });
                if (!queueResponse.ok) throw new Error('Failed to queue');

                const queueData = await queueResponse.json();
                if (!queueData.success) throw new Error(queueData.message || 'Queue failed');

                const requestId = queueData.request_id;

                if (oldCard) {
                    const badge = oldCard.querySelector('.event-type-badge');
                    if (badge) badge.innerHTML = 'üîÑ A processar...';
                }

                // Step 2: Poll for completion (max 30 seconds)
                const maxAttempts = 30;
                for (let i = 0; i < maxAttempts; i++) {
                    await new Promise(r => setTimeout(r, 1000));

                    const statusResponse = await fetch(`${API_BASE}/api/refresh/status/${requestId}`);
                    if (!statusResponse.ok) continue;

                    const status = await statusResponse.json();

                    if (status.state === 2) {
                        // Completed - fetch updated data from our DB
                        const response = await fetch(`${API_BASE}/api/events/${reference}?t=${Date.now()}`);
                        if (!response.ok) throw new Error('Failed to fetch updated event');

                        const apiEvent = await response.json();

                        // Update the event in allLoadedEvents
                        const activePage = document.querySelector('.page.active')?.id;
                        if (!allLoadedEvents[activePage]) throw new Error('Page data not found');

                        const idx = allLoadedEvents[activePage].findIndex(e => e.reference === reference);
                        if (idx === -1) throw new Error('Event not found in local data');

                        const event = allLoadedEvents[activePage][idx];
                        // Update all relevant fields from API response
                        event.valores.lanceAtual = apiEvent.lance_atual || 0;
                        event.dataFim = apiEvent.data_fim;
                        event.dataInicio = apiEvent.data_inicio;
                        if (apiEvent.subtipo) event.subtipo = apiEvent.subtipo;
                        if (apiEvent.tipo) event.tipo = apiEvent.tipo;
                        if (apiEvent.detalhes) {
                            event.detalhes.subtipo = apiEvent.subtipo || event.detalhes.subtipo;
                            event.detalhes.tipo = apiEvent.tipo || event.detalhes.tipo;
                        }

                        // Create new card with updated data
                        const newCard = createEventCard(event);
                        newCard.style.animation = 'none';

                        if (oldCard && oldCard.parentNode) {
                            oldCard.parentNode.replaceChild(newCard, oldCard);
                            // Success highlight effect
                            newCard.style.boxShadow = '0 0 0 2px #10b981';
                            setTimeout(() => { newCard.style.boxShadow = ''; }, 1500);
                        } else {
                            // Card not in DOM anymore, just restore
                            restoreCard();
                        }
                        return;
                    } else if (status.state === 3) {
                        throw new Error(status.result_message || 'Refresh failed');
                    }
                }

                throw new Error('Timeout - demorou demasiado');
            } catch (error) {
                console.error('Erro ao recarregar evento:', error);
                restoreCard();
            }
        }

        function openLocation(lat, lng) {
            if (lat && lng) {
                window.open(`https://www.google.com/maps?q=${lat},${lng}`, '_blank');
            }
        }

        function viewEvent(reference) {
            window.open(`https://www.e-leiloes.pt/evento/${reference}`, '_blank');
        }

        // Cascade Filters
        let allEventsCache = [];

        async function updateConcelhoFilter(type) {
            const distritoSelect = document.getElementById(`distrito-${type}`);
            const concelhoSelect = document.getElementById(`concelho-${type}`);
            const freguesiaSelect = document.getElementById(`freguesia-${type}`);

            if (!distritoSelect || !concelhoSelect) return;

            const selectedDistrito = distritoSelect.value;

            // Reset concelho and freguesia
            concelhoSelect.innerHTML = '<option value="">Todos os concelhos</option>';
            freguesiaSelect.innerHTML = '<option value="">Todas as freguesias</option>';
            freguesiaSelect.disabled = true;

            if (!selectedDistrito) {
                concelhoSelect.disabled = true;
                return;
            }

            // Fetch all events if not cached
            if (allEventsCache.length === 0) {
                try {
                    const response = await fetch(`${API_BASE}/api/events?limit=1000&tipo_evento=imovel`);
                    const data = await response.json();
                    allEventsCache = data.events;
                } catch (error) {
                    console.error('Erro ao carregar eventos para filtros:', error);
                    return;
                }
            }

            // Filter events by distrito and collect unique concelhos
            const concelhos = new Set();
            allEventsCache.forEach(event => {
                if (event.detalhes.distrito === selectedDistrito && event.detalhes.concelho) {
                    concelhos.add(event.detalhes.concelho);
                }
            });

            // Populate concelho dropdown
            Array.from(concelhos).sort().forEach(concelho => {
                const option = document.createElement('option');
                option.value = concelho;
                option.textContent = concelho;
                concelhoSelect.appendChild(option);
            });

            concelhoSelect.disabled = false;
        }

        async function updateFreguesiaFilter(type) {
            const distritoSelect = document.getElementById(`distrito-${type}`);
            const concelhoSelect = document.getElementById(`concelho-${type}`);
            const freguesiaSelect = document.getElementById(`freguesia-${type}`);

            if (!distritoSelect || !concelhoSelect || !freguesiaSelect) return;

            const selectedDistrito = distritoSelect.value;
            const selectedConcelho = concelhoSelect.value;

            // Reset freguesia
            freguesiaSelect.innerHTML = '<option value="">Todas as freguesias</option>';

            if (!selectedDistrito || !selectedConcelho) {
                freguesiaSelect.disabled = true;
                return;
            }

            // Fetch all events if not cached
            if (allEventsCache.length === 0) {
                try {
                    const response = await fetch(`${API_BASE}/api/events?limit=1000&tipo_evento=imovel`);
                    const data = await response.json();
                    allEventsCache = data.events;
                } catch (error) {
                    console.error('Erro ao carregar eventos para filtros:', error);
                    return;
                }
            }

            // Filter events by distrito and concelho, collect unique freguesias
            const freguesias = new Set();
            allEventsCache.forEach(event => {
                if (event.detalhes.distrito === selectedDistrito &&
                    event.detalhes.concelho === selectedConcelho &&
                    event.detalhes.freguesia) {
                    freguesias.add(event.detalhes.freguesia);
                }
            });

            // Populate freguesia dropdown
            Array.from(freguesias).sort().forEach(freguesia => {
                const option = document.createElement('option');
                option.value = freguesia;
                option.textContent = freguesia;
                freguesiaSelect.appendChild(option);
            });

            freguesiaSelect.disabled = false;
        }

        function updateDistritoFilter() {
            const select = document.getElementById('distrito-imoveis');
            if (!select) return;

            const currentValue = select.value;
            select.innerHTML = '<option value="">Todos os distritos</option>';

            Array.from(allDistritos).sort().forEach(distrito => {
                const option = document.createElement('option');
                option.value = distrito;
                option.textContent = distrito;
                select.appendChild(option);
            });

            select.value = currentValue;
        }

        function updatePagination(type) {
            const pagination = document.getElementById(`pagination-${type}`);
            if (!pagination) return;

            const totalFiltered = filteredEvents[type].length;

            if (totalPagesData[type] <= 1) {
                pagination.style.display = 'none';
                return;
            }

            pagination.style.display = 'flex';
            pagination.innerHTML = `
                <button ${currentPageData[type] === 1 ? 'disabled' : ''} onclick="loadEvents('${type}', ${currentPageData[type] - 1})">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
                    </svg>
                    Anterior
                </button>
                <span class="page-info">P√°gina ${currentPageData[type]} de ${totalPagesData[type]} (${totalFiltered} eventos)</span>
                <button ${currentPageData[type] === totalPagesData[type] ? 'disabled' : ''} onclick="loadEvents('${type}', ${currentPageData[type] + 1})">
                    Pr√≥xima
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
                    </svg>
                </button>
            `;
        }

        function clearFilters(type) {
            const searchInput = document.getElementById(`search-${type}`);
            const distritoSelect = document.getElementById(`distrito-${type}`);
            const concelhoSelect = document.getElementById(`concelho-${type}`);
            const freguesiaSelect = document.getElementById(`freguesia-${type}`);
            const sortSelect = document.getElementById(`sort-${type}`);
            const subtipoSelect = document.getElementById(`subtipo-${type}`);
            const tipologiaSelect = document.getElementById(`tipologia-${type}`);
            const valorMinInput = document.getElementById(`valor-min-${type}`);
            const valorMaxInput = document.getElementById(`valor-max-${type}`);

            if (searchInput) searchInput.value = '';
            if (distritoSelect) distritoSelect.value = '';
            if (sortSelect) sortSelect.value = '';
            if (subtipoSelect) subtipoSelect.value = '';
            if (tipologiaSelect) tipologiaSelect.value = '';
            if (valorMinInput) valorMinInput.value = '';
            if (valorMaxInput) valorMaxInput.value = '';

            if (concelhoSelect) {
                concelhoSelect.innerHTML = '<option value="">Todos os concelhos</option>';
                concelhoSelect.disabled = true;
            }
            if (freguesiaSelect) {
                freguesiaSelect.innerHTML = '<option value="">Todas as freguesias</option>';
                freguesiaSelect.disabled = true;
            }

            activeTypeFilter = null;
            document.querySelectorAll('.type-badge').forEach(b => b.classList.remove('active'));

            currentPageData[type] = 1;
            loadEvents(type, 1);
        }

        function reloadAllData(type) {
            // Handle unified eventos page
            if (type === 'eventos') {
                allEventsCached = [];
                loadAllEvents(1);
                return;
            }
            // Clear cache to force fresh load
            allLoadedEvents[type] = [];
            filteredEvents[type] = [];
            currentPageData[type] = 1;
            loadEvents(type, 1);
        }

        // Event Listeners
        document.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                const activePage = document.querySelector('.page.active').id;
                if (activePage === 'eventos') {
                    loadAllEvents(1);
                } else if (activePage !== 'dashboard') {
                    loadEvents(activePage);
                }
            }
        });

        // Initial load
        restoreSidebarState();
        loadDashboard();
        startConsolePolling();
        checkPipelineStatusOnLoad(); // Retomar pipeline se ativa
        loadAutoPipelinesStatus(); // Carregar status das pipelines autom√°ticas

        // ============== MULTI-STAGE SCRAPING FUNCTIONS ==============

        // Global storage for stage results
        let stage1Results = [];
        let stage2Results = [];
        let collectedIds = []; // IDs from independent scraper

        // Run specific IDs scraping
        function runSpecificIds() {
            const input = document.getElementById('specific-ids-input').value;
            if (!input.trim()) {
                showModal('‚ö†Ô∏è Aviso', 'Introduz pelo menos um ID');
                return;
            }
            runIndependentScraperWithIds(input);
        }

        async function runIndependentScraperWithIds(idsString) {
            const ids = idsString.split(/[,\s\n]+/).map(s => s.trim()).filter(s => s);
            if (ids.length === 0) return;

            addLog(`üéØ A processar ${ids.length} IDs espec√≠ficos...`, 'info');
            // TODO: Implement specific IDs scraping endpoint
            showModal('üéØ IDs Espec√≠ficos', `${ids.length} IDs prontos para processar:\n${ids.join(', ')}`);
        }

        // Display collected IDs - simplified summary only
        function displayCollectedIds(ids) {
            collectedIds = ids;
            const section = document.getElementById('ids-results-section');
            const list = document.getElementById('ids-results-list');
            const badge = document.getElementById('ids-count-badge');

            if (!ids || ids.length === 0) {
                if (section) section.style.display = 'none';
                return;
            }

            // Group IDs by tipo_evento and count only
            const grouped = {};
            ids.forEach(item => {
                const tipo = item.tipo_evento || 'outros';
                grouped[tipo] = (grouped[tipo] || 0) + 1;
            });

            // Build simple summary HTML
            const tipoLabels = {
                'imoveis': 'üè†',
                'veiculos': 'üöó',
                'direitos': 'üìú',
                'equipamentos': 'üîß',
                'mobiliario': 'ü™ë',
                'maquinas': '‚öôÔ∏è',
                'outros': 'üì¶'
            };

            const summary = Object.entries(grouped)
                .map(([tipo, count]) => `${tipoLabels[tipo] || 'üì¶'} ${count}`)
                .join('  ');

            if (section) section.style.display = 'block';
            if (list) list.innerHTML = `<div style="text-align: center; color: #64748b; padding: 4px;">${summary}</div>`;
            if (badge) badge.textContent = ids.length;
        }

        // Copy IDs to clipboard
        function copyIdsToClipboard() {
            if (collectedIds.length === 0) return;
            const text = collectedIds.map(item => item.reference).join('\n');
            navigator.clipboard.writeText(text).then(() => {
                addLog(`üìã ${collectedIds.length} IDs copiados para clipboard`, 'success');
            });
        }

        // Clear collected IDs
        function clearCollectedIds() {
            collectedIds = [];
            const section = document.getElementById('ids-results-section');
            if (section) section.style.display = 'none';
            addLog('üóëÔ∏è IDs limpos', 'info');
        }

        // ========== DB MAINTENANCE FUNCTIONS ==========

        // Refresh DB stats
        async function refreshDbStats(silent = false) {
            try {
                const response = await fetch(`${API_BASE}/api/db/stats`);
                const data = await response.json();

                const setEl = (id, val) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = val || 0;
                };
                // Update scraping page stats
                setEl('db-stat-total-scraping', data.total);
                setEl('db-stat-content-scraping', data.with_content);
                setEl('db-stat-incomplete-scraping', data.incomplete);
                setEl('db-stat-nulls-scraping', data.null_lance_atual);

                if (!silent) addLog('üìä Estat√≠sticas da BD atualizadas', 'info');
            } catch (e) {
                if (!silent) addLog(`‚ùå Erro ao carregar estat√≠sticas: ${e.message}`, 'error');
            }
        }

        // Auto-refresh DB stats every 10 seconds
        refreshDbStats(true);
        setInterval(() => refreshDbStats(true), 10000);

        // Fix NULL lance_atual values
        async function runFixNulls() {
            if (!confirm('Corrigir todos os valores NULL de lance_atual para 0?')) return;

            showMaintenanceProgress('A corrigir valores NULL...');

            try {
                const response = await authFetch(`${API_BASE}/api/db/fix-nulls`, { method: 'POST' });
                const data = await response.json();

                hideMaintenanceProgress();
                addLog(`‚úÖ ${data.fixed} valores corrigidos (NULL ‚Üí 0)`, 'success');
                showModal('‚úÖ Sucesso', data.message);
                refreshDbStats();
            } catch (e) {
                hideMaintenanceProgress();
                addLog(`‚ùå Erro ao corrigir NULLs: ${e.message}`, 'error');
                showModal('‚ùå Erro', e.message);
            }
        }

        // Update prices for all events
        async function runUpdatePrices() {
            if (!confirm('Atualizar pre√ßos de todos os eventos? Isto pode demorar.')) return;

            showMaintenanceProgress('A iniciar atualiza√ß√£o de pre√ßos...');

            try {
                const response = await authFetch(`${API_BASE}/api/db/update-prices`, { method: 'POST' });
                const data = await response.json();

                addLog(`üí∞ ${data.message}`, 'info');
                // Progress will be shown via pipeline state polling
            } catch (e) {
                hideMaintenanceProgress();
                addLog(`‚ùå Erro ao atualizar pre√ßos: ${e.message}`, 'error');
                showModal('‚ùå Erro', e.message);
            }
        }

        // Show maintenance progress
        function showMaintenanceProgress(message) {
            const progress = document.getElementById('maintenance-progress');
            const msgEl = document.getElementById('maintenance-message');
            const countEl = document.getElementById('maintenance-count');
            const bar = document.getElementById('maintenance-progress-bar');

            if (progress) progress.style.display = 'block';
            if (msgEl) msgEl.textContent = message;
            if (countEl) countEl.textContent = '';
            if (bar) bar.style.width = '0%';
        }

        // Hide maintenance progress
        function hideMaintenanceProgress() {
            const progress = document.getElementById('maintenance-progress');
            if (progress) progress.style.display = 'none';
        }

        // Update maintenance progress
        function updateMaintenanceProgress(current, total, message) {
            const msgEl = document.getElementById('maintenance-message');
            const countEl = document.getElementById('maintenance-count');
            const bar = document.getElementById('maintenance-progress-bar');

            const pct = total > 0 ? (current / total * 100) : 0;

            if (msgEl) msgEl.textContent = message;
            if (countEl) countEl.textContent = `${current}/${total}`;
            if (bar) bar.style.width = `${pct}%`;
        }

        // Toggle modes for Stage 2
        function toggleStage2Mode() {
            const source = document.getElementById('stage2-source').value;
            const idsTextarea = document.getElementById('stage2-ids');
            const btn = document.getElementById('btn-stage2');

            if (source === 'manual') {
                idsTextarea.style.display = 'block';
                btn.disabled = false;
            } else if (source === 'stage1') {
                idsTextarea.style.display = 'none';
                btn.disabled = stage1Results.length === 0;
            } else if (source === 'new') {
                idsTextarea.style.display = 'none';
                btn.disabled = false;
            }
        }

        // Toggle modes for Stage 3
        function toggleStage3Mode() {
            const source = document.getElementById('stage3-source').value;
            const idsTextarea = document.getElementById('stage3-ids');
            const btn = document.getElementById('btn-stage3');

            if (source === 'manual') {
                idsTextarea.style.display = 'block';
                btn.disabled = false;
            } else if (source === 'stage1') {
                idsTextarea.style.display = 'none';
                btn.disabled = stage1Results.length === 0;
            } else if (source === 'stage2') {
                idsTextarea.style.display = 'none';
                btn.disabled = stage2Results.length === 0;
            } else if (source === 'missing') {
                idsTextarea.style.display = 'none';
                btn.disabled = false;
            }
        }

        // Stage 1: Discover IDs
        async function runStage1() {
            const btn = document.getElementById('btn-stage1');
            const result = document.getElementById('stage1-result');
            const tipo = document.getElementById('stage1-tipo').value;
            const pages = document.getElementById('stage1-pages').value;

            try {
                btn.disabled = true;
                btn.textContent = '‚è≥ A descobrir...';
                result.className = 'stage-result loading';
                result.textContent = 'A processar...';

                let url = `${API_BASE}/api/scrape/stage1/ids?`;
                if (tipo) url += `tipo=${tipo}&`;
                if (pages) url += `max_pages=${pages}`;

                const response = await authFetch(url, { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    stage1Results = data.ids || [];
                    result.className = 'stage-result success';
                    result.textContent = `${stage1Results.length} IDs`;

                    // Enable stage 2 and 3
                    document.getElementById('btn-stage2').disabled = false;
                    toggleStage3Mode();

                    alert(`‚úÖ Stage 1 completo!\n\n${stage1Results.length} eventos descobertos`);
                } else {
                    throw new Error(data.detail || 'Erro desconhecido');
                }

            } catch (error) {
                result.className = 'stage-result';
                result.textContent = 'Erro';
                alert(`‚ùå Erro no Stage 1:\n${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîç Descobrir IDs';
            }
        }

        // Stage 2: Extract Details
        async function runStage2() {
            const btn = document.getElementById('btn-stage2');
            const result = document.getElementById('stage2-result');
            const source = document.getElementById('stage2-source').value;

            try {
                btn.disabled = true;
                btn.textContent = '‚è≥ A extrair...';
                result.className = 'stage-result loading';
                result.textContent = 'A processar...';

                let references = [];

                if (source === 'stage1') {
                    references = stage1Results.map(item => item.reference);
                } else if (source === 'manual') {
                    const idsText = document.getElementById('stage2-ids').value;
                    references = idsText.split(',').map(s => s.trim()).filter(s => s);
                } else if (source === 'new') {
                    // SMART SCRAPING: Identifica automaticamente eventos novos
                    btn.textContent = 'üß† A identificar novos...';

                    // Chama endpoint de smart scraping
                    const smartUrl = `${API_BASE}/api/scrape/smart/new-events`;
                    const smartResponse = await authFetch(smartUrl, { method: 'POST' });
                    const smartData = await smartResponse.json();

                    if (!smartResponse.ok) {
                        throw new Error(smartData.detail || 'Erro no scrape inteligente');
                    }

                    if (smartData.new_events === 0) {
                        alert(`‚ÑπÔ∏è Scrape Inteligente\n\n‚úÖ Nenhum evento novo!\n\nTotal scraped: ${smartData.total_scraped}\nJ√° na BD: ${smartData.already_in_db}`);
                        result.className = 'stage-result success';
                        result.textContent = '0 novos';
                        return;
                    }

                    // Usa os IDs novos
                    references = smartData.new_ids.map(item => item.reference);
                    alert(`üß† Scrape Inteligente\n\n‚ú® ${smartData.new_events} eventos novos identificados!\n\nTotal scraped: ${smartData.total_scraped}\nJ√° na BD: ${smartData.already_in_db}`);
                }

                if (references.length === 0) {
                    alert('Nenhum ID para processar!');
                    return;
                }

                btn.textContent = '‚è≥ A extrair detalhes...';
                const url = `${API_BASE}/api/scrape/stage2/details?` + references.map(ref => `references=${encodeURIComponent(ref)}`).join('&');

                const response = await authFetch(url, { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    stage2Results = data.events || [];
                    result.className = 'stage-result success';
                    result.textContent = `${stage2Results.length} eventos`;

                    // Enable stage 3
                    toggleStage3Mode();

                    alert(`‚úÖ Stage 2 completo!\n\n${stage2Results.length} eventos processados`);
                    loadDashboard();
                } else {
                    throw new Error(data.detail || 'Erro desconhecido');
                }

            } catch (error) {
                result.className = 'stage-result';
                result.textContent = 'Erro';
                alert(`‚ùå Erro no Stage 2:\n${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üìã Extrair Detalhes';
            }
        }

        // Stage 3: Download Images
        async function runStage3() {
            const btn = document.getElementById('btn-stage3');
            const result = document.getElementById('stage3-result');
            const source = document.getElementById('stage3-source').value;

            try {
                btn.disabled = true;
                btn.textContent = '‚è≥ A transferir...';
                result.className = 'stage-result loading';
                result.textContent = 'A processar...';

                let references = [];

                if (source === 'stage2') {
                    references = stage2Results.map(event => event.reference);
                } else if (source === 'stage1') {
                    references = stage1Results.map(item => item.reference);
                } else if (source === 'manual') {
                    const idsText = document.getElementById('stage3-ids').value;
                    references = idsText.split(',').map(s => s.trim()).filter(s => s);
                } else if (source === 'missing') {
                    const eventsResponse = await fetch(`${API_BASE}/api/events?limit=5000`);
                    const eventsData = await eventsResponse.json();
                    references = eventsData.events.filter(e => !e.imagens || e.imagens.length === 0).map(e => e.reference);
                }

                if (references.length === 0) {
                    alert('Nenhum ID para processar!');
                    return;
                }

                const url = `${API_BASE}/api/scrape/stage3/images?` + references.map(ref => `references=${encodeURIComponent(ref)}`).join('&');

                const response = await authFetch(url, { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    const imagesMap = data.images_map || {};
                    const totalImages = Object.values(imagesMap).reduce((sum, imgs) => sum + imgs.length, 0);

                    result.className = 'stage-result success';
                    result.textContent = `${totalImages} imagens`;

                    alert(`‚úÖ Stage 3 completo!\n\n${Object.keys(imagesMap).length} eventos\n${totalImages} imagens`);
                    loadDashboard();
                } else {
                    throw new Error(data.detail || 'Erro desconhecido');
                }

            } catch (error) {
                result.className = 'stage-result';
                result.textContent = 'Erro';
                alert(`‚ùå Erro no Stage 3:\n${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üñºÔ∏è Download Imagens';
            }
        }

        // Run Independent Scraper
        async function runIndependentScraper(type) {
            const tipoEl = document.getElementById('independent-tipo');
            const tipo = tipoEl ? tipoEl.value : '';
            const pagesEl = document.getElementById('independent-pages');
            const pages = pagesEl ? pagesEl.value : '';

            try {
                addLog(`‚ñ∂ Executando scraper: ${type.toUpperCase()}`, 'info');

                // Iniciar polling de feedback em tempo real
                startPipelinePolling();

                let url, message;

                switch(type) {
                    case 'ids':
                        url = `${API_BASE}/api/scrape/stage1/ids?`;
                        if (tipo) url += `tipo=${tipo}&`;
                        if (pages) url += `max_pages=${pages}`;
                        message = 'üîç Stage 1: A obter IDs...';
                        break;

                    case 'recheck':
                        url = `${API_BASE}/api/scrape/smart/new-events?`;
                        if (tipo) url += `tipo=${tipo}&`;
                        if (pages) url += `max_pages=${pages}`;
                        message = 'üîÑ Smart Scraping: A verificar novos eventos...';
                        break;

                    case 'content':
                        // Get all references from DB first (no limit - fetch all)
                        const refsResponse = await fetch(`${API_BASE}/api/events?limit=100000`);
                        const refsData = await refsResponse.json();
                        const references = refsData.events.map(e => e.reference);

                        if (references.length === 0) {
                            showModal('‚ö†Ô∏è Aviso', 'Nenhum evento na BD. Execute "Scrape IDs" primeiro.');
                            return;
                        }

                        url = `${API_BASE}/api/scrape/stage2/details?save_to_db=true&` + references.map(ref => `references=${encodeURIComponent(ref)}`).join('&');
                        message = `üìã Stage 2: A extrair detalhes de ${references.length} eventos...`;
                        break;

                    case 'images':
                        // Get all references from DB first (no limit - fetch all)
                        const imgRefsResponse = await fetch(`${API_BASE}/api/events?limit=100000`);
                        const imgRefsData = await imgRefsResponse.json();
                        const imgReferences = imgRefsData.events.map(e => e.reference);

                        if (imgReferences.length === 0) {
                            showModal('‚ö†Ô∏è Aviso', 'Nenhum evento na BD. Execute "Scrape IDs" primeiro.');
                            return;
                        }

                        url = `${API_BASE}/api/scrape/stage3/images?` + imgReferences.map(ref => `references=${encodeURIComponent(ref)}`).join('&');
                        message = `üñºÔ∏è Stage 3: A fazer download de imagens de ${imgReferences.length} eventos...`;
                        break;

                    default:
                        throw new Error('Tipo de scraper desconhecido');
                }

                addLog(message, 'info');

                const response = await authFetch(url, { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    addLog(`‚úÖ ${type.toUpperCase()}: ${data.message || 'Conclu√≠do!'}`, 'success');
                    addLog(`üìä Total: ${data.total_scraped || data.new_events || 0} eventos`, 'info');

                    // If IDs scraper, display collected IDs
                    if (type === 'ids' && data.ids && data.ids.length > 0) {
                        displayCollectedIds(data.ids);
                    }

                    // Reload dashboard after scraping
                    setTimeout(() => loadDashboard(), 1000);
                } else {
                    throw new Error(data.detail || 'Erro desconhecido');
                }

            } catch (error) {
                addLog(`‚ùå Erro no scraper ${type}: ${error.message}`, 'error');
                showModal('‚ùå Erro', error.message);
            }
        }

        // Toggle between run and stop pipeline
        function togglePipeline() {
            if (pipelineRunning) {
                stopPipeline();
            } else {
                runPipeline();
            }
        }

        // Stop pipeline execution (Kill)
        async function stopPipeline() {
            const btn = document.getElementById('btn-pipeline');
            btn.disabled = true;
            btn.textContent = '‚è≥ A terminar...';

            try {
                // Call backend kill endpoint to stop pipeline
                const response = await fetch(`${API_BASE}/api/pipeline/kill`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (response.ok) {
                    addLog('üõë Pipeline: Terminada com sucesso', 'warning');
                    if (data.killed_stage) {
                        addLog(`  ‚îî‚îÄ Stage ${data.killed_stage} (${data.killed_stage_name}) foi interrompida`, 'info');
                    }
                } else {
                    addLog(`‚ö†Ô∏è Erro ao parar pipeline: ${data.detail || 'Erro desconhecido'}`, 'error');
                }
            } catch (error) {
                addLog(`‚ö†Ô∏è Erro ao parar pipeline: ${error.message}`, 'error');
            }

            // Abort client-side request if exists
            if (pipelineAbortController) {
                pipelineAbortController.abort();
                pipelineAbortController = null;
            }

            // Stop polling
            stopPipelinePolling();

            pipelineRunning = false;
            btn.textContent = '‚ñ∂ Executar Pipeline';
            btn.className = 'scraper-btn start';
            btn.disabled = false;
            btn.style.background = '';
            btn.style.color = '';

            // Hide feedback box
            const feedbackBox = document.getElementById('pipeline-feedback');
            if (feedbackBox) feedbackBox.style.display = 'none';

            // Reset pipeline visualization
            updatePipelineStage(1, 'pending', 0);
            updatePipelineStage(2, 'pending', 0);
            updatePipelineStage(3, 'pending', 0);
            updatePipelineProgress(0);
        }

        async function runPipeline() {
            const btn = document.getElementById('btn-pipeline');
            const tipoEl = document.getElementById('independent-tipo');
            const pagesEl = document.getElementById('independent-pages');
            const tipo = tipoEl ? tipoEl.value : '';
            const pages = pagesEl ? pagesEl.value : '';

            try {
                // Set running state
                pipelineRunning = true;

                // Update button to show "Kill" option
                btn.disabled = false;
                btn.textContent = 'üõë Kill Pipeline';
                btn.className = 'scraper-btn stop';
                btn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                btn.style.color = 'white';

                addLog('üöÄ API Pipeline: Iniciando...', 'info');

                // Reset pipeline visualization (only 2 stages for API)
                updatePipelineStage(1, 'active', 0);
                updatePipelineStage(2, 'pending', 0);
                updatePipelineProgress(0);

                // Show feedback box
                const feedbackBox = document.getElementById('pipeline-feedback');
                if (feedbackBox) {
                    feedbackBox.style.display = 'block';
                    updateFeedback('A iniciar pipeline...', 0, 0);
                }

                // Build URL - always use API endpoint
                let url = `${API_BASE}/api/pipeline/api?`;
                if (tipo) url += `tipo=${tipo}&`;
                if (pages) url += `max_pages=${pages}`;

                // Start the pipeline (runs in background)
                const response = await authFetch(url, { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    // Pipeline started successfully - start polling for real-time updates
                    addLog('‚úÖ Pipeline iniciado em background', 'success');
                    startPipelinePolling();
                } else {
                    throw new Error(data.detail || 'Erro ao iniciar pipeline');
                }

            } catch (error) {
                addLog(`‚ùå Pipeline: ${error.message}`, 'error');

                // Reset button state on error
                pipelineRunning = false;
                btn.disabled = false;
                btn.textContent = '‚ñ∂ Executar Pipeline';
                btn.className = 'scraper-btn start';
                btn.style.background = '';
                btn.style.color = '';

                const feedbackBox = document.getElementById('pipeline-feedback');
                if (feedbackBox) feedbackBox.style.display = 'none';
            }
            // Note: Don't reset button here - polling will handle it when pipeline completes
        }

        // Helper functions for pipeline visualization
        function updatePipelineStage(stageNum, status, count) {
            const circle = document.getElementById(`stage${stageNum}-circle`);
            const countEl = document.getElementById(`stage${stageNum}-count`);

            // Update count
            if (countEl && count > 0) {
                countEl.textContent = `${count} eventos`;
                countEl.style.color = '#10b981';
            }

            // Update circle style based on status
            if (circle) {
                if (status === 'active') {
                    circle.style.borderColor = '#3b82f6';
                    circle.style.background = '#eff6ff';
                    circle.style.transform = 'scale(1.1)';
                } else if (status === 'completed') {
                    circle.style.borderColor = '#10b981';
                    circle.style.background = '#f0fdf4';
                    circle.style.transform = 'scale(1)';
                } else {
                    circle.style.borderColor = '#cbd5e1';
                    circle.style.background = 'white';
                    circle.style.transform = 'scale(1)';
                }
            }
        }

        function updatePipelineProgress(percent) {
            const progressLine = document.getElementById('pipeline-progress-line');
            if (progressLine) {
                progressLine.style.width = `${percent}%`;
            }
        }

        function updateFeedback(action, current, total) {
            const actionEl = document.getElementById('feedback-action');
            const countEl = document.getElementById('feedback-count');
            const progressBar = document.getElementById('feedback-progress-bar');
            if (actionEl) actionEl.textContent = action;
            if (countEl) countEl.textContent = `${current} / ${total}`;
            if (progressBar) progressBar.style.width = total > 0 ? `${(current / total) * 100}%` : '0%';
        }

        // ============== PIPELINE REAL-TIME FEEDBACK SYSTEM ==============
        let pipelinePollingInterval = null;

        // Verificar estado da pipeline ao carregar a p√°gina
        async function checkPipelineStatusOnLoad() {
            try {
                const response = await fetch(`${API_BASE}/api/pipeline/status`);
                if (response.ok) {
                    const state = await response.json();
                    if (state.active) {
                        // Pipeline est√° ativa, retomar monitoring
                        console.log('üîÑ Pipeline ativa detectada, retomando monitoring...');
                        addLog('üîÑ Pipeline ativa detectada, retomando monitoring...', 'info');

                        // Update button to show "Kill" state
                        pipelineRunning = true;
                        const btn = document.getElementById('btn-pipeline');
                        if (btn) {
                            btn.disabled = false;
                            btn.textContent = 'üõë Kill Pipeline';
                            btn.className = 'scraper-btn stop';
                            btn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                            btn.style.color = 'white';
                        }

                        // Show feedback box and update from state
                        const feedbackBox = document.getElementById('pipeline-feedback');
                        if (feedbackBox) {
                            feedbackBox.style.display = 'block';
                        }

                        // Update visualization from current state
                        updatePipelineFromState(state);

                        startPipelinePolling();
                    }
                }
            } catch (error) {
                console.error('Erro ao verificar estado da pipeline:', error);
            }
        }

        async function startPipelinePolling() {
            // Limpar polling anterior se existir
            if (pipelinePollingInterval) {
                clearInterval(pipelinePollingInterval);
            }

            // Mostrar feedback box
            const feedbackBox = document.getElementById('pipeline-feedback');
            if (feedbackBox) {
                feedbackBox.style.display = 'block';
            }

            // Fazer polling a cada 500ms
            pipelinePollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/pipeline/status`);
                    if (response.ok) {
                        const state = await response.json();
                        updatePipelineFromState(state);

                        // Parar polling se pipeline n√£o est√° ativa
                        if (!state.active) {
                            stopPipelinePolling();
                        }
                    }
                } catch (error) {
                    console.error('Erro ao fazer polling do estado da pipeline:', error);
                }
            }, 500);

            addLog('üîÑ Monitoring pipeline em tempo real...', 'info');
        }

        function stopPipelinePolling() {
            if (pipelinePollingInterval) {
                clearInterval(pipelinePollingInterval);
                pipelinePollingInterval = null;
            }

            // Reset button state
            pipelineRunning = false;
            const btn = document.getElementById('btn-pipeline');
            if (btn) {
                btn.textContent = '‚ñ∂ Executar Pipeline';
                btn.className = 'scraper-btn start';
                btn.disabled = false;
                btn.style.background = '';
                btn.style.color = '';
            }

            // Esconder feedback box ap√≥s 2 segundos
            setTimeout(() => {
                const feedbackBox = document.getElementById('pipeline-feedback');
                if (feedbackBox) {
                    feedbackBox.style.display = 'none';
                }
                // Refresh dashboard stats
                loadDashboard();
            }, 2000);
        }

        function updatePipelineFromState(state) {
            if (!state || !state.active) {
                return;
            }

            const { stage, stage_name, current, total, message, errors, details } = state;

            // Atualizar feedback box
            const feedbackStatus = document.getElementById('feedback-status');
            if (feedbackStatus) {
                feedbackStatus.textContent = stage_name || 'A processar...';
            }

            // Atualizar feedback-action com a mensagem de totais
            const actionEl = document.getElementById('feedback-action');
            const countEl = document.getElementById('feedback-count');
            const progressBar = document.getElementById('feedback-progress-bar');

            if (actionEl) {
                actionEl.textContent = message || 'A processar...';
            }

            // Para Stage 1, mostrar total de IDs; para outros, mostrar progresso
            if (stage === 1) {
                const totalIds = details?.total_ids || current;
                const typesDone = details?.types_done || 0;
                if (countEl) countEl.textContent = `${totalIds} IDs (${typesDone}/6 tipos)`;
                // Progress based on types done
                if (progressBar) progressBar.style.width = `${(typesDone / 6) * 100}%`;
                updatePipelineStage(1, 'active', totalIds);
                updatePipelineStage(2, 'pending', 0);
                updatePipelineStage(3, 'pending', 0);
                updatePipelineProgress((typesDone / 6) * 33);

                // Display collected IDs in independent scraper section
                if (details?.ids && details.ids.length > 0) {
                    displayCollectedIds(details.ids);
                }
            } else if (stage === 2) {
                if (countEl) countEl.textContent = `${current} / ${total}`;
                if (progressBar) progressBar.style.width = total > 0 ? `${(current / total) * 100}%` : '0%';
                updatePipelineStage(1, 'completed', total);
                updatePipelineStage(2, 'active', current);
                updatePipelineStage(3, 'pending', 0);
                updatePipelineProgress(33 + Math.min((current / total) * 33, 33));
            } else if (stage === 3) {
                if (countEl) countEl.textContent = `${current} / ${total}`;
                if (progressBar) progressBar.style.width = total > 0 ? `${(current / total) * 100}%` : '0%';
                updatePipelineStage(1, 'completed', total);
                updatePipelineStage(2, 'completed', total);
                updatePipelineStage(3, 'active', current);
                updatePipelineProgress(66 + Math.min((current / total) * 34, 34));
            }

            // Mostrar erros se existirem
            if (errors && errors.length > 0) {
                errors.forEach(err => {
                    addLog(`‚ö†Ô∏è Erro: ${err.error}`, 'error');
                });
            }

            // Log de progresso detalhado
            if (current > 0) {
                console.log(`üìä Pipeline: Stage ${stage} - ${message}`);
            }
        }

        // ============== END PIPELINE REAL-TIME FEEDBACK SYSTEM ==============

        // ============== AUTOMATIC PIPELINES SYSTEM ==============

        // Load pipeline states on page load
        // Pipeline X Countdown Functions
        async function updatePipelineXCacheInfo() {
            try {
                const response = await fetch(`${API_BASE}/api/auto-pipelines/prices/cache-info`);
                if (response.ok) {
                    const data = await response.json();
                    pipelineXCachedEvents = data.cached_events || 0;
                }
            } catch (error) {
                console.error('Erro ao buscar info do cache Pipeline X:', error);
            }
        }

        function updatePipelineXDisplay() {
            const statusDiv = document.getElementById('auto-pipeline-prices-status');
            const statusText = statusDiv?.querySelector('.status-text');
            if (statusText) {
                if (pipelineXCachedEvents === 0) {
                    statusText.textContent = '‚è∏Ô∏è Aguardando eventos terminando em < 6 minutos...';
                } else {
                    statusText.textContent = `‚ö° Executando a cada ${pipelineXCountdown} segundo${pipelineXCountdown !== 1 ? 's' : ''} ‚Ä¢ ${pipelineXCachedEvents} evento${pipelineXCachedEvents !== 1 ? 's' : ''} na cache`;
                }
            }
        }

        function startPipelineXCountdown() {
            stopPipelineXCountdown(); // Clear any existing interval
            pipelineXCountdown = 5;

            // Update cache info immediately
            updatePipelineXCacheInfo();
            updatePipelineXDisplay();

            pipelineXCountdownInterval = setInterval(() => {
                pipelineXCountdown--;
                if (pipelineXCountdown < 1) {
                    pipelineXCountdown = 5;
                    // Refresh cache info every 5 seconds (to detect new events)
                    updatePipelineXCacheInfo();
                }
                updatePipelineXDisplay();
            }, 1000);
        }

        function stopPipelineXCountdown() {
            if (pipelineXCountdownInterval) {
                clearInterval(pipelineXCountdownInterval);
                pipelineXCountdownInterval = null;
            }
        }

        // Pipeline countdown timers storage
        let pipelineNextRuns = {};
        let pipelineEnabled = {}; // Store enabled status from API
        let pipelineIsRunning = {}; // Store is_running status from API
        let pipelineCountdownInterval = null;

        function formatCountdown(seconds) {
            if (seconds <= 0) return 'üîÑ';

            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);

            if (hours > 0) {
                return `‚è±Ô∏è ${hours}h ${mins.toString().padStart(2, '0')}m ${secs.toString().padStart(2, '0')}s`;
            } else if (mins > 0) {
                return `‚è±Ô∏è ${mins}m ${secs.toString().padStart(2, '0')}s`;
            } else {
                return `‚è±Ô∏è ${secs}s`;
            }
        }

        function updatePipelineTimers() {
            const now = new Date();

            const timerColors = {
                'xmonitor': '#dc2626',
                'ysync': '#1e40af',
                'zwatch': '#059669'
            };

            for (const [type, nextRunStr] of Object.entries(pipelineNextRuns)) {
                const timerEl = document.getElementById(`pipeline-timer-${type}-scraping`);
                const dashTimerEl = document.getElementById(`dash-${type}-timer`);
                const mainTimerEl = document.getElementById(`timer-${type}`);  // Dashboard card timer

                // Use stored enabled status (from API), fallback to checkbox if available
                const checkbox = document.getElementById(`auto-pipeline-${type}-scraping`);
                const isEnabled = pipelineEnabled[type] !== undefined ? pipelineEnabled[type] : (checkbox && checkbox.checked);

                let displayText = '--:--';
                let displayColor = timerColors[type] || '#94a3b8';

                // Check if pipeline is currently running (from API)
                const isRunning = pipelineIsRunning[type] || false;

                if (!isEnabled) {
                    displayText = '‚è∏Ô∏è';
                    displayColor = '#94a3b8';
                } else if (isRunning) {
                    // Use is_running from API, not just next_run time
                    displayText = 'üîÑ';
                    displayColor = '#f59e0b';
                } else if (!nextRunStr) {
                    displayText = '...';
                    displayColor = '#64748b';
                } else {
                    const nextRun = new Date(nextRunStr);
                    const diffSeconds = (nextRun - now) / 1000;

                    if (diffSeconds <= 0) {
                        // Timer expired but not running - waiting or just finished
                        displayText = '‚è≥';
                        displayColor = '#64748b';
                    } else {
                        // Full format for scraping page
                        if (timerEl) {
                            timerEl.textContent = formatCountdown(diffSeconds);
                            if (type === 'xmonitor') timerEl.style.color = '#dc2626';
                            else if (type === 'ysync') timerEl.style.color = '#1e40af';
                        }
                        // Compact format
                        const hours = Math.floor(diffSeconds / 3600);
                        const mins = Math.floor((diffSeconds % 3600) / 60);
                        const secs = Math.floor(diffSeconds % 60);

                        if (hours > 0) {
                            displayText = `${hours}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                        } else {
                            displayText = `${mins}:${secs.toString().padStart(2, '0')}`;
                        }
                        displayColor = timerColors[type] || '#94a3b8';
                    }
                }

                // Update scraping page timer (with longer text)
                if (timerEl && (displayText === '‚è∏Ô∏è' || displayText === '...' || displayText === 'üîÑ' || displayText === '‚è≥')) {
                    const longText = {
                        '‚è∏Ô∏è': '‚è∏Ô∏è Desativada',
                        '...': '‚è±Ô∏è A aguardar...',
                        'üîÑ': 'üîÑ A executar...',
                        '‚è≥': '‚è≥ A aguardar...'
                    };
                    timerEl.textContent = longText[displayText] || displayText;
                    timerEl.style.color = displayColor;
                }

                // Update old dashboard timer
                if (dashTimerEl) {
                    dashTimerEl.textContent = displayText;
                    dashTimerEl.style.color = displayColor;
                }

                // Update new main dashboard card timer
                if (mainTimerEl) {
                    mainTimerEl.textContent = displayText;
                    mainTimerEl.style.color = displayColor;
                }
            }
        }

        // Start countdown timer interval
        function startPipelineCountdowns() {
            if (pipelineCountdownInterval) clearInterval(pipelineCountdownInterval);
            pipelineCountdownInterval = setInterval(updatePipelineTimers, 1000);
        }

        async function loadAutoPipelinesStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/auto-pipelines/status`);
                if (response.ok) {
                    const data = await response.json();

                    // Update UI with current status and store next_run times
                    for (const [type, config] of Object.entries(data.pipelines || {})) {
                        // Update checkbox on scraping page
                        const checkbox = document.getElementById(`auto-pipeline-${type}-scraping`);
                        if (checkbox) {
                            checkbox.checked = config.enabled;
                        }

                        // Store enabled status, is_running, and next_run for countdown timer
                        pipelineEnabled[type] = config.enabled;
                        pipelineIsRunning[type] = config.is_running;
                        pipelineNextRuns[type] = config.next_run;

                        // If pipeline is running, show running state on scraping page
                        const timerEl = document.getElementById(`pipeline-timer-${type}-scraping`);
                        if (timerEl && config.is_running) {
                            timerEl.textContent = 'üîÑ A executar...';
                            timerEl.style.color = '#f59e0b';
                        }
                    }

                    // Update X-Monitor counts if available
                    if (data.xmonitor_stats) {
                        const stats = data.xmonitor_stats;
                        const setCount = (id, val) => {
                            const el = document.getElementById(id);
                            if (el) el.textContent = val || 0;
                            // Also update scraping page element
                            const elScraping = document.getElementById(id + '-scraping');
                            if (elScraping) elScraping.textContent = val || 0;
                            // Also update dashboard element
                            const elDash = document.getElementById(id + '-dash');
                            if (elDash) elDash.textContent = val || 0;
                        };
                        setCount('x-monitor-count', stats.total);
                        setCount('x-critical-count', stats.critical);
                        setCount('x-urgent-count', stats.urgent);
                        setCount('x-soon-count', stats.soon);

                        // Update new dashboard pipeline card urgency counts
                        const xCritical = document.getElementById('x-critical');
                        const xUrgent = document.getElementById('x-urgent');
                        const xSoon = document.getElementById('x-soon');
                        if (xCritical) xCritical.textContent = stats.critical || 0;
                        if (xUrgent) xUrgent.textContent = stats.urgent || 0;
                        if (xSoon) xSoon.textContent = stats.soon || 0;

                        // Update urgency card on dashboard (legacy)
                        const urgCritical = document.getElementById('urgency-critical');
                        const urgUrgent = document.getElementById('urgency-urgent');
                        const urgSoon = document.getElementById('urgency-soon');
                        if (urgCritical) urgCritical.textContent = stats.critical || 0;
                        if (urgUrgent) urgUrgent.textContent = stats.urgent || 0;
                        if (urgSoon) urgSoon.textContent = stats.soon || 0;
                    }

                    // Update timers immediately
                    updatePipelineTimers();
                }
            } catch (error) {
                console.error('Erro ao carregar status das pipelines autom√°ticas:', error);
            }
        }

        // Start countdown timers
        startPipelineCountdowns();

        // Poll pipeline status every 3 seconds to update "is_running" state
        setInterval(loadAutoPipelinesStatus, 3000);

        async function toggleAutoPipeline(type, enabled) {
            const pipelineNames = {
                'xmonitor': 'X-Monitor',
                'ysync': 'Y-Sync',
                'zwatch': 'Z-Watch'
            };
            const name = pipelineNames[type] || type;

            try {
                addLog(`${enabled ? 'üü¢' : 'üî¥'} ${name}: ${enabled ? 'Ativada' : 'Desativada'}`, 'info');

                const response = await fetch(`${API_BASE}/api/auto-pipelines/${type}/toggle?enabled=${enabled}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });

                const data = await response.json();

                if (response.ok) {
                    addLog(`‚úÖ ${name}: ${data.message}`, 'success');
                } else {
                    throw new Error(data.detail || 'Erro ao alterar estado da pipeline');
                }
            } catch (error) {
                addLog(`‚ùå Erro ao alterar ${name}: ${error.message}`, 'error');

                // Revert checkbox
                const checkbox = document.getElementById(`auto-pipeline-${type}`);
                if (checkbox) {
                    checkbox.checked = !enabled;
                }
            }
        }

        // ============== END AUTOMATIC PIPELINES SYSTEM ==============

        // Console Functions
        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            const btn = document.getElementById('btn-autoscroll');
            btn.textContent = autoScroll ? 'üìå Auto-scroll: ON' : 'üìå Auto-scroll: OFF';
        }

        function clearConsole() {
            const consoleEl = document.getElementById('console-output');
            if (consoleEl) {
                consoleEl.innerHTML = '<div style="color: #6b7280;">üü¢ Console limpo. A aguardar logs...</div>';
            }
        }

        function addLog(message, level = 'info') {
            const consoleOutput = document.getElementById('console-output');
            const timestamp = new Date().toLocaleTimeString('pt-PT');

            let color = '#d4d4d4';  // default
            let icon = '‚ÑπÔ∏è';

            if (level === 'success') {
                color = '#10b981';
                icon = '‚úÖ';
            } else if (level === 'error') {
                color = '#ef4444';
                icon = '‚ùå';
            } else if (level === 'warning') {
                color = '#f59e0b';
                icon = '‚ö†Ô∏è';
            } else if (level === 'info') {
                color = '#3b82f6';
                icon = '‚ÑπÔ∏è';
            }

            // If console-output element doesn't exist, just log to browser console
            if (!consoleOutput) {
                console.log(`[${level.toUpperCase()}] ${message}`);
                return;
            }

            const logEntry = document.createElement('div');
            logEntry.style.color = color;
            logEntry.innerHTML = `<span style="color: #6b7280;">[${timestamp}]</span> ${icon} ${message}`;

            consoleOutput.appendChild(logEntry);

            // Auto-scroll if enabled
            if (autoScroll) {
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
            }

            // Limit to 100 log entries
            while (consoleOutput.children.length > 100) {
                consoleOutput.removeChild(consoleOutput.firstChild);
            }
        }

        // Start console polling (check for new logs every 2 seconds)
        function startConsolePolling() {
            if (consolePollingInterval) {
                clearInterval(consolePollingInterval);
            }

            // Initial log
            addLog('Console iniciado. Monitoriza√ß√£o ativa.', 'success');

            // Poll every 2 seconds (can be adjusted)
            consolePollingInterval = setInterval(async () => {
                try {
                    // Fetch logs from backend (we'll create this endpoint)
                    const response = await fetch(`${API_BASE}/api/logs`, { method: 'GET' });
                    if (response.ok) {
                        const data = await response.json();
                        if (data.logs && data.logs.length > 0) {
                            data.logs.forEach(log => {
                                addLog(log.message, log.level);
                            });
                        }
                    }
                } catch (error) {
                    // Silently fail - don't spam console with errors
                }
            }, 2000);
        }

        // Stop console polling
        function stopConsolePolling() {
            if (consolePollingInterval) {
                clearInterval(consolePollingInterval);
                consolePollingInterval = null;
            }
        }

        // Generic Modal Functions
        function showModal(title, message) {
            const modal = document.getElementById('generic-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalIcon = document.getElementById('modal-icon');

            // Set content
            modalTitle.textContent = title;
            modalMessage.textContent = message;

            // Set icon based on title
            if (title.includes('‚ùå') || title.includes('Erro')) {
                modalIcon.textContent = '‚ùå';
            } else if (title.includes('‚ö†Ô∏è') || title.includes('Aviso')) {
                modalIcon.textContent = '‚ö†Ô∏è';
            } else if (title.includes('‚úÖ') || title.includes('Sucesso')) {
                modalIcon.textContent = '‚úÖ';
            } else {
                modalIcon.textContent = '‚ÑπÔ∏è';
            }

            // Show modal
            modal.style.display = 'flex';
        }

        function closeModal() {
            const modal = document.getElementById('generic-modal');
            modal.style.display = 'none';
        }

        // Clear Database with Confirmation Modal + Timer
        function confirmClearDatabase() {
            const modal = document.getElementById('delete-confirm-modal');
            const timerDisplay = document.getElementById('delete-timer');
            const confirmBtn = document.getElementById('confirm-delete-btn');

            // Show modal
            modal.style.display = 'flex';

            // Reset timer - REDUCED TO 3 SECONDS
            let timeLeft = 3;
            timerDisplay.textContent = timeLeft;
            confirmBtn.disabled = true;
            confirmBtn.style.background = '#cbd5e1';
            confirmBtn.style.borderColor = '#cbd5e1';
            confirmBtn.style.color = '#94a3b8';
            confirmBtn.style.cursor = 'not-allowed';

            // Start countdown
            deleteTimerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(deleteTimerInterval);
                    // Enable confirm button
                    confirmBtn.disabled = false;
                    confirmBtn.style.background = '#dc2626';
                    confirmBtn.style.borderColor = '#dc2626';
                    confirmBtn.style.color = 'white';
                    confirmBtn.style.cursor = 'pointer';
                    timerDisplay.textContent = '‚úì';
                    timerDisplay.style.color = '#10b981';
                }
            }, 1000);
        }

        function cancelDeleteDatabase() {
            const modal = document.getElementById('delete-confirm-modal');
            modal.style.display = 'none';

            if (deleteTimerInterval) {
                clearInterval(deleteTimerInterval);
                deleteTimerInterval = null;
            }
        }

        async function executeDeleteDatabase() {
            const modal = document.getElementById('delete-confirm-modal');
            const confirmBtn = document.getElementById('confirm-delete-btn');

            // Disable button during execution
            confirmBtn.disabled = true;
            confirmBtn.textContent = '‚è≥ A processar...';

            try {
                const response = await fetch(`${API_BASE}/api/database`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok) {
                    confirmBtn.textContent = '‚úì Conclu√≠do!';
                    confirmBtn.style.background = '#10b981';

                    setTimeout(() => {
                        modal.style.display = 'none';
                        showModal(
                            '‚úÖ Base de dados limpa com sucesso!',
                            `${data.deleted_events} eventos foram apagados.\n\nA p√°gina vai recarregar...`
                        );
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    }, 1000);
                } else {
                    throw new Error(data.detail || 'Erro desconhecido');
                }

            } catch (error) {
                showModal('‚ùå Erro ao limpar base de dados', error.message);
                console.error(error);
                modal.style.display = 'none';
                cancelDeleteDatabase();
            }
        }

        // Setup filter event listeners for imoveis page
        (function setupImoveisFilters() {
            // Debounce function for search inputs
            let searchTimeout;
            const debounce = (func, delay) => {
                return (...args) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => func(...args), delay);
                };
            };

            // Search input - debounced
            const searchInput = document.getElementById('search-imoveis');
            if (searchInput) {
                searchInput.addEventListener('input', debounce(() => {
                    currentPageData.imoveis = 1;
                    loadEvents('imoveis', 1);
                }, 300));
            }

            // Sort select
            const sortSelect = document.getElementById('sort-imoveis');
            if (sortSelect) {
                sortSelect.addEventListener('change', () => {
                    currentPageData.imoveis = 1;
                    loadEvents('imoveis', 1);
                });
            }

            // Subtipo select
            const subtipoSelect = document.getElementById('subtipo-imoveis');
            if (subtipoSelect) {
                subtipoSelect.addEventListener('change', () => {
                    currentPageData.imoveis = 1;
                    loadEvents('imoveis', 1);
                });
            }

            // Tipologia select
            const tipologiaSelect = document.getElementById('tipologia-imoveis');
            if (tipologiaSelect) {
                tipologiaSelect.addEventListener('change', () => {
                    currentPageData.imoveis = 1;
                    loadEvents('imoveis', 1);
                });
            }

            // Freguesia select
            const freguesiaSelect = document.getElementById('freguesia-imoveis');
            if (freguesiaSelect) {
                freguesiaSelect.addEventListener('change', () => {
                    currentPageData.imoveis = 1;
                    loadEvents('imoveis', 1);
                });
            }

            // Value range inputs - debounced
            const valorMinInput = document.getElementById('valor-min-imoveis');
            const valorMaxInput = document.getElementById('valor-max-imoveis');
            if (valorMinInput) {
                valorMinInput.addEventListener('input', debounce(() => {
                    currentPageData.imoveis = 1;
                    loadEvents('imoveis', 1);
                }, 500));
            }
            if (valorMaxInput) {
                valorMaxInput.addEventListener('input', debounce(() => {
                    currentPageData.imoveis = 1;
                    loadEvents('imoveis', 1);
                }, 500));
            }
        })();

        // ============== ALERTAS/NOTIFICATIONS SYSTEM ==============

        // Tab switching
        function switchAlertasTab(tab) {
            const tabNotifications = document.getElementById('tab-notifications');
            const tabRules = document.getElementById('tab-rules');
            const contentNotifications = document.getElementById('tab-content-notifications');
            const contentRules = document.getElementById('tab-content-rules');

            if (tab === 'notifications') {
                tabNotifications.style.borderBottomColor = '#3b82f6';
                tabNotifications.style.color = '#3b82f6';
                tabNotifications.style.fontWeight = '600';
                tabRules.style.borderBottomColor = 'transparent';
                tabRules.style.color = '#64748b';
                tabRules.style.fontWeight = '500';
                contentNotifications.style.display = 'block';
                contentRules.style.display = 'none';
            } else {
                tabRules.style.borderBottomColor = '#3b82f6';
                tabRules.style.color = '#3b82f6';
                tabRules.style.fontWeight = '600';
                tabNotifications.style.borderBottomColor = 'transparent';
                tabNotifications.style.color = '#64748b';
                tabNotifications.style.fontWeight = '500';
                contentRules.style.display = 'block';
                contentNotifications.style.display = 'none';
            }
        }

        // Load alertas page data
        async function loadAlertasPage() {
            await Promise.all([
                loadNotificationRules(),
                loadNotifications(),
                updateNotificationBadge()
            ]);
        }

        // Load notification rules (table format)
        async function loadNotificationRules() {
            const tbody = document.getElementById('rules-table-body');
            if (!tbody) return;

            try {
                // Force refresh for Alertas page (user explicitly navigated here)
                FAVORITES._cacheTime = 0;
                await FAVORITES.getAll();
                const rules = FAVORITES._allRulesCache;

                // Update count
                const activeRules = rules.filter(r => r.active).length;
                document.getElementById('alertas-rules-count').textContent = activeRules;
                // Update dashboard count
                const dashRulesEl = document.getElementById('dash-rules-count');
                if (dashRulesEl) dashRulesEl.textContent = activeRules;

                if (rules.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" style="padding: 60px 40px; text-align: center; color: #94a3b8;">
                        Nenhuma regra configurada. Clique em "Nova Regra" para come√ßar.
                    </td></tr>`;
                    return;
                }

                tbody.innerHTML = rules.map(rule => {
                    const tipoLabel = rule.rule_type === 'new_event' ? 'Novo Evento' : 'Alt. Pre√ßo';
                    const filters = [];
                    if (rule.tipos) filters.push(rule.tipos.join(', '));
                    if (rule.distritos) filters.push(rule.distritos.join(', '));
                    if (rule.preco_max) filters.push(`< ‚Ç¨${rule.preco_max.toLocaleString('pt-PT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`);
                    const filtersStr = filters.length > 0 ? filters.join(' ¬∑ ') : '‚Äî';

                    return `
                        <tr style="border-bottom: 1px solid #f1f5f9; ${!rule.active ? 'opacity: 0.5;' : ''}">
                            <td style="padding: 14px 16px; font-weight: 500;">${rule.name}</td>
                            <td style="padding: 14px 16px; color: #64748b;">${tipoLabel}</td>
                            <td style="padding: 14px 16px; color: #64748b; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${filtersStr}</td>
                            <td style="padding: 14px 16px; text-align: center; color: #64748b;">${rule.triggers_count || 0}</td>
                            <td style="padding: 14px 16px; text-align: center;">
                                <button onclick="toggleRule(${rule.id}, ${!rule.active})" style="padding: 4px 12px; background: ${rule.active ? '#dcfce7' : '#f1f5f9'}; border: none; border-radius: 12px; font-size: 11px; font-weight: 500; color: ${rule.active ? '#166534' : '#64748b'}; cursor: pointer;">
                                    ${rule.active ? 'Ativa' : 'Inativa'}
                                </button>
                            </td>
                            <td style="padding: 14px 16px; text-align: right;">
                                <button onclick="deleteRule(${rule.id})" style="background: none; border: none; color: #94a3b8; cursor: pointer; padding: 4px;" title="Eliminar">
                                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="16" height="16">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Erro ao carregar regras:', error);
                tbody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: #ef4444;">Erro ao carregar regras</td></tr>';
            }
        }

        // Load notifications
        async function loadNotifications() {
            const container = document.getElementById('notifications-list');
            if (!container) return;

            try {
                const response = await fetch(`${API_BASE}/api/notifications?limit=50`);
                const notifications = await response.json();

                // Update unread count
                const unreadCount = notifications.filter(n => !n.read).length;
                const countEl = document.getElementById('alertas-unread-count');
                if (countEl) countEl.textContent = unreadCount;
                // Update dashboard count
                const dashUnreadEl = document.getElementById('dash-unread-count');
                if (dashUnreadEl) dashUnreadEl.textContent = unreadCount;

                if (notifications.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px 40px; color: #94a3b8;">
                            Nenhuma notifica√ß√£o. As notifica√ß√µes aparecer√£o aqui quando eventos corresponderem √†s suas regras.
                        </div>
                    `;
                    return;
                }

                container.innerHTML = notifications.map(notif => {
                    const timeAgo = getTimeAgo(new Date(notif.created_at));

                    // Get notification type badge
                    const typeInfo = {
                        'new_event': { label: 'Novo', icon: 'üÜï', color: '#3b82f6', bg: '#eff6ff' },
                        'price_change': { label: 'Pre√ßo', icon: 'üí∞', color: '#f59e0b', bg: '#fef3c7' },
                        'ending_soon': { label: 'A Terminar', icon: '‚è∞', color: '#ef4444', bg: '#fef2f2' },
                        'event_ended': { label: 'Terminado', icon: 'üèÅ', color: '#6b7280', bg: '#f3f4f6' },
                        'favorite_price_change': { label: 'Favorito', icon: '‚≠ê', color: '#f59e0b', bg: '#fef3c7' },
                        'favorite_ending_soon': { label: 'Favorito', icon: '‚≠ê', color: '#ef4444', bg: '#fef2f2' }
                    };
                    const type = typeInfo[notif.notification_type] || typeInfo['new_event'];

                    // Price variation for price_change (including favorites)
                    const isPriceChange = notif.notification_type === 'price_change' || notif.notification_type === 'favorite_price_change';
                    const priceVariation = isPriceChange && notif.preco_anterior && notif.preco_atual
                        ? `<span style="color: ${notif.preco_atual < notif.preco_anterior ? '#059669' : '#ef4444'}; font-weight: 600; font-size: 11px;">${notif.preco_atual > notif.preco_anterior ? '+' : ''}‚Ç¨${(notif.preco_atual - notif.preco_anterior).toLocaleString('pt-PT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>`
                        : (isPriceChange && notif.preco_variacao
                            ? `<span style="color: ${notif.preco_variacao < 0 ? '#ef4444' : '#059669'}; font-weight: 600; font-size: 11px;">${notif.preco_variacao > 0 ? '+' : ''}‚Ç¨${notif.preco_variacao.toLocaleString('pt-PT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>`
                            : '');

                    return `
                        <div style="background: ${notif.read ? 'white' : '#f0f9ff'}; border: 1px solid ${notif.read ? '#e2e8f0' : '#bae6fd'}; border-radius: 10px; padding: 14px 16px; transition: all 0.2s;">
                            <div style="display: flex; gap: 14px; align-items: center;">
                                <div style="width: 32px; height: 32px; border-radius: 8px; background: ${type.bg}; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0;" title="${type.label}">
                                    ${type.icon}
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                        <span style="font-weight: ${notif.read ? '400' : '600'}; font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                            ${notif.event_titulo || notif.event_reference}
                                        </span>
                                        ${priceVariation}
                                    </div>
                                    <div style="font-size: 12px; color: #64748b;">
                                        ${notif.event_tipo || ''} ${notif.event_subtipo ? `¬∑ ${notif.event_subtipo}` : ''} ${notif.event_distrito ? `¬∑ ${notif.event_distrito}` : ''}
                                        ${notif.preco_atual ? ` ¬∑ <span style="color: #059669; font-weight: 600;">‚Ç¨${notif.preco_atual.toLocaleString('pt-PT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>` : ''}
                                    </div>
                                </div>
                                <div style="font-size: 11px; color: #94a3b8; white-space: nowrap;">${timeAgo}</div>
                                <button onclick="markNotificationRead(${notif.id}, ${!notif.read})" style="background: ${notif.read ? '#f1f5f9' : '#dbeafe'}; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: ${notif.read ? '#94a3b8' : '#3b82f6'}; transition: all 0.2s;" title="${notif.read ? 'Marcar como n√£o lida' : 'Marcar como lida'}">
                                    <svg fill="${notif.read ? 'none' : 'currentColor'}" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="16" height="16">
                                        <circle cx="12" cy="12" r="4"/>
                                    </svg>
                                </button>
                                <button onclick="openInspectionModal('${notif.event_reference}')" style="background: #f1f5f9; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #64748b; transition: all 0.2s;" title="Ver evento">
                                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="16" height="16">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Erro ao carregar notifica√ß√µes:', error);
                container.innerHTML = '<div style="color: #ef4444; padding: 40px; text-align: center;">Erro ao carregar notifica√ß√µes</div>';
            }
        }

        // Delete all notifications
        async function deleteAllNotifications() {
            try {
                await fetch(`${API_BASE}/api/notifications/delete-all`, { method: 'DELETE' });
                loadNotifications();
                updateNotificationBadge();
                showToast('Notifica√ß√µes limpas', 'Todas as notifica√ß√µes foram eliminadas', 'success');
            } catch (error) {
                console.error('Erro ao eliminar notifica√ß√µes:', error);
                showToast('Erro', 'N√£o foi poss√≠vel eliminar as notifica√ß√µes', 'error');
            }
        }

        // Confirm delete all notifications (Settings page)
        function confirmDeleteAllNotifications() {
            if (confirm('Tem certeza que deseja eliminar TODAS as notifica√ß√µes?\n\nEsta a√ß√£o n√£o pode ser revertida!')) {
                deleteAllNotifications();
            }
        }

        // Export all events data (Settings page)
        async function exportAllData() {
            try {
                showToast('A exportar...', 'Preparando dados para download', 'info');
                const response = await fetch(`${API_BASE}/api/events?limit=100000`);
                if (!response.ok) throw new Error('Erro ao obter dados');

                const data = await response.json();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `e-leiloes-export-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showToast('Exporta√ß√£o conclu√≠da', `${data.events?.length || 0} eventos exportados`, 'success');
            } catch (error) {
                console.error('Erro ao exportar:', error);
                showToast('Erro', 'N√£o foi poss√≠vel exportar os dados', 'error');
            }
        }

        // ============== Security Key Management ==============

        function toggleKeyVisibility() {
            const input = document.getElementById('api-auth-key-input');
            if (input) {
                input.type = input.type === 'password' ? 'text' : 'password';
            }
        }

        function saveApiKey() {
            const input = document.getElementById('api-auth-key-input');
            if (!input) return;

            const key = input.value.trim();
            if (!key) {
                showToast('Erro', 'Insira uma chave v√°lida', 'error');
                return;
            }

            API_AUTH.setKey(key);
            updateAuthStatus(true);
            showToast('Chave guardada', 'A chave de autentica√ß√£o foi configurada com sucesso', 'success');
            input.value = '';
        }

        function clearApiKey() {
            API_AUTH.clearKey();
            updateAuthStatus(false);
            showToast('Chave removida', 'A chave de autentica√ß√£o foi removida', 'info');
        }

        function updateAuthStatus(configured) {
            const indicator = document.getElementById('api-auth-indicator');
            const text = document.getElementById('api-auth-text');

            if (indicator && text) {
                if (configured) {
                    indicator.style.background = '#22c55e';
                    text.textContent = 'Chave configurada ‚úì';
                    text.style.color = '#166534';
                } else {
                    indicator.style.background = '#94a3b8';
                    text.textContent = 'Chave n√£o configurada';
                    text.style.color = '#64748b';
                }
            }
        }

        // ============== WEBSOCKET FOR REAL-TIME NOTIFICATIONS ==============

        let notificationWebSocket = null;
        let wsReconnectAttempts = 0;
        const WS_MAX_RECONNECT_ATTEMPTS = 10;
        const WS_RECONNECT_DELAY = 3000;

        function connectNotificationWebSocket() {
            // Determine WebSocket URL based on current location
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            // Connect to same origin WebSocket (public-api serves both HTTP and WebSocket)
            const wsUrl = `${wsProtocol}//${window.location.host}/ws/notifications`;

            console.log(`üîå Connecting to WebSocket: ${wsUrl}`);

            try {
                notificationWebSocket = new WebSocket(wsUrl);

                notificationWebSocket.onopen = () => {
                    console.log('‚úÖ WebSocket connected for real-time notifications');
                    wsReconnectAttempts = 0;
                    // Send ping every 30 seconds to keep connection alive
                    setInterval(() => {
                        if (notificationWebSocket && notificationWebSocket.readyState === WebSocket.OPEN) {
                            notificationWebSocket.send('ping');
                        }
                    }, 30000);
                };

                notificationWebSocket.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        if (message.type === 'notification') {
                            handleRealtimeNotification(message.data);
                        }
                    } catch (e) {
                        // Ignore pong responses
                        if (event.data !== 'pong') {
                            console.log('WebSocket message:', event.data);
                        }
                    }
                };

                notificationWebSocket.onclose = (event) => {
                    console.log(`üîå WebSocket disconnected (code: ${event.code})`);
                    attemptReconnect();
                };

                notificationWebSocket.onerror = (error) => {
                    console.error('‚ùå WebSocket error:', error);
                };
            } catch (e) {
                console.error('Failed to create WebSocket:', e);
                attemptReconnect();
            }
        }

        function attemptReconnect() {
            if (wsReconnectAttempts < WS_MAX_RECONNECT_ATTEMPTS) {
                wsReconnectAttempts++;
                console.log(`üîÑ Reconnecting WebSocket (attempt ${wsReconnectAttempts}/${WS_MAX_RECONNECT_ATTEMPTS})...`);
                setTimeout(connectNotificationWebSocket, WS_RECONNECT_DELAY);
            } else {
                console.log('‚ùå Max WebSocket reconnect attempts reached');
            }
        }

        function handleRealtimeNotification(notification) {
            console.log('üîî Real-time notification received:', notification);

            const type = notification.notification_type;
            const ref = notification.event_reference;

            if (type === 'price_change') {
                const oldPrice = notification.preco_anterior;
                const newPrice = notification.preco_atual;
                const diff = newPrice - oldPrice;
                const diffStr = diff > 0 ? `+‚Ç¨${diff.toLocaleString('pt-PT', {maximumFractionDigits: 2})}` : `-‚Ç¨${Math.abs(diff).toLocaleString('pt-PT', {maximumFractionDigits: 2})}`;
                const diffColor = diff > 0 ? '#10b981' : '#ef4444';

                showToast(
                    `üí∞ Pre√ßo alterado: ${ref}`,
                    `${notification.event_titulo ? notification.event_titulo.substring(0, 40) + '...' : ''}<br>
                    <span style="color: ${diffColor}; font-weight: bold;">
                        ‚Ç¨${oldPrice.toLocaleString('pt-PT', {maximumFractionDigits: 2})} ‚Üí ‚Ç¨${newPrice.toLocaleString('pt-PT', {maximumFractionDigits: 2})}
                    </span>
                    <span style="color: ${diffColor};">(${diffStr})</span>`,
                    diff > 0 ? 'success' : 'warning',
                    8000  // Show for 8 seconds
                );

                // Update notification badge
                updateNotificationBadge();

                // Play sound (optional)
                playNotificationSound();

            } else if (type === 'new_event') {
                showToast(
                    `üÜï Novo evento: ${ref}`,
                    notification.event_titulo || 'Novo evento adicionado',
                    'info',
                    6000
                );
                updateNotificationBadge();

            } else if (type === 'ending_soon') {
                showToast(
                    `‚è∞ A terminar: ${ref}`,
                    `${notification.event_titulo || ref} termina em ${notification.minutes_remaining} minutos`,
                    'warning',
                    10000
                );
                updateNotificationBadge();
            }
        }

        function playNotificationSound() {
            // Skip sound if muted
            if (notificationsMuted) return;

            // Create a simple beep sound
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                gainNode.gain.value = 0.1;

                oscillator.start();
                setTimeout(() => {
                    oscillator.stop();
                    audioContext.close();
                }, 200);
            } catch (e) {
                // Audio not supported or blocked
            }
        }

        // ============== END WEBSOCKET ==============

        // Update auth status and theme on page load
        document.addEventListener('DOMContentLoaded', async () => {
            initTheme();
            updateAuthStatus(!!API_AUTH.secretKey);

            // Pre-load favorites cache first, then update widget
            await getFavoritesFromCache();
            FAVORITES.updateWidget();

            // Connect to WebSocket for real-time notifications
            connectNotificationWebSocket();

            // Check for price changes on watched events every 2 minutes (fallback if WebSocket fails)
            checkForPriceChanges();
            setInterval(() => checkForPriceChanges(), 2 * 60 * 1000);
        });

        // ============== End Security Key Management ==============

        // Clear Redis cache (Settings page)
        async function clearCache() {
            if (!confirm('Tem certeza que deseja limpar o cache?\n\nIsto pode temporariamente afetar a performance.')) return;

            try {
                const response = await authFetch(`${API_BASE}/api/cache/clear`, { method: 'POST' });
                if (response.ok) {
                    showToast('Cache limpo', 'O cache foi limpo com sucesso', 'success');
                } else {
                    throw new Error('Erro ao limpar cache');
                }
            } catch (error) {
                console.error('Erro ao limpar cache:', error);
                showToast('Erro', 'N√£o foi poss√≠vel limpar o cache', 'error');
            }
        }

        // Run specific IDs from Scraping page
        function runSpecificIdsScraping() {
            const input = document.getElementById('specific-ids-input-scraping').value.trim();
            if (!input) {
                showToast('Erro', 'Introduza pelo menos um ID', 'error');
                return;
            }
            runIndependentScraperWithIds(input);
        }

        // Update notification bell icons based on database rules (uses FAVORITES cache)
        async function updateNotificationIcons() {
            try {
                // Use FAVORITES cache instead of fetching directly
                const favorites = await FAVORITES.getAll();

                // Get all event references that have active notification rules
                const activeReferences = new Set(favorites.map(r => r.event_reference));

                // Update all bell buttons on the page
                document.querySelectorAll('[id^="notify-event-"]').forEach(btn => {
                    const reference = btn.id.replace('notify-event-', '');
                    if (activeReferences.has(reference)) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });

                console.log(`üîî Updated ${activeReferences.size} notification icons`);
            } catch (error) {
                console.error('Error updating notification icons:', error);
            }
        }

        // Toggle event-specific notification (API-based with database persistence)
        async function toggleEventNotification(reference, titulo, tipoEvento) {
            const btn = document.getElementById(`notify-event-${reference}`);

            try {
                // Check FAVORITES cache first (uses 60s cache)
                const favorites = await FAVORITES.getAll();
                const existingRule = favorites.find(r => r.event_reference === reference);

                if (existingRule) {
                    // Rule EXISTS - DELETE it (toggle off)
                    const deleteResponse = await fetch(`${API_BASE}/api/notification-rules/${existingRule.id}`, { method: 'DELETE' });
                    if (deleteResponse.ok) {
                        FAVORITES._cacheTime = 0; // Invalidate cache
                        if (btn) btn.classList.remove('active');
                        showToast('Notifica√ß√£o desativada', `Deixar√° de ser notificado sobre: ${titulo.substring(0, 40)}...`, 'info');
                    }
                } else {
                    // Rule DOESN'T EXIST - CREATE it (toggle on)
                    const ruleData = {
                        name: `Evento: ${titulo.substring(0, 50)}`,
                        rule_type: 'price_change',
                        event_reference: reference,
                        active: true
                    };

                    const createResponse = await fetch(`${API_BASE}/api/notification-rules`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(ruleData)
                    });

                    if (createResponse.ok) {
                        FAVORITES._cacheTime = 0; // Invalidate cache
                        if (btn) btn.classList.add('active');
                        showToast('Notifica√ß√£o ativada', `Ser√° notificado sobre altera√ß√µes em: ${titulo.substring(0, 40)}...`, 'success');
                    } else {
                        const error = await createResponse.json();
                        console.error('Failed to create rule:', error);
                        showToast('Erro', 'N√£o foi poss√≠vel criar a notifica√ß√£o', 'error');
                    }
                }

                // Add animation
                if (btn) {
                    btn.classList.add('star-pop');
                    setTimeout(() => btn.classList.remove('star-pop'), 300);
                }
            } catch (error) {
                console.error('Erro ao toggle notifica√ß√£o:', error);
                showToast('Erro', 'N√£o foi poss√≠vel alterar a notifica√ß√£o', 'error');
            }
        }

        // Update notification button states based on API rules (alias for updateNotificationIcons)
        async function updateNotifyButtonStates() {
            await updateNotificationIcons();
        }

        // Update notification badge in sidebar
        let _rulesCountCache = { count: 0, timestamp: 0 };
        const RULES_COUNT_CACHE_TTL = 60000; // 1 minute cache for rules count

        function invalidateRulesCountCache() {
            _rulesCountCache.timestamp = 0;
        }

        async function updateNotificationBadge() {
            try {
                // Fetch unread count (this is fast, always do it)
                const countResponse = await fetch(`${API_BASE}/api/notifications/count`);
                const countData = await countResponse.json();

                // Update nav badge
                const badge = document.getElementById('nav-alerts-badge');
                if (badge) {
                    if (countData.unread > 0) {
                        badge.textContent = countData.unread > 99 ? '99+' : countData.unread;
                        badge.style.display = 'inline';
                    } else {
                        badge.style.display = 'none';
                    }
                }

                // Update dashboard widget unread count
                const dashUnreadEl = document.getElementById('dash-unread-count');
                if (dashUnreadEl) {
                    dashUnreadEl.textContent = countData.unread || 0;
                }

                // Only update rules count if dashboard is visible (use FAVORITES cache)
                const dashRulesEl = document.getElementById('dash-rules-count');
                if (dashRulesEl && dashRulesEl.offsetParent !== null) {
                    const rules = await FAVORITES.getAllRules();
                    dashRulesEl.textContent = rules.filter(r => r.active).length;
                }
            } catch (error) {
                console.error('Erro ao atualizar badge:', error);
            }
        }

        // Time ago helper
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'agora mesmo';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `h√° ${minutes} min`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `h√° ${hours}h`;
            const days = Math.floor(hours / 24);
            return `h√° ${days} dias`;
        }

        // Show create rule modal
        function showCreateRuleModal() {
            document.getElementById('create-rule-modal').style.display = 'flex';
        }

        function closeCreateRuleModal() {
            document.getElementById('create-rule-modal').style.display = 'none';

            // Clear form inputs
            document.getElementById('rule-name').value = '';
            document.getElementById('rule-distritos').value = '';
            document.getElementById('rule-preco-min').value = '';
            document.getElementById('rule-preco-max').value = '';

            // Reset radio buttons visual state
            document.querySelectorAll('.rule-type-option').forEach((el, i) => {
                el.style.borderColor = i === 0 ? '#3b82f6' : '#e5e7eb';
                el.style.background = i === 0 ? '#eff6ff' : 'white';
            });
            const firstRadio = document.querySelector('input[name="rule-type-radio"]');
            if (firstRadio) firstRadio.checked = true;

            // Reset tipo checkboxes visual state
            document.querySelectorAll('.rule-tipo').forEach(cb => {
                cb.checked = false;
                cb.parentElement.style.background = '#f8fafc';
                cb.parentElement.style.borderColor = 'transparent';
                cb.parentElement.style.color = '#64748b';
            });
        }

        // Create notification rule
        async function createNotificationRule() {
            const name = document.getElementById('rule-name').value.trim();
            // Get rule type from radio buttons
            const ruleTypeRadio = document.querySelector('input[name="rule-type-radio"]:checked');
            const ruleType = ruleTypeRadio ? ruleTypeRadio.value : 'new_event';

            if (!name) {
                showToast('Campo obrigat√≥rio', 'Por favor, insira um nome para a regra', 'warning');
                return;
            }

            const tiposRaw = Array.from(document.querySelectorAll('.rule-tipo:checked')).map(cb => parseInt(cb.value));
            const tipos = tiposRaw.filter(t => !isNaN(t) && t !== null);  // Filter out NaN and null
            const distritosStr = document.getElementById('rule-distritos').value.trim();
            const distritos = distritosStr ? distritosStr.split(',').map(d => d.trim()).filter(d => d) : null;
            const precoMin = document.getElementById('rule-preco-min').value;
            const precoMax = document.getElementById('rule-preco-max').value;

            const rule = {
                name,
                rule_type: ruleType,
                tipos: tipos.length > 0 ? tipos : null,  // Send null if empty array
                distritos: distritos,
                preco_min: precoMin ? parseFloat(precoMin) : null,
                preco_max: precoMax ? parseFloat(precoMax) : null,
                active: true
            };

            console.log('üìù Creating rule:', JSON.stringify(rule, null, 2));

            try {
                const response = await fetch(`${API_BASE}/api/notification-rules`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(rule)
                });

                if (response.ok) {
                    closeCreateRuleModal();
                    loadNotificationRules();
                    showToast('Regra criada', `"${name}" foi adicionada com sucesso`, 'success');
                } else {
                    const error = await response.json();
                    console.error('‚ùå Create rule error:', error);
                    alert('Erro: ' + JSON.stringify(error.detail || error));
                }
            } catch (error) {
                console.error('Erro ao criar regra:', error);
                alert('Erro ao criar regra');
            }
        }

        // Toggle rule active state
        async function toggleRule(ruleId, active) {
            try {
                const response = await fetch(`${API_BASE}/api/notification-rules/${ruleId}?active=${active}`, {
                    method: 'PUT'
                });

                if (response.ok) {
                    loadNotificationRules();
                }
            } catch (error) {
                console.error('Erro ao alternar regra:', error);
            }
        }

        // Delete rule
        async function deleteRule(ruleId) {
            if (!confirm('Tem certeza que deseja eliminar esta regra?')) return;

            try {
                const response = await fetch(`${API_BASE}/api/notification-rules/${ruleId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadNotificationRules();
                    addLog('Regra eliminada', 'info');
                }
            } catch (error) {
                console.error('Erro ao eliminar regra:', error);
            }
        }

        // Mark notification as read or unread
        async function markNotificationRead(notifId, read = true) {
            try {
                await fetch(`${API_BASE}/api/notifications/${notifId}/read?read=${read}`, { method: 'PUT' });
                loadNotifications();
                updateNotificationBadge();
            } catch (error) {
                console.error('Erro ao marcar notifica√ß√£o:', error);
            }
        }

        // Mark all notifications as read
        async function markAllNotificationsRead() {
            try {
                await authFetch(`${API_BASE}/api/notifications/read-all`, { method: 'POST' });
                loadNotifications();
                updateNotificationBadge();
                addLog('Todas as notifica√ß√µes marcadas como lidas', 'info');
            } catch (error) {
                console.error('Erro ao marcar notifica√ß√µes:', error);
            }
        }

        // ============ FAVORITOS FUNCTIONS ============

        // Cache for favorites
        const FAVORITES_CACHE = {
            data: [],
            cacheTime: 0,
            cacheDuration: 30000 // 30 seconds
        };

        // Load favorites page
        async function loadFavoritosPage() {
            const listEl = document.getElementById('favoritos-list');
            const emptyEl = document.getElementById('favoritos-empty');

            if (!listEl) return;

            listEl.innerHTML = '<div class="loading"><div class="loading-spinner"></div><div class="loading-text">A carregar favoritos...</div></div>';
            emptyEl.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE}/api/favorites`);
                const favorites = await response.json();

                FAVORITES_CACHE.data = favorites;
                FAVORITES_CACHE.cacheTime = Date.now();

                // Update stats
                updateFavoritosStats(favorites);

                // Update badge
                updateFavoritesBadge(favorites.length);

                if (favorites.length === 0) {
                    listEl.innerHTML = '';
                    emptyEl.style.display = 'block';
                    return;
                }

                // Apply filters and sort
                let filtered = [...favorites];
                const statusFilter = document.getElementById('fav-filter-status')?.value;
                const sortFilter = document.getElementById('fav-filter-sort')?.value || 'created_desc';

                const now = new Date();
                if (statusFilter === 'active') {
                    filtered = filtered.filter(f => f.event && f.event.data_fim && new Date(f.event.data_fim) > now && !f.event.terminado);
                } else if (statusFilter === 'ending') {
                    const todayEnd = new Date(now);
                    todayEnd.setHours(23, 59, 59, 999);
                    filtered = filtered.filter(f => f.event && f.event.data_fim && new Date(f.event.data_fim) <= todayEnd && new Date(f.event.data_fim) > now);
                } else if (statusFilter === 'ended') {
                    filtered = filtered.filter(f => !f.event || f.event.terminado || (f.event.data_fim && new Date(f.event.data_fim) <= now));
                }

                // Sort
                if (sortFilter === 'created_desc') {
                    filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                } else if (sortFilter === 'created_asc') {
                    filtered.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                } else if (sortFilter === 'ending_soon') {
                    filtered.sort((a, b) => {
                        const aEnd = a.event?.data_fim ? new Date(a.event.data_fim) : new Date('2999-12-31');
                        const bEnd = b.event?.data_fim ? new Date(b.event.data_fim) : new Date('2999-12-31');
                        return aEnd - bEnd;
                    });
                } else if (sortFilter === 'price_asc') {
                    filtered.sort((a, b) => (a.last_known_price || 0) - (b.last_known_price || 0));
                } else if (sortFilter === 'price_desc') {
                    filtered.sort((a, b) => (b.last_known_price || 0) - (a.last_known_price || 0));
                }

                // When showing all, separate ended events to the bottom
                if (!statusFilter || statusFilter === 'all') {
                    const active = filtered.filter(f => {
                        const endDate = f.event?.data_fim ? new Date(f.event.data_fim) : null;
                        return !f.event?.terminado && (!endDate || endDate > now);
                    });
                    const ended = filtered.filter(f => {
                        const endDate = f.event?.data_fim ? new Date(f.event.data_fim) : null;
                        return f.event?.terminado || (endDate && endDate <= now);
                    });

                    let html = active.map(fav => renderFavoriteCard(fav)).join('');
                    if (ended.length > 0) {
                        html += `
                            <div style="display: flex; align-items: center; gap: 12px; padding: 16px 0; margin: 8px 0;">
                                <div style="flex: 1; height: 1px; background: #e2e8f0;"></div>
                                <span style="font-size: 11px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;">Terminados (${ended.length})</span>
                                <div style="flex: 1; height: 1px; background: #e2e8f0;"></div>
                            </div>
                        `;
                        html += ended.map(fav => renderFavoriteCard(fav)).join('');
                    }
                    listEl.innerHTML = html;
                } else {
                    listEl.innerHTML = filtered.map(fav => renderFavoriteCard(fav)).join('');
                }
                emptyEl.style.display = 'none';

            } catch (error) {
                console.error('Erro ao carregar favoritos:', error);
                listEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Erro ao carregar favoritos</div>';
            }
        }

        // Render a single favorite card
        function renderFavoriteCard(fav) {
            const event = fav.event || {};
            const now = new Date();
            const endDate = event.data_fim ? new Date(event.data_fim) : null;
            const isEnded = event.terminado || (endDate && endDate <= now);
            const isEndingSoon = endDate && !isEnded && (endDate - now) < 24 * 60 * 60 * 1000;

            // Price change calculation
            const priceAdded = fav.price_when_added || 0;
            const priceCurrent = fav.last_known_price || event.lance_atual || 0;
            const priceChange = priceCurrent - priceAdded;
            const priceChangePercent = priceAdded > 0 ? ((priceChange / priceAdded) * 100) : 0;
            const hasChange = Math.abs(priceChange) > 0.01;

            // Status badge
            let statusBadge = '';
            if (isEnded) {
                statusBadge = '<span style="padding: 3px 8px; background: #f1f5f9; color: #64748b; border-radius: 6px; font-size: 10px; font-weight: 500;">Terminado</span>';
            } else if (isEndingSoon) {
                statusBadge = '<span style="padding: 3px 8px; background: #fef3c7; color: #92400e; border-radius: 6px; font-size: 10px; font-weight: 500;">A terminar</span>';
            } else {
                statusBadge = '<span style="padding: 3px 8px; background: #dcfce7; color: #166534; border-radius: 6px; font-size: 10px; font-weight: 500;">Ativo</span>';
            }

            // Time remaining
            let timeRemaining = '';
            if (endDate && !isEnded) {
                const diff = endDate - now;
                const days = Math.floor(diff / (24 * 60 * 60 * 1000));
                const hours = Math.floor((diff % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
                const mins = Math.floor((diff % (60 * 60 * 1000)) / (60 * 1000));
                if (days > 0) {
                    timeRemaining = `${days}d ${hours}h`;
                } else if (hours > 0) {
                    timeRemaining = `${hours}h ${mins}m`;
                } else {
                    timeRemaining = `${mins}m`;
                }
            }

            return `
                <div class="favorite-card" style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; display: flex; gap: 16px; transition: all 0.2s; cursor: pointer; ${isEnded ? 'opacity: 0.7;' : ''}" onclick="openInspectionModal('${fav.event_reference}')" onmouseover="this.style.borderColor='#3b82f6';this.style.boxShadow='0 4px 12px rgba(59,130,246,0.15)'" onmouseout="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                    <!-- Event Image -->
                    <div style="width: 100px; height: 80px; border-radius: 8px; overflow: hidden; flex-shrink: 0; background: #f1f5f9;">
                        ${event.capa ? `<img src="${event.capa}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML='<div style=\\'width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#94a3b8;font-size:10px;\\'>Sem imagem</div>'">` : '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#94a3b8;font-size:10px;">Sem imagem</div>'}
                    </div>

                    <!-- Event Info -->
                    <div style="flex: 1; min-width: 0;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                ${statusBadge}
                                <span style="font-size: 10px; color: #94a3b8;">${fav.event_reference}</span>
                            </div>
                            <button onclick="event.stopPropagation(); removeFavorite('${fav.event_reference}')" style="padding: 4px 8px; background: none; border: none; cursor: pointer; color: #94a3b8; transition: color 0.2s;" onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='#94a3b8'" title="Remover">
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="16" height="16">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>

                        <h4 style="font-size: 13px; font-weight: 600; color: #1e293b; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${event.titulo || 'Sem t√≠tulo'}">
                            ${event.titulo || fav.event_titulo || 'Evento n√£o encontrado'}
                        </h4>

                        <div style="display: flex; gap: 12px; font-size: 11px; color: #64748b; margin-bottom: 8px;">
                            <span>${event.tipo || fav.event_tipo || '‚Äî'}</span>
                            <span>¬∑</span>
                            <span>${event.distrito || fav.event_distrito || '‚Äî'}</span>
                            ${timeRemaining ? `<span>¬∑</span><span style="color: ${isEndingSoon ? '#f59e0b' : '#64748b'};">${timeRemaining}</span>` : ''}
                        </div>

                        <!-- Price Section -->
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div>
                                <div style="font-size: 16px; font-weight: 700; color: #1e293b;">‚Ç¨${priceCurrent.toLocaleString('pt-PT', {minimumFractionDigits: 2})}</div>
                                ${hasChange ? `
                                    <div style="font-size: 10px; color: ${priceChange > 0 ? '#ef4444' : '#22c55e'};">
                                        ${priceChange > 0 ? '+' : ''}‚Ç¨${priceChange.toLocaleString('pt-PT', {minimumFractionDigits: 2})} (${priceChangePercent > 0 ? '+' : ''}${priceChangePercent.toFixed(1)}%)
                                    </div>
                                ` : '<div style="font-size: 10px; color: #94a3b8;">Sem altera√ß√£o</div>'}
                            </div>

                            <!-- Notification Settings -->
                            <div style="margin-left: auto; display: flex; gap: 4px;" onclick="event.stopPropagation()">
                                <button onclick="toggleFavoriteNotify('${fav.event_reference}', 'price', ${!fav.notify_price_change})"
                                    style="padding: 4px 8px; background: ${fav.notify_price_change ? '#dbeafe' : '#f1f5f9'}; border: none; border-radius: 6px; font-size: 10px; color: ${fav.notify_price_change ? '#1d4ed8' : '#64748b'}; cursor: pointer;"
                                    title="Alertar altera√ß√µes de pre√ßo">
                                    ‚Ç¨
                                </button>
                                <button onclick="toggleFavoriteNotify('${fav.event_reference}', 'ending', ${!fav.notify_ending_soon})"
                                    style="padding: 4px 8px; background: ${fav.notify_ending_soon ? '#fef3c7' : '#f1f5f9'}; border: none; border-radius: 6px; font-size: 10px; color: ${fav.notify_ending_soon ? '#92400e' : '#64748b'}; cursor: pointer;"
                                    title="Alertar quando terminar">
                                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="12" height="12">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </button>
                                <button onclick="showPriceChart('${fav.event_reference}')"
                                    style="padding: 4px 8px; background: #f1f5f9; border: none; border-radius: 6px; font-size: 10px; color: #64748b; cursor: pointer;"
                                    title="Ver evolu√ß√£o do pre√ßo">
                                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="12" height="12">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Update favorites stats
        function updateFavoritosStats(favorites) {
            const now = new Date();
            const todayEnd = new Date(now);
            todayEnd.setHours(23, 59, 59, 999);

            let active = 0, ending = 0, totalChanges = 0;

            favorites.forEach(fav => {
                const event = fav.event || {};
                const endDate = event.data_fim ? new Date(event.data_fim) : null;
                const isEnded = event.terminado || (endDate && endDate <= now);

                if (!isEnded) active++;
                if (endDate && endDate <= todayEnd && endDate > now) ending++;
                totalChanges += fav.price_changes_count || 0;
            });

            document.getElementById('fav-stat-total').textContent = favorites.length;
            document.getElementById('fav-stat-active').textContent = active;
            document.getElementById('fav-stat-ending').textContent = ending;
            document.getElementById('fav-stat-changes').textContent = totalChanges;
            document.getElementById('favoritos-total-count').textContent = favorites.length;
        }

        // Update favorites badge in sidebar
        function updateFavoritesBadge(count) {
            const badge = document.getElementById('nav-favorites-badge');
            if (badge) {
                badge.textContent = count;
                badge.style.display = count > 0 ? 'inline' : 'none';
            }
        }

        // Add event to favorites
        async function addToFavorites(reference, eventData = {}) {
            try {
                const response = await authFetch(`${API_BASE}/api/favorites`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        event_reference: reference,
                        event_titulo: eventData.titulo,
                        event_tipo: eventData.tipo,
                        event_subtipo: eventData.subtipo,
                        event_distrito: eventData.distrito,
                        event_data_fim: eventData.data_fim,
                        price_when_added: eventData.lance_atual || eventData.valor_base
                    })
                });

                if (response.ok) {
                    addLog(`Evento ${reference} adicionado aos favoritos`, 'success');
                    // Update FAVORITES cache for sync checks
                    if (!FAVORITES._cache.some(r => r.event_reference === reference)) {
                        FAVORITES._cache.push({ event_reference: reference, active: true });
                    }
                    // Update favoritesCache (don't invalidate - keep optimistic update)
                    if (favoritesCache && !favoritesCache.some(f => f.event_reference === reference)) {
                        favoritesCache.push({ event_reference: reference });
                    }
                    // Update badge
                    const countResp = await fetch(`${API_BASE}/api/favorites/count`);
                    const countData = await countResp.json();
                    updateFavoritesBadge(countData.count);
                    return true;
                }
            } catch (error) {
                console.error('Erro ao adicionar favorito:', error);
                addLog('Erro ao adicionar aos favoritos', 'error');
            }
            return false;
        }

        // Remove from favorites
        async function removeFavorite(reference) {
            if (!confirm('Remover este evento dos favoritos?')) return;

            try {
                const response = await authFetch(`${API_BASE}/api/favorites/${reference}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    addLog(`Evento ${reference} removido dos favoritos`, 'info');
                    // Update caches
                    FAVORITES._cache = FAVORITES._cache.filter(r => r.event_reference !== reference);
                    if (favoritesCache) {
                        favoritesCache = favoritesCache.filter(f => f.event_reference !== reference);
                    }
                    loadFavoritosPage();
                    updateEndingSoonFavoriteButtons();
                }
            } catch (error) {
                console.error('Erro ao remover favorito:', error);
            }
        }

        // Toggle favorite notification setting
        async function toggleFavoriteNotify(reference, type, value) {
            try {
                const body = {};
                if (type === 'price') body.notify_price_change = value;
                if (type === 'ending') body.notify_ending_soon = value;

                await authFetch(`${API_BASE}/api/favorites/${reference}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                loadFavoritosPage();
            } catch (error) {
                console.error('Erro ao atualizar prefer√™ncias:', error);
            }
        }

        // Check if event is favorited
        async function isFavorited(reference) {
            try {
                const response = await fetch(`${API_BASE}/api/favorites/${reference}`);
                const data = await response.json();
                return data.is_favorite;
            } catch (error) {
                return false;
            }
        }

        // Toggle favorite (for star button)
        async function toggleFavorite(reference, eventData = {}) {
            const isFav = await isFavorited(reference);
            if (isFav) {
                await removeFavoriteQuiet(reference);
            } else {
                await addToFavorites(reference, eventData);
            }
            // Update UI
            updateFavoriteStars();
            updateEndingSoonFavoriteButtons();
        }

        // Remove without confirm (for toggle)
        async function removeFavoriteQuiet(reference) {
            try {
                await authFetch(`${API_BASE}/api/favorites/${reference}`, { method: 'DELETE' });
                addLog(`Evento ${reference} removido dos favoritos`, 'info');
                // Update FAVORITES cache for sync checks
                FAVORITES._cache = FAVORITES._cache.filter(r => r.event_reference !== reference);
                // Update favoritesCache (don't invalidate - keep optimistic update)
                if (favoritesCache) {
                    favoritesCache = favoritesCache.filter(f => f.event_reference !== reference);
                }
                const countResp = await fetch(`${API_BASE}/api/favorites/count`);
                const countData = await countResp.json();
                updateFavoritesBadge(countData.count);
            } catch (error) {
                console.error('Erro ao remover favorito:', error);
            }
        }

        // Update favorite star icons across the UI
        async function updateFavoriteStars() {
            try {
                const favorites = await getFavoritesFromCache();
                const favReferences = new Set(favorites.map(f => f.event_reference));
                console.log('[updateFavoriteStars] Favorites:', favorites.length, 'refs:', [...favReferences]);

                // Update all star buttons
                const buttons = document.querySelectorAll('.card-favorite-btn');
                console.log('[updateFavoriteStars] Found buttons:', buttons.length);
                buttons.forEach(btn => {
                    const ref = btn.id.replace('fav-event-', '');
                    const isFav = favReferences.has(ref);
                    const svg = btn.querySelector('.star-icon');
                    if (isFav) {
                        console.log('[updateFavoriteStars] Setting favorite:', ref);
                        btn.classList.add('is-favorite');
                        svg.setAttribute('fill', '#f59e0b');
                        svg.setAttribute('stroke', '#f59e0b');
                        btn.title = 'Remover dos favoritos';
                    } else {
                        btn.classList.remove('is-favorite');
                        svg.setAttribute('fill', 'none');
                        svg.setAttribute('stroke', 'currentColor');
                        btn.title = 'Adicionar aos favoritos';
                    }
                });
            } catch (error) {
                console.error('Error updating stars:', error);
            }
        }

        // Toggle favorite from event card star button
        async function toggleFavoriteFromCard(reference, btn) {
            const svg = btn.querySelector('.star-icon');
            const isFav = btn.classList.contains('is-favorite');

            // Optimistic UI update + cache update
            if (isFav) {
                btn.classList.remove('is-favorite');
                svg.setAttribute('fill', 'none');
                svg.setAttribute('stroke', 'currentColor');
                btn.title = 'Adicionar aos favoritos';
                updateFavoritesCacheEntry(reference, false);
            } else {
                btn.classList.add('is-favorite');
                svg.setAttribute('fill', '#f59e0b');
                svg.setAttribute('stroke', '#f59e0b');
                btn.title = 'Remover dos favoritos';
                updateFavoritesCacheEntry(reference, true);
            }

            try {
                if (isFav) {
                    await removeFavoriteQuiet(reference);
                } else {
                    // Get event data from data attribute
                    let eventData = {};
                    try {
                        const dataAttr = btn.getAttribute('data-event');
                        if (dataAttr) {
                            eventData = JSON.parse(dataAttr.replace(/&apos;/g, "'"));
                        }
                    } catch (e) {}
                    await addToFavorites(reference, eventData);
                }
            } catch (error) {
                // Revert on error (including cache)
                if (isFav) {
                    btn.classList.add('is-favorite');
                    svg.setAttribute('fill', '#f59e0b');
                    svg.setAttribute('stroke', '#f59e0b');
                    updateFavoritesCacheEntry(reference, true);
                } else {
                    btn.classList.remove('is-favorite');
                    svg.setAttribute('fill', 'none');
                    svg.setAttribute('stroke', 'currentColor');
                    updateFavoritesCacheEntry(reference, false);
                }
            }
        }

        // Check prices for all favorites
        async function checkFavoritesPrices() {
            const btn = event?.target?.closest('button');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<div class="loading-spinner" style="width: 14px; height: 14px;"></div> A verificar...';
            }

            try {
                const response = await authFetch(`${API_BASE}/api/favorites/check-prices`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.updated > 0) {
                    addLog(`${data.updated} favoritos atualizados`, 'success');
                } else {
                    addLog('Todos os pre√ßos est√£o atualizados', 'info');
                }

                loadFavoritosPage();
            } catch (error) {
                console.error('Erro ao verificar pre√ßos:', error);
                addLog('Erro ao verificar pre√ßos', 'error');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = `<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="14" height="14">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg> Atualizar Pre√ßos`;
                }
            }
        }

        // Initial favorites badge load
        (async function() {
            try {
                const response = await fetch(`${API_BASE}/api/favorites/count`);
                const data = await response.json();
                updateFavoritesBadge(data.count);
            } catch (e) {}
        })();

        // Load alertas/favoritos when page changes
        const originalShowPage = showPage;
        showPage = function(pageId) {
            originalShowPage(pageId);
            if (pageId === 'alertas') {
                loadAlertasPage();
            } else if (pageId === 'favoritos') {
                loadFavoritosPage();
            }
        };

        // Update badge periodically
        setInterval(updateNotificationBadge, 60000); // Every minute

        // Initial badge update
        updateNotificationBadge();

        // ============== LIVE PRICE UPDATES (SSE) ==============
        // NOTE: SSE is disabled on public API - real-time updates not available
        // The public dashboard uses polling instead (auto-refresh every few seconds)

        let sseConnection = null;

        function connectToLiveUpdates() {
            // SSE disabled on public API - use polling instead
            console.log('‚ÑπÔ∏è SSE: Live updates disabled on public API (using polling)');
            return;
        }

        // SSE disabled - polling is used instead
        // connectToLiveUpdates();

        // ============== NOTIFICATION MUTE SYSTEM ==============

        let notificationsMuted = localStorage.getItem('notificationsMuted') === 'true';

        function toggleNotificationsMute() {
            notificationsMuted = !notificationsMuted;
            localStorage.setItem('notificationsMuted', notificationsMuted);
            updateMuteUI();
        }

        function updateMuteUI() {
            const btn = document.getElementById('mute-notifications-btn');
            const icon = document.getElementById('mute-icon');
            if (btn && icon) {
                if (notificationsMuted) {
                    btn.classList.add('muted');
                    icon.textContent = 'üîá';
                    btn.title = 'Ativar notifica√ß√µes';
                } else {
                    btn.classList.remove('muted');
                    icon.textContent = 'üîä';
                    btn.title = 'Silenciar notifica√ß√µes';
                }
            }
        }

        // Initialize mute UI on load
        document.addEventListener('DOMContentLoaded', updateMuteUI);

        // ============== TOAST NOTIFICATION SYSTEM ==============

        function showToast(title, message, type = 'info') {
            // Skip notification toasts if muted (allow errors/warnings)
            if (notificationsMuted && type === 'info') {
                return;
            }

            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: 'üîî'
            };

            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;

            container.appendChild(toast);

            // Auto remove after 4 seconds (shorter for compact toasts)
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // ============== QUICK NOTIFICATION TOGGLE ==============

        const tipoNames = {
            imoveis: 'Im√≥veis',
            veiculos: 'Ve√≠culos',
            direitos: 'Direitos',
            equipamentos: 'Equipamentos',
            mobiliario: 'Mobili√°rio',
            maquinas: 'M√°quinas'
        };

        // Track quick notification rule (single rule with tipos array)
        let quickNotificationRule = null;

        async function loadQuickNotificationStates() {
            try {
                // Use FAVORITES cache to avoid duplicate requests
                const rules = await FAVORITES.getAllRules();
                console.log('Loaded notification rules:', rules);

                // Find the single "Quick Notifications" rule
                quickNotificationRule = rules.find(r => r.name === 'Quick Notifications') || null;
                console.log('Quick notification rule:', quickNotificationRule);

                // Update all button states
                Object.keys(tipoNames).forEach(tipo => {
                    updateNotifyButtonState(tipo);
                });
            } catch (error) {
                console.error('Error loading quick notification states:', error);
            }
        }

        function updateNotifyButtonState(tipo) {
            const btn = document.getElementById(`notify-btn-${tipo}`);
            if (!btn) return;

            const isActive = quickNotificationRule &&
                             quickNotificationRule.active &&
                             quickNotificationRule.tipos &&
                             quickNotificationRule.tipos.includes(tipo);

            if (isActive) {
                btn.classList.add('active');
                btn.querySelector('span').textContent = 'Notifica√ß√µes ON';
            } else {
                btn.classList.remove('active');
                btn.querySelector('span').textContent = 'Notificar';
            }
        }

        async function toggleQuickNotification(tipo, tipoId) {
            const btn = document.getElementById(`notify-btn-${tipo}`);
            console.log('Toggle quick notification:', tipo, 'Current rule:', quickNotificationRule);

            try {
                if (quickNotificationRule) {
                    // Rule exists - update tipos array
                    let tipos = quickNotificationRule.tipos || [];
                    const isCurrentlyActive = tipos.includes(tipo);

                    if (isCurrentlyActive) {
                        // Remove tipo from array
                        tipos = tipos.filter(t => t !== tipo);

                        if (tipos.length === 0) {
                            // No more tipos - delete the rule
                            await fetch(`${API_BASE}/api/notification-rules/${quickNotificationRule.id}`, {
                                method: 'DELETE'
                            });
                            quickNotificationRule = null;
                        } else {
                            // Update rule with new tipos
                            await fetch(`${API_BASE}/api/notification-rules/${quickNotificationRule.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ tipos: tipos })
                            });
                            quickNotificationRule.tipos = tipos;
                        }
                        showToast('Notifica√ß√µes desativadas', `J√° n√£o receber√° notifica√ß√µes de ${tipoNames[tipo].toLowerCase()}`, 'info');
                    } else {
                        // Add tipo to array
                        tipos.push(tipo);
                        await fetch(`${API_BASE}/api/notification-rules/${quickNotificationRule.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ tipos: tipos })
                        });
                        quickNotificationRule.tipos = tipos;
                        showToast('Notifica√ß√µes ativadas', `Ser√° notificado de novos ${tipoNames[tipo].toLowerCase()}`, 'success');
                    }
                } else {
                    // Create new rule with this tipo
                    console.log('Creating new Quick Notifications rule for:', tipo);
                    const response = await fetch(`${API_BASE}/api/notification-rules`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: 'Quick Notifications',
                            rule_type: 'new_event',
                            tipos: [tipo],
                            active: true
                        })
                    });

                    console.log('Create rule response status:', response.status);
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Rule created:', data);
                        quickNotificationRule = { id: data.id, active: true, tipos: [tipo], name: 'Quick Notifications' };
                        showToast('Notifica√ß√µes ativadas', `Ser√° notificado de novos ${tipoNames[tipo].toLowerCase()}`, 'success');
                    } else {
                        const errorText = await response.text();
                        console.error('Failed to create rule:', response.status, errorText);
                        showToast('Erro', 'N√£o foi poss√≠vel criar a regra de notifica√ß√£o', 'error');
                    }
                }

                updateNotifyButtonState(tipo);
            } catch (error) {
                console.error('Error toggling quick notification:', error);
                showToast('Erro', 'N√£o foi poss√≠vel alterar as notifica√ß√µes', 'error');
            }
        }

        // ============== DYNAMIC SUBTYPES LOADING ==============

        const tipoIdMap = {
            imoveis: 1,
            veiculos: 2,
            equipamentos: 3,
            mobiliario: 4,
            maquinas: 5,
            direitos: 6
        };

        async function loadSubtypesForPage(tipo) {
            const tipoId = tipoIdMap[tipo];
            if (!tipoId) return;

            const select = document.getElementById(`subtipo-${tipo}`);
            if (!select) return;

            try {
                const response = await fetch(`${API_BASE}/api/filters/subtypes/${tipoId}`);
                const subtypes = await response.json();

                const currentValue = select.value;
                select.innerHTML = '<option value="">Todos os subtipos</option>';

                subtypes.forEach(subtype => {
                    const option = document.createElement('option');
                    option.value = subtype;
                    option.textContent = subtype;
                    select.appendChild(option);
                });

                if (currentValue) select.value = currentValue;
            } catch (error) {
                console.error(`Error loading subtypes for ${tipo}:`, error);
            }
        }

        // Load subtypes when showing a page
        const originalShowPage2 = showPage;
        showPage = function(pageId) {
            originalShowPage2(pageId);

            // Load subtypes for event pages
            if (tipoIdMap[pageId]) {
                loadSubtypesForPage(pageId);
            }
        };

        // Initial load of quick notification states
        loadQuickNotificationStates();

        // ============== END ALERTAS/NOTIFICATIONS SYSTEM ==============
    </script>

    <!-- Generic Alert Modal -->
    <div id="generic-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 16px; padding: 32px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); position: relative;">
            <div style="text-align: center; margin-bottom: 24px;">
                <div style="font-size: 64px; margin-bottom: 16px;" id="modal-icon">‚ÑπÔ∏è</div>
                <h2 style="color: #1e293b; margin: 0 0 8px 0; font-size: 24px;" id="modal-title">Aviso</h2>
            </div>
            <div style="background: #f8fafc; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                <p style="color: #475569; font-size: 14px; line-height: 1.6; margin: 0;" id="modal-message">Mensagem</p>
            </div>
            <button onclick="closeModal()" style="width: 100%; padding: 14px; background: #3b82f6; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; color: white; transition: all 0.2s;">
                OK
            </button>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o de Limpeza de BD -->
    <div id="delete-confirm-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 16px; padding: 32px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); position: relative;">
            <!-- Header -->
            <div style="text-align: center; margin-bottom: 24px;">
                <div style="font-size: 64px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                <h2 style="color: #dc2626; margin: 0 0 8px 0; font-size: 24px;">Limpar Base de Dados</h2>
                <p style="color: #64748b; font-size: 14px; margin: 0;">Esta a√ß√£o √© irrevers√≠vel!</p>
            </div>

            <!-- Warning Message -->
            <div style="background: #fef2f2; border: 2px solid #fecaca; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                <p style="color: #991b1b; font-size: 14px; line-height: 1.6; margin: 0;">
                    <strong>Todos os eventos ser√£o apagados permanentemente!</strong><br>
                    Esta opera√ß√£o n√£o pode ser revertida.
                </p>
            </div>

            <!-- Timer Display -->
            <div style="text-align: center; margin-bottom: 24px;">
                <div style="font-size: 48px; font-weight: 700; color: #3b82f6;" id="delete-timer">3</div>
                <div style="font-size: 12px; color: #64748b; margin-top: 8px;">segundos restantes</div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 12px;">
                <button onclick="cancelDeleteDatabase()" style="flex: 1; padding: 14px; background: #f1f5f9; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; color: #475569;">
                    ‚úó Cancelar
                </button>
                <button id="confirm-delete-btn" onclick="executeDeleteDatabase()" disabled style="flex: 1; padding: 14px; background: #cbd5e1; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: not-allowed; transition: all 0.2s; color: #94a3b8;">
                    ‚úì Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Inspection Modal -->
    <div class="inspection-modal" id="inspection-modal">
        <button class="inspection-close" onclick="closeInspectionModal()">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
            </svg>
        </button>
        <div class="inspection-content">
            <!-- Loading Overlay -->
            <div class="modal-loading-overlay" id="modal-loading-overlay">
                <div class="modal-loading-spinner"></div>
                <div class="modal-loading-text" id="modal-loading-text">A processar...</div>
                <div class="modal-loading-subtext" id="modal-loading-subtext">Aguarde enquanto atualizamos os dados</div>
            </div>
            <div class="inspection-carousel" id="inspection-carousel">
                <div class="inspection-carousel-counter" id="inspection-counter">1 / 1</div>
                <div class="inspection-carousel-images" id="inspection-images"></div>
                <button class="inspection-carousel-nav prev" onclick="inspectionCarouselPrev()">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>
                <button class="inspection-carousel-nav next" onclick="inspectionCarouselNext()">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
                    </svg>
                </button>
                <div class="inspection-carousel-indicators" id="inspection-indicators"></div>
            </div>
            <div class="inspection-details" id="inspection-details">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>

</body>
</html>
